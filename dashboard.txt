<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Attendance Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Poppins',sans-serif;background:#f8fafc;display:flex;min-height:100vh;font-size:14px;}

/* Sidebar */
.sidebar{width:220px;background:#1e293b;color:#fff;padding:16px;position:fixed;height:100vh;transition:width 0.3s;overflow:hidden;z-index:1000;}
.sidebar.collapsed{width:60px}
.sidebar h2{font-size:18px;margin-bottom:16px;transition:opacity 0.3s,visibility 0.3s}
.sidebar.collapsed h2{opacity:0;visibility:hidden;display:none}
.sidebar a{display:flex;align-items:center;color:#cbd5e1;padding:10px;border-radius:6px;text-decoration:none;margin-bottom:6px;transition:0.3s;position:relative;font-size:14px;}
.sidebar a i{margin-right:10px;min-width:18px;text-align:center;font-style:normal}
.sidebar a.active,.sidebar a:hover{background:#3b82f6;color:#fff}
.sidebar a span{transition:opacity 0.3s,visibility 0.3s}
.sidebar.collapsed a span{opacity:0;visibility:hidden;display:none}
.sidebar .toggle-btn{display:block;margin-top:16px;text-align:center;cursor:pointer;color:#fff;transition: transform 0.3s}

/* Tooltip for collapsed sidebar */
.sidebar.collapsed a:hover::after{
  content: attr(data-tooltip);
  position:absolute;left:70px;top:50%;transform:translateY(-50%);
  background:#334155;color:#fff;padding:4px 8px;border-radius:4px;white-space:nowrap;z-index:100;opacity:0;animation: fadeIn 0.25s forwards;font-size:12px;
}
@keyframes fadeIn{to{opacity:1}}
.sidebar:not(.collapsed) a:hover::after{display:none}

/* Main */
.main{margin-left:220px;padding:20px;flex:1;transition:margin-left 0.3s}
.sidebar.collapsed + .main{margin-left:60px}

/* Cards */
.card{background:#fff;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;}

/* Professional Table Styles */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 13px;
  background: white;
  border: 1px solid #e2e8f0;
}

.data-table th {
  background: #f8fafc;
  color: #475569;
  padding: 12px 10px;
  font-weight: 600;
  text-align: center;
  border: 1px solid #e2e8f0;
  font-size: 13px;
}

.data-table td {
  padding: 10px;
  text-align: center;
  border: 1px solid #e2e8f0;
  font-size: 13px;
}

.data-table tr:hover {
  background: #f8fafc;
}

/* Status colors */
.status-present { 
  background: #10b981; 
  color: white; 
  border-radius: 4px;
  padding: 6px 8px;
  font-weight: 500;
  display: inline-block;
  min-width: 24px;
  font-size: 13px;
}

.status-late { 
  background: #f59e0b; 
  color: white; 
  border-radius: 4px;
  padding: 6px 8px;
  font-weight: 500;
  display: inline-block;
  min-width: 24px;
  font-size: 13px;
}

.status-absent { 
  background: #ef4444; 
  color: white; 
  border-radius: 4px;
  padding: 6px 8px;
  font-weight: 500;
  display: inline-block;
  min-width: 24px;
  font-size: 13px;
}

.status-holiday { 
  background: #6b7280; 
  color: white; 
  border-radius: 4px;
  padding: 6px 8px;
  font-weight: 500;
  display: inline-block;
  min-width: 24px;
  font-size: 13px;
}

/* Summary Cards */
.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.summary-card {
  padding: 16px;
  border-radius: 8px;
  text-align: center;
  color: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.summary-card .number {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 6px;
}

.summary-card .label {
  font-size: 14px;
  opacity: 0.9;
}

/* small helpers */
.small{font-size:13px;color:#64748b}

/* Buttons */
button{
  background:#3b82f6;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  transition:0.15s;
  font-size:13px;
  margin: 4px;
}
button:hover{background:#2563eb}

/* Inputs */
input[type=text],input[type=date],select{
  width:100%;
  padding:10px;
  border:1px solid #d1d5db;
  border-radius:6px;
  margin-top:8px;
  font-size:14px;
}

/* snackbar */
#snackbar{
  visibility:hidden;
  min-width:250px;
  background:#334155;
  color:#fff;
  text-align:center;
  border-radius:6px;
  padding:12px;
  position:fixed;
  z-index:999;
  left:50%;
  bottom:24px;
  transform:translateX(-50%);
  font-size:13px;
  transition:0.5s
}
#snackbar.show{visibility:visible;opacity:1}

/* spinner */
#spinner{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:4px solid #f3f3f3;border-top:4px solid #3b82f6;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;z-index:1000}
@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}

/* calendar grid */
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-cell{background:#fff;border-radius:6px;padding:8px;min-height:60px;display:flex;flex-direction:column;justify-content:flex-start;cursor:pointer;border:1px solid #e2e8f0;user-select:none;font-size:13px;}
.cal-cell .date{font-weight:600;margin-bottom:4px;font-size:13px;}
.cal-cell.work{background:linear-gradient(90deg, rgba(59,130,246,0.06), #fff)}
.cal-cell.holiday{background:linear-gradient(90deg, rgba(239,68,68,0.04), #fff)}
.cal-cell.today{box-shadow:0 0 0 2px rgba(59,130,246,0.12)}
.cal-cell.selected{outline:2px solid rgba(59,130,246,0.16)}
.cal-legend{display:flex;gap:8px;align-items:center;margin-top:8px;font-size:13px;}
.legend-item{display:flex;align-items:center;gap:6px;}
.legend-swatch{width:12px;height:12px;border-radius:3px}
.legend-work{background:#3b82f6}
.legend-holiday{background:#ef4444}


/* Mini table for summary */
.mini-table{width:100%;border-collapse:collapse;margin-top:10px;border:1px solid #e2e8f0;font-size:13px;}
.mini-table th,.mini-table td{padding:8px 10px;text-align:left;border:1px solid #e2e8f0;}
.mini-table th{font-weight:600;color:#475569;width:40%;background:#f8fafc;}
.mini-table td{color:#334155;}
/* Calendar Container with Headers */
.calendar-container {
  margin-top: 16px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 16px;
  background: white;
}

.calendar-headers {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-bottom: 8px;
}

.cal-header {
  text-align: center;
  font-weight: 600;
  font-size: 12px;
  color: #475569;
  padding: 10px 4px;
  background: #f8fafc;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Calendar Grid */
.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.cal-cell {
  background: #fff;
  border-radius: 6px;
  padding: 8px 4px;
  min-height: 70px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  border: 1px solid #e2e8f0;
  user-select: none;
  font-size: 13px;
  transition: all 0.2s ease;
  position: relative;
}

/* Rest of your existing cal-cell styles... */
.workday-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}

.workday-selector-group {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.selector-container {
  display: flex;
  align-items: center;
  gap: 6px;
}

.selector-label {
  font-size: 13px;
  font-weight: 500;
  color: #475569;
  white-space: nowrap;
}

.year-selector, .month-selector {
  padding: 6px 8px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 13px;
  background: white;
  min-width: 100px;
}

.year-selector {
  min-width: 80px;
}

.month-selector {
  min-width: 120px;
}

.workday-action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.workday-action-buttons button {
  padding: 6px 12px;
  font-size: 13px;
  min-height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Calendar cell improvements */
.cal-cell {
  background: #fff;
  border-radius: 6px;
  padding: 8px 4px;
  min-height: 70px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  border: 1px solid #e2e8f0;
  user-select: none;
  font-size: 13px;
  transition: all 0.2s ease;
  position: relative;
}

.cal-cell:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.cal-cell .date {
  font-weight: 600;
  margin-bottom: 4px;
  font-size: 13px;
}

.cal-cell .status-label {
  font-size: 10px;
  font-weight: 500;
  padding: 2px 4px;
  border-radius: 3px;
  background: rgba(0,0,0,0.05);
  text-align: center;
  width: 100%;
}

.cal-cell.work .status-label {
  background: rgba(59, 130, 246, 0.1);
  color: #1e40af;
}

.cal-cell.holiday .status-label {
  background: rgba(239, 68, 68, 0.1);
  color: #dc2626;
}

.cal-cell.modified {
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
  70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
  100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}

/* Remove old navigation buttons */
.workday-nav-buttons {
  display: none !important;
}
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 10px;
  border-bottom: 1px solid #e2e8f0;
  min-height: 40px;
}

.section-header h3 {
  margin: 0;
  color: #1e293b;
  font-size: 18px;
  font-weight: 600;
}

.action-buttons {
  display: flex;
  gap: 8px;
  align-items: center;
}

.action-buttons button {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  font-size: 13px;
}

.action-buttons button .icon {
  font-size: 14px;
}

.action-buttons button .text {
  font-size: 13px;
}

/* Chart size adjustments */
#weeklyChart {
  height: 220px !important;
}

#monthlyChart {
  height: 250px !important;
}

/* Adjust chart container spacing */
.card canvas {
  margin-top: 10px;
}

/* Scroll optimization */
.scroll-container {
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  margin-top: 10px;
}

.scroll-container table {
  margin-top: 0;
}

/* Register plate improvements */
.vehicle-list {
  margin-top: 15px;
  border-top: 1px solid #e2e8f0;
  padding-top: 15px;
}

.vehicle-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  background: #f8fafc;
  border-radius: 6px;
  margin-bottom: 8px;
}

.vehicle-actions {
  display: flex;
  gap: 8px;
}

/* Search and filter */
.search-box {
  margin-bottom: 15px;
  display: flex;
  gap: 10px;
}

.search-box input {
  flex: 1;
}

/* Pagination */
.pagination {
  display: flex;
  justify-content: center;
  margin-top: 15px;
  gap: 8px;
}

.pagination button {
  padding: 6px 12px;
  background: #f1f5f9;
  color: #475569;
  border: 1px solid #e2e8f0;
}

.pagination button.active {
  background: #3b82f6;
  color: white;
}

/* Enhanced pagination controls */
.pagination-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  padding: 10px 0;
}

.pagination-info {
  font-size: 13px;
  color: #64748b;
}

.pagination-buttons {
  display: flex;
  gap: 8px;
}

.pagination-buttons button {
  padding: 6px 12px;
  background: #f1f5f9;
  color: #475569;
  border: 1px solid #e2e8f0;
  font-size: 12px;
}

.pagination-buttons button:hover:not(:disabled) {
  background: #3b82f6;
  color: white;
}

.pagination-buttons button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Mobile Menu Button */
.mobile-menu-btn {
  display: none;
  position: fixed;
  top: 10px;
  left: 10px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  z-index: 1001;
  font-size: 16px;
}

/* Mobile Overlay */
.mobile-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
}


/* Daily Status Date Info */
.daily-date-info {
  margin-bottom: 12px;
  padding: 8px 12px;
  background: #f0f9ff;
  border-radius: 6px;
  border: 1px solid #bae6fd;
  font-size: 14px;
  color: #0369a1;
}

/* User-specific styles */
.user-only {
  display: none;
}

.admin-only {
  display: none;
}

/* Add vehicle form improvements */
.add-vehicle-form {
  background: #f8fafc;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  border: 1px solid #e2e8f0;
}

.form-row {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.form-group {
  flex: 1;
  min-width: 200px;
}

.form-group label {
  display: block;
  margin-bottom: 4px;
  font-weight: 500;
  color: #475569;
  font-size: 14px;
}

/* PERBAIKI Settings Section */
#user-settings {
  position: relative;
  width: 100%;
  display: none;
  background: white;
  padding: 20px;
  margin: 0;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid #e2e8f0;
}

/* Pastikan main container layout benar */
.main {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.main > .section {
  order: 0;
  flex: none;
}

/* Auto-capitalize input */
.auto-capitalize {
  text-transform: capitalize;
}

/* User Management Styles */
.user-status-active {
  color: #10b981;
  font-weight: 500;
}

.user-status-inactive {
  color: #ef4444;
  font-weight: 500;
}

.user-detail-section {
  margin-bottom: 20px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.user-detail-section h4 {
  margin: 0 0 12px 0;
  color: #1e293b;
  font-size: 16px;
}

.user-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

.user-actions button {
  margin: 0;
}

.rfid-input {
  font-family: monospace;
  letter-spacing: 1px;
}

.user-list-item {
  cursor: pointer;
  transition: background-color 0.2s;
}

.user-list-item:hover {
  background-color: #f8fafc;
}

/* Improved filter section for monthly view */
.compact-filter-section {
  padding: 12px !important;
  margin-bottom: 12px !important;
}

.compact-filter-section label {
  font-size: 13px !important;
  font-weight: 500 !important;
  margin-bottom: 0 !important;
}

.compact-filter-section select,
.compact-filter-section input {
  padding: 6px !important;
  font-size: 13px !important;
  margin-top: 0 !important;
}

/* ========== MOBILE RESPONSIVE IMPROVEMENTS ========== */
@media(max-width:900px){
  
   /* Untuk admin: show table, hide cards */
  body.admin-user .mobile-attendance-cards {
    display: none !important;
  }
  body.admin-user .scroll-container {
    display: block !important;
  }
  
  /* Untuk user biasa: show cards, hide table */
  body:not(.admin-user) .mobile-attendance-cards {
    display: flex !important;
  }
  body:not(.admin-user) .scroll-container {
    display: none !important;
  }
    .mobile-attendance-cards {
    display: flex !important;
  }
  
  /* Hide table on mobile for non-admin users */
  body:not(.admin-user) #attendance .scroll-container {
    display: none !important;
  }
  #user-settings .section-header h3 {
    display: none; /* ‚¨ÖÔ∏è Sembunyikan h3 asal */

  }
    .sidebar.mobile-open ~ .main #user-settings .section-header::before {
    display: none !important;
  }
   #user-settings .section-header {
    display: flex;
    align-items: center;
    margin-top: 0 !important;
    padding-top: 30px !important; /* ‚¨ÖÔ∏è Ruang untuk row fixed */
  }
  
    #user-settings  .section-header::before {
    content: "‚öôÔ∏è Settings";
    position: fixed;
    top: 22px;
    left: 55px;
    font-size: 18px !important;
    font-weight: 600;
    z-index: 1000;   
  }
  
    #user-settings  .section-header h3 {
    display: none; /* ‚¨ÖÔ∏è Sembunyikan h3 asal */

  }
    #user-settings .settings-section h4 {
    font-size: 16px !important;
    font-weight: 500 !important;
    color: #1e293b !important;
    margin-bottom: 14px !important;
  }
  
  /* Besarkan label "Your Display Name:" */
  #user-settings .form-group label {
    font-size: 14px !important;
    font-weight: 500 !important;
    color: #374151 !important;
    margin-bottom: 10px !important;
  }
  
  /* Besarkan input field */
  #user-settings .form-group input {
    font-size: 16px !important;
    padding: 10px 12px !important;
    border: 2px solid #d1d5db !important;
    border-radius: 8px !important;
  }
  
  /* Besarkan button */
  #user-settings .form-group button {
    font-size: 16px !important;
    padding: 10px 16px !important;
    font-weight: 600 !important;
    margin-top: 16px !important;
  }
    .sidebar.mobile-open ~   #user-settings .section-header::before {
    display: none !important;
  }
  .workday-btn-clear,
  .workday-btn-save {
    min-height: 36px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-weight: 500 !important;
  }
   .workday-controls {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }
  
  .workday-selector-group {
    justify-content: center;
  }
  
  .workday-action-buttons {
    justify-content: center;
  }
  
  .year-selector, .month-selector {
    min-width: 70px;
    font-size: 12px;
  }
  
  .selector-label {
    font-size: 12px;
  }

  /* Adjust mobile menu button */
  .mobile-menu-btn {
    display: block;
    top: 15px;
    left: 15px;
    padding: 5px 8px;
    font-size: 12px;
    background: rgba(59, 130, 246, 0.9);
    backdrop-filter: blur(4px);
    z-index: 1002;
  }

  /* ‚¨áÔ∏è FIX: Gunakan selector yang lebih spesifik ‚¨áÔ∏è */
  .sidebar.mobile-open + .main .mobile-menu-btn,
  .sidebar.mobile-open ~ .mobile-menu-btn {
    display: none !important;
  }
  
  /* Atau cuba ini - lebih direct */
  body:has(.sidebar.mobile-open) .mobile-menu-btn {
    display: none !important;
  }

  /* Improve sidebar for mobile */
  .sidebar {
    position: fixed;
    left: -220px;
    z-index: 1000;
  }
  
  .sidebar.mobile-open {
    left: 0;
    width: 280px;
    box-shadow: 2px 0 10px rgba(0,0,0,0.2);
  }
  
  .sidebar.collapsed {
    left: 0;
    width: 220px;
  }
  
  /* Hide toggle button on mobile */
  .toggle-btn {
    display: none!important;
  }
  
  /* Adjust main content */
  .main {
    margin-left: 0;
    padding: 12px 8px;
  }
  
  /* Improve card spacing */
  .card {
    padding: 10px;
    margin-bottom: 10px;
  }
  
  /* Better table readability on mobile */
  .data-table {
    font-size: 10px;
  }
  
  .data-table th, .data-table td {
    padding: 6px 4px;
  }
  
  /* Adjust section headers */
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  /* ‚úÖ FIX: Selaraskan section headers untuk mobile */
.section-header {
  flex-direction: row !important;
  align-items: center !important;
  justify-content: space-between !important;
  gap: 12px;
  min-height: 40px;
}

.section-header h3 {
  font-size: 18px !important;
  margin: 0 !important;
  flex: 1;
  padding-left: 26px !important; 
}
    #home .section-header {
    display: flex;
    align-items: center;
    margin-top: 0 !important;
    padding-top: 30px !important; /* ‚¨ÖÔ∏è Ruang untuk row fixed */
  }
  
  #home .section-header::before {
    content: "Welcome";
    position: fixed;
    top: 22px;
    left: 55px;
    font-size: 18px !important;
    font-weight: 600;
    z-index: 1000;   
  }
  
  #home .section-header h3 {
    display: none; /* ‚¨ÖÔ∏è Sembunyikan h3 asal */

  }
    .sidebar.mobile-open ~ .main #home .section-header::before {
    display: none !important;
  }
/* ‚úÖ FIX: Selaraskan action buttons */
.action-buttons {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-top: 0 !important;
}

.action-buttons button {
  padding: 6px 8px;
  font-size: 11px;
  min-height: 36px;
  min-width: auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.action-buttons button .text {
  display: none;
}

.action-buttons button .icon {
  margin-right: 0;
  font-size: 12px;
}
  
  /* Improve filter sections */
  .filter-section {
    padding: 8px;
    gap: 8px;
  }
  
  .filter-section label {
    font-size: 11px;
  }
  
  /* Better button sizing */
  button {
    padding: 8px 10px;
    font-size: 12px;
    min-height: 40px;
  }
  
  /* Improve form elements */
  input[type=text], input[type=date], select {
    padding: 8px 10px;
    font-size: 14px;
    min-height: 40px;
  }
  
  /* Adjust summary cards */
  .summary-cards {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  
  .summary-card {
    padding: 10px;
  }
  
  .summary-card .number {
    font-size: 18px;
  }
  
  .summary-card .label {
    font-size: 11px;
  }
  
  /* Mobile overlay */
  .mobile-overlay.active {
    display: block;
  }
  
  /* Improve pagination */
  .pagination-controls {
    flex-direction: column;
    gap: 8px;
  }
  
  .pagination-buttons {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .pagination-buttons button {
    flex: 1;
    min-width: 60px;
    margin: 2px;
    padding: 4px 6px;
    font-size: 10px;
  }
  
  /* Better calendar for mobile */
    .calendar-headers {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 6px;
  }
  
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr); /* Same as headers */
    gap: 2px; /* Same gap as headers */
  }
  
  .cal-header {
    padding: 8px 2px;
    font-size: 11px;
    min-height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  
  .cal-cell {
    min-height: 50px!important;
    padding: 4px 2px!important;
    font-size: 12px;
    text-align: center;
  }
  
  /* Ensure both headers and cells have same width distribution */
  .cal-header,
  .cal-cell {
    width: 100%;
    box-sizing: border-box;
  }
  
  /* Adjust chart sizes */
  #weeklyChart, #monthlyChart {
    height: 150px !important;
  }
  
  /* Improve user management */
  .user-detail-section {
    padding: 10px;
  }
  
  .user-actions {
    flex-direction: column;
  }
  
  .user-actions button {
    width: 100%;
  }
  
  /* Adjust form rows for mobile */
  .form-row {
    flex-direction: column;
  }
  
  .form-group {
    min-width: 100%;
  }
  
  /* Smaller status badges */
  .status-present, .status-late, .status-absent, .status-holiday {
    padding: 3px 5px;
    font-size: 10px;
    min-width: 20px;
  }
  
  /* Smaller vehicle items */
  .vehicle-item {
    padding: 6px;
  }
  
  /* Smaller search boxes */
  .search-box input {
    padding: 6px 8px;
    font-size: 12px;
  }
  
  /* Reduce text sizes for mobile */
  body {
    font-size: 12px;
  }
  
  .pagination-info {
    font-size: 10px;
  }
  
  /* Smaller form elements */
  .form-group label {
    font-size: 11px;
  }
  
  .add-vehicle-form, .settings-section, .user-detail-section {
    padding: 10px;
  }
  /* ========== CUSTOM DAILY ADMIN TEXT SIZES ========== */
#daily .section-header h3 {
  font-size: 14px !important;
  font-weight: 600 !important;
}

#daily .filter-section label {
  font-size: 10px !important;
  font-weight: 500 !important;
}

#daily .filter-section select,
#daily .filter-section input {
  font-size: 10px !important;
}

#dailyDateInfo {
  font-size: 10px !important;
  font-weight: 500 !important;
}

#daily .data-table th {
  font-size: 12px !important;
  padding: 14px 12px !important;
  font-weight: 500 !important;
}

#daily .data-table td {
  font-size: 9px !important;
  padding: 12px 10px !important;
}

#daily .status-present,
#daily .status-absent,
#daily .status-holiday {
  font-size: 9px !important;
  padding: 6px 9px !important;
  font-weight: 500 !important;
}

#daily .pagination-info {
  font-size: 8px !important;
  font-weight: 500 !important;
}

#daily .pagination-buttons button {
  font-size: 8px !important;
  padding: 8px 14px !important;
  font-weight: 400 !important;
}
}

/* ========== 600px BREAKPOINT ========== */
@media(max-width:600px){
  /* Mobile menu button fixes */
  .sidebar.mobile-open + .main .mobile-menu-btn,
  .sidebar.mobile-open ~ .mobile-menu-btn {
    display: none !important;
  }
 .workday-selector-group {
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }
  
  .selector-container {
    justify-content: space-between;
    width: 100%;
  }
  
  .year-selector, .month-selector {
    flex: 1;
    min-width: auto;
  }
  
  .cal-cell {
    min-height: 45px !important; /* Even smaller for phones */
  }
  
  .cal-cell .date {
    font-size: 13px !important;
  }

  
  .cal-cell .status-label {
    font-size: 9px;
  }

    .calendar-headers {
    gap: 1px;
  }
  
  .calendar {
    gap: 1px; /* Same as headers */
  }
  
  .cal-header {
    font-size: 10px;
    padding: 6px 1px;
    min-height: 28px;
  }
  
  .cal-cell {
    min-height: 40px;
    padding: 4px 1px;
    font-size: 11px;
  }
  body:has(.sidebar.mobile-open) .mobile-menu-btn {
    display: none !important;
  }
  
  /* Further adjustments for small phones */
  .sidebar.mobile-open {
    width: 260px;
  }
  
  .data-table {
    font-size: 9px;
  }
  
  .data-table th, .data-table td {
    padding: 4px 2px;
  }
  
  .summary-cards {
    grid-template-columns: 1fr;
  }
  
  .filter-section {
    flex-direction: column;
    align-items: stretch;
  }
  
  /* Better weekly layout */
  #weekly .card {
    flex-direction: column;
  }
  
  /* Adjust calendar further */
  .calendar {
    gap: 1px;
  }
  
  .cal-cell {
    min-height: 30px;
    padding: 1px;
  }
  
  .cal-cell .date {
    font-size: 9px;
  }
  
  /* ‚úÖ FIX: Even smaller but selari */
.action-buttons button {
  padding: 5px 6px;
  font-size: 10px;
  min-height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ‚úÖ FIX: Smaller section headers tapi tetap selari */
.section-header h3 {
  font-size: 17px!important; 
  margin: 0 !important;
}

.section-header {
  gap: 8px !important;
  padding-left: 26px !important;
}
  
  /* Smaller cards */
  .card {
    padding: 8px;
  }
  
  /* Smaller charts */
  #weeklyChart, #monthlyChart {
    height: 130px !important;
  }
  
  .sidebar.mobile-open ~ .main #home .section-header::before {
    display: none !important;
  }
  
  .toggle-btn {
    display: none!important;
  }
  
  /* ========== ATTENDANCE CARD LAYOUT FOR PHONE USERS ========== */
  /* Hide table for non-admin users on mobile */
  body:not(.admin-user) #attendance .data-table {
    display: none !important;
  }
  
  /* Show card layout for non-admin users on mobile */
 
  .workday-action-buttons {
    flex-direction: column;
    gap: 4px;
  }
  
  .workday-action-buttons button {
    width: 100%;
    min-width: auto;
    padding: 5px 6px;
    font-size: 10px;
  }
  
  .workday-nav-buttons button {
    padding: 4px 6px;
    font-size: 10px;
  }
  
  #calendarTitle {
    font-size: 13px;
    padding: 0 4px;
  }

  /* Attendance Card Styles */
  .attendance-card {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
  }
  
  .attendance-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f1f5f9;
  }
  
  .attendance-card-name {
    font-weight: 600;
    font-size: 14px;
    color: #1e293b;
  }
  
  .attendance-card-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
  }
  
  .attendance-card-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    font-size: 12px;
  }
  
  .attendance-card-detail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .attendance-card-label {
    color: #64748b;
    font-size: 13px !important;
    font-weight: 500;
  }
  
  .attendance-card-value {
    color: #334155;
    font-size: 13px !important;
    font-weight: 500;
  }
  
  /* Status color variations */
  .attendance-card-status.present {
    background: #10b981;
    color: white;
  }
  
  .attendance-card-status.late {
    background: #f59e0b;
    color: white;
  }
  
  .attendance-card-status.absent {
    background: #ef4444;
    color: white;
  }
  
  .attendance-card-status.holiday {
    background: #6b7280;
    color: white;
  }
  
  /* No records message */
  .no-attendance-cards {
    text-align: center;
    padding: 20px;
    color: #64748b;
    font-size: 14px;
  }
}

/* ========== 400px BREAKPOINT ========== */
@media(max-width:400px){
   .calendar-headers {
    gap: 1px;
  }
  
  .calendar {
    gap: 1px; /* Consistent gap */
  }
  
  .cal-header {
    font-size: 9px;
    padding: 4px 1px;
    min-height: 26px;
  }
  
  .cal-cell {
    min-height: 60px;
    padding: 3px 1px;
    font-size: 10px;
  }
  /* Mobile menu button fixes */
  .sidebar.mobile-open + .main .mobile-menu-btn,
  .sidebar.mobile-open ~ .mobile-menu-btn {
    display: none !important;
  }
    .workday-btn-clear,
  .workday-btn-save {
    min-height: 30px !important;
    font-size: 10px !important;
  }
  .workday-action-buttons button {
    padding: 4px 5px;
    font-size: 9px;
  }
  
  .workday-action-buttons .workday-btn-clear .full-text {
    display: none;
  }
  
  .workday-action-buttons .workday-btn-save .full-text {
    display: none;
  }
  
  .workday-nav-buttons button {
    padding: 4px 5px;
    font-size: 9px;
    min-width: 24px;
  }
  
  #calendarTitle {
    font-size: 11px;
    padding: 0 2px;
  }
  body:has(.sidebar.mobile-open) .mobile-menu-btn {
    display: none !important;
  }
  
  /* Extra small phone adjustments */
  .sidebar.mobile-open {
    width: 240px;
  }
  
  .data-table {
    font-size: 8px;
  }
  
  .data-table th, .data-table td {
    padding: 3px 1px;
  }
  
  .card {
    padding: 6px;
  }
  
  .section-header h3 {
    font-size: 16px!important;
    margin: 0 !important;
  }

  .section-header {
    gap: 6px !important;
    min-height: 35px;
    padding-left: 26px !important;
  }

  .sidebar.mobile-open ~ .main #home .section-header::before {
    display: none !important;
  }

  button {
    padding: 4px 5px;
    font-size: 9px;
    min-height: 32px;
  }
  
  /* Even smaller summary cards */
  .summary-card {
    padding: 8px;
  }
  
  .summary-card .number {
    font-size: 16px;
  }
  
  .summary-card .label {
    font-size: 10px;
  }
  
  /* Ultra compact for very small devices */
  .main {
    padding: 8px 6px;
  }

  .action-buttons button {
    padding: 4px 5px;
    min-height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Ultra compact tables */
  .data-table th, 
  .data-table td {
    padding: 2px 1px;
  }
  
  .toggle-btn {
    display: none!important;
  }
  
  /* ========== ATTENDANCE CARD LAYOUT ENHANCEMENTS FOR 400px ========== */
  .attendance-card {
    padding: 10px;
    margin-bottom: 8px;
  }
  
  .attendance-card-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }
  
  .attendance-card-name {
    font-size: 13px;
  }
  
  .attendance-card-status {
    font-size: 10px;
    padding: 3px 6px;
    align-self: flex-start;
  }
  
  .attendance-card-details {
    grid-template-columns: 1fr;
    gap: 6px;
  }
  
  .attendance-card-detail-item {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
  
  .attendance-card-label {
    font-size: 10px;
    min-width: 80px;
  }
  
  .attendance-card-value {
    font-size: 11px;
    text-align: right;
  }
  
  .no-attendance-cards {
    padding: 15px;
    font-size: 13px;
  }
}

</style>
</head>
<body>

<div id="spinner"></div>

<!-- Mobile Menu Button -->
<button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>

<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <h2>üìä Smart Attendance</h2>
  <a href="#" id="nav-home" onclick="showSection('home')" data-tooltip="Home"><i>üè†</i><span>Home</span></a>
  <a href="#" id="nav-attendance" onclick="showSection('attendance')" data-tooltip="Attendance"><i>üìã</i><span>Attendance</span></a>
  <a href="#" id="nav-register" onclick="showSection('register')" data-tooltip="Register Plate"><i>üìù</i><span>Register Plate</span></a>
  <a href="#" id="nav-user-management" onclick="showSection('user-management')" style="display:none" data-tooltip="User Management"><i>üë•</i><span>User Management</span></a>
  <a href="#" id="nav-daily" onclick="showSection('daily')" style="display:none" data-tooltip="Daily"><i>üìÖ</i><span>Daily</span></a>
  <a href="#" id="nav-weekly" onclick="showSection('weekly')" style="display:none" data-tooltip="Weekly"><i>üóìÔ∏è</i><span>Weekly</span></a>
  <a href="#" id="nav-monthly" onclick="showSection('monthly')" style="display:none" data-tooltip="Monthly"><i>üìÜ</i><span>Monthly</span></a>
  <a href="#" id="nav-workday" onclick="showSection('workday')" style="display:none" data-tooltip="Workday Manager"><i>üõ†Ô∏è</i><span>Workday</span></a>
  <a href="#" id="nav-settings" onclick="showSection('user-settings')" data-tooltip="Settings"><i>‚öôÔ∏è</i><span>Settings</span></a>
  <a href="#" onclick="logout()" data-tooltip="Logout"><i>üîì</i><span>Logout</span></a>
  <span class="toggle-btn" id="toggleBtn" onclick="toggleSidebar()">‚¨ÖÔ∏è</span>
</div>

<!-- Main -->
<div class="main">

<!-- Home -->
<div id="home" class="card section">
  <div class="section-header">
    <h3>Welcome</h3>
  </div>
  <p>Signed in as <strong id="userEmail">-</strong></p>
  <p id="userRoleInfo" class="small"></p>
</div>

<!-- Attendance Section Example -->
<div id="attendance" class="card section" style="display:none">
  <div class="section-header">
    <h3>üìã Attendance Records</h3>
    <div class="action-buttons">
      <button onclick="loadAttendanceByDate()">
        <span class="icon">üîÑ</span>
        <span class="text"> Refresh</span>
      </button>
      <button class="admin-only" onclick="exportAttendanceData()">
        <span class="icon">üì§</span>
        <span class="text"> Export</span>
      </button>
    </div>
  </div>

  <div class="filter-section compact-filter-section">
    <div>
      <label>Select Date</label>
      <input type="date" id="datePicker" onchange="loadAttendanceByDate()" />
    </div>
    <div class="admin-only">
      <label>Filter by Department</label>
      <select id="jabatanFilter" onchange="loadAttendanceByDate()">
        <option value="">ALL</option>
        <option>PENGARAH</option>
        <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
        <option>TIMBALAN PENGARAH AKADEMIK</option>
        <option>KETUA JAMINAN KUALITI</option>
        <option>JABATAN TEKNOLOGI AWAM</option>
        <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
        <option>JABATAN TEKNOLOGI MAKLUMAT</option>
        <option>JABATAN PERNIAGAAN</option>
        <option>JABATAN PENDIDIKAN UMUM</option>
        <option>UNIT PSIKOLOGI DAN KERJAYA</option>
      </select>
    </div>
    <div class="admin-only">
      <label>Search by Name</label>
      <input type="text" id="searchAttendance" placeholder="Enter name..." onkeyup="filterAttendanceTable()">
    </div>
  </div>

  <!-- Card Layout Container (for mobile users) -->
  <div class="mobile-attendance-cards" id="mobileAttendanceCards"></div>

  <!-- Table Layout (for admin users) -->
  <div class="scroll-container">
    <table class="data-table">
      <thead>
        <tr>  
          <th>Name</th>
          <th>Department</th>
          <th>Shift</th>
          <th>Status</th>
          <th>Checkin</th>
          <th>Checkout</th>
          <th>Worked Hours</th>
          <th>Punctuality</th>
        </tr>
      </thead>
      <tbody id="attendanceTable"></tbody>
    </table>
  </div>
  
  <!-- Enhanced Pagination Controls -->
  <div id="attendancePagination" class="pagination-controls admin-only">
    <div class="pagination-info" id="paginationInfo">Showing 0-0 of 0 records</div>
    <div class="pagination-buttons">
      <button id="firstPageBtn" onclick="goToPage(1)" disabled>‚èÆÔ∏è First</button>
      <button id="prevPageBtn" onclick="goToPreviousPage()" disabled>‚óÄÔ∏è Previous</button>
      <button id="nextPageBtn" onclick="goToNextPage()" disabled>Next ‚ñ∂Ô∏è</button>
      <button id="lastPageBtn" onclick="goToLastPage()" disabled>Last ‚è≠Ô∏è</button>
    </div>
  </div>
</div>

<!-- Register (for regular users) -->
<div id="register" class="card section" style="display:none">
  <div class="section-header">
    <h3>üìù Register Vehicle</h3>
    <div class="action-buttons">
      <button onclick="loadRegisteredVehicles()"><span class="icon">üîÑ</span><span class="text"> Refresh</span></button>
    </div>
  </div>
  
  <div class="add-vehicle-form">
    <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">‚ûï Add New Vehicle</h4>
    <div class="form-row">
      <div class="form-group">
        <label for="regPlate">Plate Number</label>
        <input type="text" id="regPlate" placeholder="">
      </div>
      <div class="form-group">
        <label for="regJawatan">Department</label>
        <select id="regJawatan">
          <option value="">Select Department</option>
          <option>PENGARAH</option>
          <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
          <option>TIMBALAN PENGARAH AKADEMIK</option>
          <option>KETUA JAMINAN KUALITI</option>
          <option>JABATAN TEKNOLOGI AWAM</option>
          <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
          <option>JABATAN TEKNOLOGI MAKLUMAT</option>
          <option>JABATAN PERNIAGAAN</option>
          <option>JABATAN PENDIDIKAN UMUM</option>
          <option>UNIT PSIKOLOGI DAN KERJAYA</option>
        </select>
      </div>
    </div>
    <button onclick="registerPlate()" style="margin-top: 8px;">‚úÖ Register Vehicle</button>
    <p class="small" style="margin-top: 8px;">Your name <strong id="currentUserName"></strong> will be automatically used for registration.</p>
  </div>
  
  <div class="vehicle-list">
    <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">üöó Your Registered Vehicles</h4>
    <div class="search-box">
      <input type="text" id="searchVehicles" placeholder="Search your vehicles..." onkeyup="filterVehicles()">
    </div>
    <div id="registeredVehicles"></div>
  </div>
</div>

<!-- User Management (for admin only) -->
<div id="user-management" class="card section" style="display:none">
  <div class="section-header">
    <h3>üë• User Management</h3>
    <div class="action-buttons">
      <button onclick="loadUsers()"><span class="icon">üîÑ</span><span class="text"> Refresh</span></button>
    </div>
  </div>
  
  <div class="filter-section">
    <div class="form-group">
      <label for="userDepartmentFilter">Filter by Department</label>
      <select id="userDepartmentFilter" onchange="filterUsers()">
        <option value="">ALL</option>
        <option>PENGARAH</option>
        <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
        <option>TIMBALAN PENGARAH AKADEMIK</option>
        <option>KETUA JAMINAN KUALITI</option>
        <option>JABATAN TEKNOLOGI AWAM</option>
        <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
        <option>JABATAN TEKNOLOGI MAKLUMAT</option>
        <option>JABATAN PERNIAGAAN</option>
        <option>JABATAN PENDIDIKAN UMUM</option>
        <option>UNIT PSIKOLOGI DAN KERJAYA</option>
      </select>
    </div>
    <div class="form-group">
      <label for="searchUser">Search User</label>
      <input type="text" id="searchUser" placeholder="Search User..." onkeyup="filterUsers()">
    </div>
  </div>
  
  <div class="pagination-info" id="userPaginationInfo">Showing 1-25 of 0 users</div>
  
  <div class="scroll-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Department</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </div>
  
  <div class="pagination-controls">
    <div class="pagination-info" id="userPaginationInfoBottom">Showing 1-25 of 0 users</div>
    <div class="pagination-buttons">
      <button id="userFirstPageBtn" onclick="goToUserPage(1)" disabled>‚èÆÔ∏è First</button>
      <button id="userPrevPageBtn" onclick="goToPreviousUserPage()" disabled>‚óÄÔ∏è Previous</button>
      <button id="userNextPageBtn" onclick="goToNextUserPage()" disabled>Next ‚ñ∂Ô∏è</button>
      <button id="userLastPageBtn" onclick="goToLastUserPage()" disabled>Last ‚è≠Ô∏è</button>
    </div>
  </div>
</div>

<!-- User Detail Page (for admin only) -->
<div id="user-detail" class="card section" style="display:none">
  <div class="section-header">
    <h3 id="userDetailTitle">User Profile</h3>
    <div class="action-buttons">
      <button onclick="showSection('user-management')"><span class="icon">‚Üê</span><span class="text"> Back</span></button>
    </div>
  </div>
  
  <div class="user-detail-section">
    <h4>üìã Basic Information</h4>
    <div class="form-row">
      <div class="form-group">
        <label for="userDetailName">Name</label>
        <input type="text" id="userDetailName" class="auto-capitalize" readonly>
      </div>
      <div class="form-group">
        <label for="userDetailDepartment">Department</label>
        <input type="text" id="userDetailDepartment" readonly>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="userDetailEmail">Email</label>
        <input type="text" id="userDetailEmail" readonly>
      </div>
      <div class="form-group">
        <label for="userDetailRFID">RFID UID</label>
        <input type="text" id="userDetailRFID" class="rfid-input" placeholder="E4F77C05" oninput="this.value = this.value.toUpperCase()">
      </div>
    </div>
  </div>
  
  <div class="user-detail-section">
    <h4>üöó Registered Vehicles</h4>
    <div id="userVehiclesList"></div>
    <p class="small" style="margin-top: 10px; color: #64748b;">
    </p>
  </div>
  
  <div class="user-detail-section">
    <h4>‚öôÔ∏è Admin Actions</h4>
    <div class="user-actions">
      <button onclick="saveUserRFID()">Save RFID UID</button>
      <button onclick="toggleUserStatus()" id="toggleUserStatusBtn">Deactivate User</button>
    </div>
  </div>
</div>

<!-- Daily - FIXED VERSION -->
<div id="daily" class="card section" style="display:none">
  <div class="section-header">
    <h3>üìÖ Daily Status</h3>
    <div class="action-buttons">
      <button onclick="calculateDailyStatus()"><span class="icon">üîÑ</span><span class="text"> Refresh</span></button>
    </div>
  </div>

  <div class="filter-section admin-only compact-filter-section">
    <div>
      <label>Filter by Department</label>
      <select id="jabatanFilterDaily" onchange="calculateDailyStatus()">
        <option value="">All</option>
        <option>PENGARAH</option>
        <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
        <option>TIMBALAN PENGARAH AKADEMIK</option>
        <option>KETUA JAMINAN KUALITI</option>
        <option>JABATAN TEKNOLOGI AWAM</option>
        <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
        <option>JABATAN TEKNOLOGI MAKLUMAT</option>
        <option>JABATAN PERNIAGAAN</option>
        <option>JABATAN PENDIDIKAN UMUM</option>
        <option>UNIT PSIKOLOGI DAN KERJAYA</option>
      </select>
    </div>
    <div>
      <label>Search by Name</label>
      <input type="text" id="searchDaily" placeholder="Search by name..." onkeyup="filterDailyTable()">
    </div>
  </div>

  <!-- Date Info Display -->
  <div id="dailyDateInfo" class="daily-date-info"></div>

  <div class="scroll-container">
    <div id="dailyStatusTable"></div>
  </div>

  <!-- Daily Status Pagination Controls Bottom -->
  <div id="dailyPaginationBottom" class="pagination-controls admin-only">
    <div class="pagination-info" id="dailyPaginationInfoBottom">Showing 0-0 of 0 records</div>
    <div class="pagination-buttons">
      <button id="dailyFirstPageBtnBottom" onclick="goToDailyPage(1)" disabled>‚èÆÔ∏è First</button>
      <button id="dailyPrevPageBtnBottom" onclick="goToPreviousDailyPage()" disabled>‚óÄÔ∏è Previous</button>
      <button id="dailyNextPageBtnBottom" onclick="goToNextDailyPage()" disabled>Next ‚ñ∂Ô∏è</button>
      <button id="dailyLastPageBtnBottom" onclick="goToLastDailyPage()" disabled>Last ‚è≠Ô∏è</button>
    </div>
  </div>
</div>

<!-- Weekly Report -->
<div id="weekly" class="card section" style="display:none">
  <div class="section-header">
    <h3>üóìÔ∏è Weekly Attendance Report</h3>
    <div class="action-buttons">
      <button onclick="calculateWeeklySummary()" title="Refresh Summary"><span class="icon">üîÑ</span><span class="text"> Refresh</span></button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-section admin-only">
    <div>
      <label>Week containing date:</label>
      <input type="date" id="weekPicker" onchange="calculateWeeklySummary()" />
    </div>
    <div>
      <label>Filter Department:</label>
      <select id="weekJabatanFilter" onchange="calculateWeeklySummary()">
        <option value="">All Departments</option>
        <option>PENGARAH</option>
        <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
        <option>TIMBALAN PENGARAH AKADEMIK</option>
        <option>KETUA JAMINAN KUALITI</option>
        <option>JABATAN TEKNOLOGI AWAM</option>
        <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
        <option>JABATAN TEKNOLOGI MAKLUMAT</option>
        <option>JABATAN PERNIAGAAN</option>
        <option>JABATAN PENDIDIKAN UMUM</option>
        <option>UNIT PSIKOLOGI DAN KERJAYA</option>
      </select>
    </div>
  </div>

  <!-- Layout -->
  <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;">
    <div style="flex:1;min-width:280px;">
      <div class="card admin-only">
        <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">üìä Weekly Statistics</h4>
        <div id="weeklySummaryTable"></div>
      </div>
      
      <div class="card admin-only" style="margin-top:12px;">
        <h4 style="margin:0 0 10px 0;color:#1e293b;font-size:16px;">üìà Attendance Trend</h4>
        <canvas id="weeklyChart" height="220"></canvas>
      </div>
    </div>
    
    <div style="flex:2;min-width:500px;">
      <div class="card">
        <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">üë• Staff Attendance Details</h4>
        <div class="search-box admin-only">
          <input type="text" id="searchWeekly" placeholder="Search by name..." onkeyup="filterWeeklyTable()">
        </div>
        <div class="scroll-container">
          <div id="weeklyDetailGrid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Monthly - UPDATED VERSION -->
<div id="monthly" class="card section" style="display:none">
  <div class="section-header">
    <h3>üìÜ Monthly Summary</h3>
    <div class="action-buttons">
      <button onclick="calculateMonthlySummary()"><span class="icon">üîÑ</span><span class="text"> Refresh</span></button>
    </div>
  </div>

  <!-- Compact Filter Section -->
  <div class="filter-section admin-only compact-filter-section">
    <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <label style="margin: 0; font-size: 13px; font-weight: 500;">Month:</label>
        <select id="monthSelect" style="width: 100px; padding: 6px; font-size: 13px;"></select>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <label style="margin: 0; font-size: 13px; font-weight: 500;">Year:</label>
        <select id="yearSelect" style="width: 90px; padding: 6px; font-size: 13px;"></select>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <label style="margin: 0; font-size: 13px; font-weight: 500;">Department:</label>
        <select id="monthJabatanFilter" style="width: 180px; padding: 6px; font-size: 13px;" onchange="calculateMonthlySummary()">
          <option value="">ALL</option>
          <option>PENGARAH</option>
          <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
          <option>TIMBALAN PENGARAH AKADEMIK</option>
          <option>KETUA JAMINAN KUALITI</option>
          <option>JABATAN TEKNOLOGI AWAM</option>
          <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
          <option>JABATAN TEKNOLOGI MAKLUMAT</option>
          <option>JABATAN PERNIAGAAN</option>
          <option>JABATAN PENDIDIKAN UMUM</option>
          <option>UNIT PSIKOLOGI DAN KERJAYA</option>
        </select>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <label style="margin: 0; font-size: 13px; font-weight: 500;">Search:</label>
        <input type="text" id="searchMonthly" placeholder="Search by name..." style="width: 180px; padding: 6px; font-size: 13px;" onkeyup="filterMonthlyTable()">
      </div>
    </div>
  </div>

  <!-- Larger Chart -->
  <div class="card admin-only" style="margin-bottom: 16px;">
    <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">üìä Monthly Attendance Overview</h4>
    <canvas id="monthlyChart" height="250"></canvas>
  </div>
  
  <!-- Summary Table -->
  <div class="card" style="margin-bottom: 16px;">
    <div id="monthlySummaryTable"></div>
  </div>
  
  <!-- Daily Details -->
  <div class="card">
    <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">üìã Daily Attendance Details</h4>
    <div class="scroll-container">
      <div id="monthlyDetailGrid"></div>
    </div>
  </div>
</div>

<!-- Workday Manager (admin only) - UPDATED VERSION -->
<div id="workday" class="card section" style="display:none">
  <div class="section-header">
    <h3>üõ†Ô∏è Workday Manager</h3>
    <div class="action-buttons">
      <button onclick="renderCalendar(currentCalendarYear,currentCalendarMonth)"><span class="icon">üîÑ</span><span class="text"> Refresh</span></button>
    </div>
  </div>
  
  <!-- Year/Month Selector Controls -->
  <div class="workday-controls">
    <div class="workday-selector-group">
      <div class="selector-container">
        <label for="yearSelectWorkday" class="selector-label">Year:</label>
        <select id="yearSelectWorkday" class="year-selector" onchange="onYearMonthChange()">
          <!-- Options will be populated by JavaScript -->
        </select>
      </div>
      <div class="selector-container">
        <label for="monthSelectWorkday" class="selector-label">Month:</label>
        <select id="monthSelectWorkday" class="month-selector" onchange="onYearMonthChange()">
          <option value="0">January</option>
          <option value="1">February</option>
          <option value="2">March</option>
          <option value="3">April</option>
          <option value="4">May</option>
          <option value="5">June</option>
          <option value="6">July</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">October</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
    </div>
    
    <div class="workday-action-buttons">
      <button onclick="clearSelection()" style="background:#ef4444;" class="workday-btn-clear">Clear Selection</button>
      <button onclick="saveVisibleWorkdays()" style="background:#10b981;" class="workday-btn-save">Save All</button>
    </div>
  </div>
    <!-- Calendar Grid with Day Headers -->
  <div class="calendar-container">
    <!-- Day of Week Headers -->
    <div class="calendar-headers">
      <div class="cal-header">Sun</div>
      <div class="cal-header">Mon</div>
      <div class="cal-header">Tue</div>
      <div class="cal-header">Wed</div>
      <div class="cal-header">Thu</div>
      <div class="cal-header">Fri</div>
      <div class="cal-header">Sat</div>
    </div>
  <div id="calendarGrid" class="calendar" aria-hidden="false"></div>
  
  <div id="workdayStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none;"></div>
</div>
</div>


<!-- Settings -->
<div id="user-settings" class="card section" style="display:none">
  <div class="section-header">
    <h3>‚öôÔ∏è Settings</h3>
  </div>
  
  <!-- User Name Settings -->
  <div class="settings-section">
    <h4>üë§ Your Profile</h4>
    <div class="form-group">
      <label for="userNameInput">Your Display Name:</label>
      <input type="text" id="userNameInput" class="auto-capitalize" placeholder="Enter your name as it appears in attendance records" oninput="autoCapitalize(this)">
      <button onclick="updateUserName()" style="margin-top: 8px;">üíæ Update Name</button>
    </div>
  </div>
</div>

</div>

<div id="snackbar"></div>

<script>
// ========== Firebase config ==========
const firebaseConfig = {
  apiKey: "AIzaSyDXM92nMwpSqPVWifILYeDMTMEh_fuhN5M",
  authDomain: "drive-thru-smartattendance.firebaseapp.com",
  databaseURL: "https://drive-thru-smartattendance-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "drive-thru-smartattendance",
  storageBucket: "drive-thru-smartattendance.appspot.com",
  messagingSenderId: "235048051665",
  appId: "1:235048051665:web:a8c68cc40eb83946e9f6f0"
};

// Initialize Firebase
try {
  firebase.initializeApp(firebaseConfig);
} catch (error) {
  console.log('Firebase already initialized');
}

firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);
const db = firebase.database();

// ========== Enhanced Mobile Menu Functionality ==========
function setupMobileMenu() {
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const sidebar = document.getElementById('sidebar');
  const mobileOverlay = document.getElementById('mobileOverlay');
  
  if (mobileMenuBtn && sidebar && mobileOverlay) {
    mobileMenuBtn.addEventListener('click', function() {
      sidebar.classList.toggle('mobile-open');
      mobileOverlay.classList.toggle('active');
      document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
    });
    
    mobileOverlay.addEventListener('click', function() {
      sidebar.classList.remove('mobile-open');
      mobileOverlay.classList.remove('active');
      document.body.style.overflow = '';
    });
    
    // Close menu when clicking on a link
    document.querySelectorAll('.sidebar a').forEach(link => {
      link.addEventListener('click', function() {
        sidebar.classList.remove('mobile-open');
        mobileOverlay.classList.remove('active');
        document.body.style.overflow = '';
      });
    });
  }
}

// ========== Helpers & state ==========
function showSpinner() {
  document.getElementById('spinner').style.display = 'block';
}

function hideSpinner() {
  document.getElementById('spinner').style.display = 'none';
}

function showSnackbar(msg) {
  const sb = document.getElementById('snackbar');
  sb.textContent = msg;
  sb.className = "show";
  setTimeout(() => sb.className = "", 3000);
}

function normalizePlate(txt) {
  return (txt || '').trim().toUpperCase().replace(/\s+/g, '');
}

function pad(n) {
  return n.toString().padStart(2, '0');
}

function ymdFromDate(d) {
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
}

function isDefaultWorkdayObj(dateObj) {
  const dow = dateObj.getDay();
  return (dow >= 1 && dow <= 5);
}

function isDefaultWorkdayISO(iso) {
  const parts = iso.split('-').map(x => parseInt(x, 10));
  return isDefaultWorkdayObj(new Date(parts[0], parts[1] - 1, parts[2]));
}

function parseTimeToMinutes(t) {
  if (!t || typeof t !== 'string') return null;
  const m = t.match(/(\d{1,2}):(\d{2})/);
  if (!m) return null;
  return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
}

// ‚úÖ FIXED: Simple todayISO()
function todayISO() {
  const now = new Date();
  
  // Debug info
  console.log('üïí TIME DEBUG:', {
    UTC: now.toISOString(),
    Local: now.toString(),
    Hours: now.getHours(),
    Date: now.getDate()
  });
  
  // Simple local date (akan auto-adjust untuk timezone Malaysia)
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  
  const result = `${year}-${month}-${day}`;
  console.log('üìÖ todayISO() RESULT:', result);
  
  return result;
}

// ========== AUTO CAPITALIZE FUNCTION ==========
function autoCapitalize(input) {
  const start = input.selectionStart;
  const end = input.selectionEnd;
  
  input.value = input.value
    .toLowerCase()
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
  
  input.setSelectionRange(start, end);
}

// Workdays cache
let workdaysCache = {};
let selectedDatesSet = new Set();

// Chart instances
let weeklyChartInstance = null;
let monthlyChart = null;

// Pagination variables
let currentAttendancePage = 1;
const attendancePerPage = 10;
let totalAttendanceRecords = 0;
let totalAttendancePages = 0;

// User management
let currentUser = null;
let isAdmin = false;
let userPlates = [];
let userName = '';

// User Management Variables
let currentUserPage = 1;
const usersPerPage = 25;
let totalUsers = 0;
let totalUserPages = 0;
let allUsers = [];
let currentEditingUser = null;

// Daily Status Pagination Variables
let currentDailyPage = 1;
const dailyPerPage = 10;
let totalDailyRecords = 0;
let totalDailyPages = 0;
let allDailyRecords = [];

// Global plates data for department lookup
let allPlatesData = {};

// Calendar rendering control
let isRenderingCalendar = false;
let lastRenderCall = { year: null, month0: null };

// Workday modifications
let modifiedDates = new Map();
let workdaysFullSnapshot = null;

// ========== USER PROFILE SYSTEM ==========
function extractNameFromEmail(email) {
  if (!email) return 'User';
  const namePart = email.split('@')[0];
  const cleanName = namePart.replace(/[0-9._-]/g, ' ').trim();
  if (!cleanName) return 'User';
  return cleanName
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

// ‚úÖ IMPROVED: Better name matching function
function matchByNameVariations(attendanceName, userName) {
  if (!attendanceName || !userName) return false;
  
  const cleanAttendance = attendanceName.toLowerCase().replace(/\s+/g, ' ').trim();
  const cleanUser = userName.toLowerCase().replace(/\s+/g, ' ').trim();
  
  // Exact match
  if (cleanAttendance === cleanUser) return true;
  
  // First name match
  const attendanceFirst = cleanAttendance.split(' ')[0];
  const userFirst = cleanUser.split(' ')[0];
  if (attendanceFirst && userFirst && attendanceFirst === userFirst) return true;
  
  // Contains match
  if (cleanAttendance.includes(cleanUser) || cleanUser.includes(cleanAttendance)) return true;
  
  // Initials match (for cases like "N Shah" vs "Naufal Shah")
  const attendanceWords = cleanAttendance.split(' ');
  const userWords = cleanUser.split(' ');
  
  if (attendanceWords.length > 0 && userWords.length > 0) {
    const attendanceInitials = attendanceWords.map(n => n[0]).join('');
    const userInitials = userWords.map(n => n[0]).join('');
    if (attendanceInitials === userInitials) return true;
  }
  
  return false;
}

// ‚úÖ NEW HELPER FUNCTIONS untuk color coding
function getStatusColor(status) {
  const lowerS = (status || "").toLowerCase();
  if (lowerS.includes("present") || lowerS.includes("complete")) {
    return "color:#10b981;font-weight:500;";
  } else if (lowerS.includes("incomplete")) {
    return "color:#f59e0b;font-weight:500;";
  } else if (lowerS.includes("absent")) {
    return "color:#ef4444;font-weight:500;";
  }
  return "color:#334155;font-weight:500;";
}

function getPunctualityColor(punctuality) {
  const lowerP = (punctuality || "").toLowerCase();
  if (lowerP.includes("late")) {
    return "color:#ef4444;font-weight:500;";
  } else if (lowerP.includes("punctual") || lowerP.includes("on time")) {
    return "color:#10b981;font-weight:500;";
  }
  return "color:#334155;font-weight:500;";
}

// ‚úÖ NEW FUNCTION: Render attendance cards untuk mobile users
function renderAttendanceCards(records) {
  const container = document.getElementById('mobileAttendanceCards');
  
  if (!records || records.length === 0) {
    container.innerHTML = '<div class="no-attendance-cards">No attendance records found for selected date.</div>';
    return;
  }
  
  let cardsHtml = '';
  
  records.forEach(record => {
    const status = record.status || '-';
    const shift = record.shift || '-';
    const checkin = record.checkin || '-';
    const checkout = record.checkout || '-';
    const workedHours = record.workedHours || '-';
    const punctuality = record.punctuality || '-';
    
    // Determine status class
    let statusClass = 'holiday';
    if (status.toLowerCase().includes('present')) {
      statusClass = 'present';
    } else if (status.toLowerCase().includes('late')) {
      statusClass = 'late';
    } else if (status.toLowerCase().includes('absent')) {
      statusClass = 'absent';
    }
    
    cardsHtml += `
      <div class="attendance-card">
        <div class="attendance-card-header">
          <div class="attendance-card-name">${record.name}</div>
          <div class="attendance-card-status ${statusClass}">${status}</div>
        </div>
        <div class="attendance-card-details">
          <div class="attendance-card-detail-item">
            <span class="attendance-card-label">Shift</span>
            <span class="attendance-card-value">${shift}</span>
          </div>
          <div class="attendance-card-detail-item">
            <span class="attendance-card-label">Check-in</span>
            <span class="attendance-card-value">${checkin}</span>
          </div>
          <div class="attendance-card-detail-item">
            <span class="attendance-card-label">Check-out</span>
            <span class="attendance-card-value">${checkout}</span>
          </div>
          <div class="attendance-card-detail-item">
            <span class="attendance-card-label">Worked Hours</span>
            <span class="attendance-card-value">${workedHours}</span>
          </div>
          <div class="attendance-card-detail-item">
            <span class="attendance-card-label">Punctuality</span>
            <span class="attendance-card-value">${punctuality}</span>
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = cardsHtml;
}

// ‚úÖ IMPROVED: Find attendance record dengan better matching
function findAttendanceRecord(attendanceData, staffName) {
  if (!attendanceData || !staffName) return null;
  
  const cleanStaffName = staffName.toLowerCase().trim();
  
  for (const uid in attendanceData) {
    const record = attendanceData[uid];
    if (!record.name) continue;
    
    const cleanRecordName = record.name.toLowerCase().trim();
    
    // Exact match
    if (cleanRecordName === cleanStaffName) {
      return record;
    }
    
    // Partial match (first word)
    const staffFirstWord = cleanStaffName.split(' ')[0];
    const recordFirstWord = cleanRecordName.split(' ')[0];
    
    if (staffFirstWord && recordFirstWord && staffFirstWord === recordFirstWord) {
      return record;
    }
  }
  
  return null;
}

// ‚úÖ NEW FUNCTION: Sync plates dengan nama baru
async function syncPlatesWithNewName(newName) {
  try {
    const platesSnapshot = await db.ref('plates').once('value');
    const plates = platesSnapshot.val() || {};
    
    const updates = {};
    let updatedPlatesCount = 0;
    
    // Cari semua plates yang registered oleh user ini
    Object.keys(plates).forEach(plate => {
      const vehicle = plates[plate];
      
      // Check jika plate ini belong kepada current user
      const isUserPlate = (
        vehicle.registeredBy === currentUser.email || 
        matchByNameVariations(vehicle.name, userName)
      );
      
      if (isUserPlate) {
        updates[`plates/${plate}/name`] = newName;
        updatedPlatesCount++;
      }
    });
    
    // Apply updates jika ada plates yang perlu diupdate
    if (updatedPlatesCount > 0) {
      await db.ref().update(updates);
      console.log(`‚úÖ Updated ${updatedPlatesCount} plates with new name: ${newName}`);
    }
    
    return updatedPlatesCount;
    
  } catch (err) {
    console.error('Error syncing plates:', err);
    throw err;
  }
}

// ‚úÖ NEW FUNCTION: Check dan sync plates jika out of sync
async function checkAndSyncPlates(currentUserName) {
  try {
    const platesSnapshot = await db.ref('plates').once('value');
    const plates = platesSnapshot.val() || {};
    
    let needsSync = false;
    const updates = {};
    
    Object.keys(plates).forEach(plate => {
      const vehicle = plates[plate];
      
      // Jika plate registered oleh user ini tapi nama tidak match
      if (vehicle.registeredBy === currentUser.email && 
          !matchByNameVariations(vehicle.name, currentUserName)) {
        updates[`plates/${plate}/name`] = currentUserName;
        needsSync = true;
      }
    });
    
    if (needsSync) {
      await db.ref().update(updates);
      console.log('‚úÖ Auto-synced plates with current profile name');
    }
    
  } catch (err) {
    console.error('Error checking plate sync:', err);
  }
}

async function ensureUserProfile() {
  const userRef = db.ref('users/' + currentUser.uid);
  
  try {
    const snapshot = await userRef.once('value');
    
    if (!snapshot.exists()) {
      const userNameFromEmail = extractNameFromEmail(currentUser.email);
      await userRef.set({
        email: currentUser.email,
        name: userNameFromEmail,
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString()
      });
      userName = userNameFromEmail;
      
      // ‚úÖ Auto-sync existing plates dengan nama baru
      await syncPlatesWithNewName(userNameFromEmail);
      
    } else {
      const userData = snapshot.val();
      userName = userData.name;
      await userRef.update({
        lastLogin: new Date().toISOString()
      });
      
      // ‚úÖ Check dan sync plates jika perlu
      await checkAndSyncPlates(userName);
    }
    
    document.getElementById('userRoleInfo').textContent = isAdmin ? 
      'You are logged in as Administrator' : `You are logged in as ${userName}`;
      
    document.getElementById('currentUserName').textContent = userName;
    
    const nameInput = document.getElementById('userNameInput');
    if (nameInput) {
      nameInput.value = userName;
    }
    
  } catch (err) {
    console.error('Error ensuring user profile:', err);
    userName = extractNameFromEmail(currentUser.email);
  }
}

async function updateUserName() {
  const nameInput = document.getElementById('userNameInput');
  let newName = nameInput.value.trim();
  
  if (!newName) {
    showSnackbar('‚ùå Please enter a valid name');
    return;
  }
  
  newName = newName
    .toLowerCase()
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
  
  showSpinner();
  try {
    const userRef = db.ref('users/' + currentUser.uid);
    
    // Update user profile
    await userRef.update({
      name: newName,
      updatedAt: new Date().toISOString()
    });
    
    // ‚úÖ AUTO-SYNC: Update semua plates yang belong kepada user ini
    const updatedPlatesCount = await syncPlatesWithNewName(newName);
    
    userName = newName;
    
    if (updatedPlatesCount > 0) {
      showSnackbar(`‚úÖ Name updated successfully - ${updatedPlatesCount} vehicle(s) updated too!`);
    } else {
      showSnackbar('‚úÖ Name updated successfully');
    }
    
    document.getElementById('userRoleInfo').textContent = isAdmin ? 
      'You are logged in as Administrator' : `You are logged in as ${userName}`;
    
    document.getElementById('currentUserName').textContent = userName;
      
  } catch (err) {
    showSnackbar('‚ùå Failed to update name: ' + err.message);
  } finally {
    hideSpinner();
  }
}

// ========== Existing Workday Helper Functions ==========
async function ensureWorkdaysLoadedOnce() {
  console.log("üîÑ Loading FRESH workday data...");
  showSpinner();
  try {
    const snap = await db.ref('settings/workdays').once('value');
    const freshData = snap.exists() ? (snap.val() || {}) : {};
    
    console.log("‚úÖ Fresh workday data loaded:", freshData);
    
    // ‚úÖ FIX: Completely reset cache
    workdaysCache = {};
    
    // Rebuild cache from fresh data
    Object.keys(freshData).forEach(iso => {
      const key = iso.slice(0, 7); // "YYYY-MM"
      if (!(key in workdaysCache)) workdaysCache[key] = {};
      workdaysCache[key][iso] = freshData[iso];
    });
    
    // ‚úÖ FIX: Mark months that exist in the date range but have no overrides
    // This prevents empty cache entries from causing unnecessary reloads
    const allMonthsInData = new Set();
    Object.keys(freshData).forEach(iso => {
      allMonthsInData.add(iso.slice(0, 7));
    });
    
    console.log("‚úÖ Months with data:", Array.from(allMonthsInData));
    
    workdaysFullSnapshot = freshData;
    
    console.log("‚úÖ Cache rebuilt:", workdaysCache);
    return freshData;
  } catch (err) {
    console.error('Failed to load settings/workdays:', err);
    showSnackbar('‚ùå Failed to load workday overrides.');
    workdaysFullSnapshot = {};
    return workdaysFullSnapshot;
  } finally {
    hideSpinner();
  }
}

async function loadWorkdaysRange(startISO, endISO) {
  console.log("üîÑ loadWorkdaysRange CALLED for:", startISO, "to", endISO);
  
  // ‚úÖ FIX: Always ensure workdaysCache is initialized
  if (!workdaysCache) {
    workdaysCache = {};
  }
  
  const s = startISO.split('-').map(x => parseInt(x, 10));
  const e = endISO.split('-').map(x => parseInt(x, 10));
  const startMonth = new Date(s[0], s[1] - 1, 1);
  const endMonth = new Date(e[0], e[1] - 1, 1);
  
  console.log("üìÖ Range months:", 
    `${startMonth.getFullYear()}-${startMonth.getMonth() + 1}`,
    "to", 
    `${endMonth.getFullYear()}-${endMonth.getMonth() + 1}`
  );

  // ‚úÖ FIX: Improved cache checking - detect EMPTY cache entries
  let needsRefresh = false;
  const cursor = new Date(startMonth);
  
  while (cursor <= endMonth) {
    const key = `${cursor.getFullYear()}-${pad(cursor.getMonth() + 1)}`;
    const cacheExists = key in workdaysCache;
    const cacheHasData = cacheExists && workdaysCache[key] && Object.keys(workdaysCache[key]).length > 0;
    
    console.log("üîç Checking cache for:", key, "exists:", cacheExists, "hasData:", cacheHasData);
    
    if (!cacheExists || !cacheHasData) {
      needsRefresh = true;
      console.log("üîÑ Need to refresh -", !cacheExists ? "missing" : "empty", "cache for:", key);
      break;
    }
    
    cursor.setMonth(cursor.getMonth() + 1);
  }

  if (needsRefresh) {
    console.log("üîÑ Refreshing workday data due to missing/empty cache...");
    await ensureWorkdaysLoadedOnce();
  } else {
    console.log("‚úÖ Using cached data - all months have data");
  }

  // ‚úÖ FIX: Build combined data from cache
  const combined = {};
  const combinedCursor = new Date(startMonth);
  
  while (combinedCursor <= endMonth) {
    const key = `${combinedCursor.getFullYear()}-${pad(combinedCursor.getMonth() + 1)}`;
    const map = workdaysCache[key] || {};
    
    console.log("üìÇ Adding to combined from cache:", key, "data:", map);
    Object.assign(combined, map);
    
    combinedCursor.setMonth(combinedCursor.getMonth() + 1);
  }

  console.log("‚úÖ FINAL Workday range data for", startISO, "to", endISO, ":", combined);
  return combined;
}

function setWorkdayInCache(iso, val) {
  const key = iso.slice(0, 7);
  
  if (!workdaysCache) workdaysCache = {};
  if (!(key in workdaysCache)) workdaysCache[key] = {};
  
  if (val === undefined || val === null) {
    delete workdaysCache[key][iso];
    if (workdaysFullSnapshot) delete workdaysFullSnapshot[iso];
  } else {
    workdaysCache[key][iso] = !!val;
    if (workdaysFullSnapshot) workdaysFullSnapshot[iso] = !!val;
  }
}

async function persistWorkdaysMap(map) {
  if (!map || Object.keys(map).length === 0) return;
  showSpinner();
  const updates = {};
  Object.keys(map).forEach(iso => {
    const val = map[iso];
    const path = `settings/workdays/${iso}`;
    updates[path] = (val === undefined) ? null : (val === null ? null : !!val);
  });
  try {
    await db.ref().update(updates);
    Object.keys(map).forEach(iso => {
      const v = map[iso];
      setWorkdayInCache(iso, (v === null ? undefined : v));
    });
  } catch (err) {
    console.error('Failed saving workdays:', err);
    throw err; // Re-throw untuk handle di caller
  } finally {
    hideSpinner();
  }
}

// ========== Sidebar toggle ==========
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  sb.classList.toggle('collapsed');
  document.getElementById('toggleBtn').textContent = sb.classList.contains('collapsed') ? '‚û°Ô∏è' : '‚¨ÖÔ∏è';
}

// ========== Auth & UI init ==========
let currentCalendarYear, currentCalendarMonth;
const ADMIN_EMAIL = 'yhlim3031@gmail.com';

firebase.auth().onAuthStateChanged(async user => {
  if (!user) return window.location.href = 'index.html';
  
  currentUser = user;
  isAdmin = (user.email === ADMIN_EMAIL);
  
  document.getElementById('userEmail').textContent = user.email;
  
  await ensureUserProfile();
  
  if (!isAdmin) {
    await loadUserPlates();
  }
  
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin ? 'block' : 'none';
  });
  
  // Add admin-user class to body jika admin
  if (isAdmin) {
    document.body.classList.add('admin-user');
  } else {
    document.body.classList.remove('admin-user');
  }
  
  // Show/hide sections based on user role
  if (isAdmin) {
    // Admin: Show User Management, hide Register Plate
    document.getElementById('nav-user-management').style.display = 'block';
    document.getElementById('nav-register').style.display = 'none';
    document.getElementById('register').style.display = 'none';
    
    // Show other admin sections
    ['daily', 'weekly', 'monthly', 'workday'].forEach(id => {
      const nav = document.getElementById('nav-' + id);
      if (nav) nav.style.display = 'block';
    });
  } else {
    // Regular user: Show Register Plate, hide User Management
    document.getElementById('nav-register').style.display = 'block';
    document.getElementById('nav-user-management').style.display = 'none';
    document.getElementById('user-management').style.display = 'none';
    
    // Hide admin sections
    ['daily', 'weekly', 'monthly', 'workday'].forEach(id => {
      const nav = document.getElementById('nav-' + id);
      if (nav) nav.style.display = 'none';
    });
  }
  
  initPickers();
  showSection('home');
});

// Load user's registered plates
async function loadUserPlates() {
  try {
    const snapshot = await db.ref('plates').once('value');
    const plates = snapshot.val() || {};
    
    userPlates = [];
    Object.keys(plates).forEach(plate => {
      const vehicle = plates[plate];
      if (vehicle.registeredBy === currentUser.email || 
          (vehicle.name && matchByNameVariations(vehicle.name, userName))) {
        userPlates.push({
          plate: plate,
          name: vehicle.name,
          jabatan: vehicle.jabatan,
          registeredBy: vehicle.registeredBy
        });
      }
    });
  } catch (err) {
    console.error('Error loading user plates:', err);
  }
}

function calculateWorkedHours(record) {
  let rawWorked = record.workedHours || record.workedhours || "";
  
  if (rawWorked) {
    rawWorked = String(rawWorked).replace(/\s*(hours?\s*)+$/i, "").trim();
    const m = rawWorked.match(/(\d+)\s*(?:hour|hours|h)?(?:[:\s,-]+)?\s*(\d+)?\s*(?:min|minutes|m)?/i);
    if (m) {
      const h = parseInt(m[1]) || 0;
      const min = parseInt(m[2]) || 0;
      const hourLabel = h === 1 ? "hour" : "hours";
      return `${h} ${hourLabel} ${min} min`;
    } else {
      return rawWorked;
    }
  }
  
  return "-";
}

// ========== ‚úÖ TAMBAH FUNCTION INI DI SINI ==========
function loadRegisteredVehicles() {
  console.log("Loading registered vehicles for:", currentUser?.email);
  
  const user = firebase.auth().currentUser;
  if (!user) {
    console.error("No user logged in");
    return;
  }
  
  // Show loading state
  const vehiclesList = document.getElementById('registeredVehicles');
  if (vehiclesList) {
    vehiclesList.innerHTML = '<p>Loading vehicles...</p>';
  }
  
  // Query vehicles dari Firebase
  db.ref('plates').once('value')
    .then((snapshot) => {
      const plates = snapshot.val() || {};
      const userVehicles = [];
      
      // Filter vehicles untuk user ini
      Object.keys(plates).forEach(plate => {
        const vehicle = plates[plate];
        if (vehicle.registeredBy === user.email || 
            (vehicle.name && matchByNameVariations(vehicle.name, userName))) {
          userVehicles.push({
            plate: plate,
            name: vehicle.name,
            jabatan: vehicle.jabatan,
            registeredAt: vehicle.registeredAt
          });
        }
      });
      
      // Display results
      if (!vehiclesList) return;
      
      if (userVehicles.length === 0) {
        vehiclesList.innerHTML = '<p>No vehicles registered.</p>';
        return;
      }
      
      vehiclesList.innerHTML = '';
      userVehicles.forEach(vehicle => {
        const registeredDate = vehicle.registeredAt ? 
          new Date(vehicle.registeredAt).toLocaleDateString() : 'Unknown';
        
        vehiclesList.innerHTML += `
          <div class="vehicle-item">
            <div>
              <h4>${vehicle.plate}</h4>
              <p class="small">Department: ${vehicle.jabatan || 'N/A'}</p>
            </div>
            <div class="vehicle-actions">
              <button onclick="deleteVehicle('${vehicle.plate}')" style="background:#ef4444; padding: 6px 12px; font-size: 12px;">Delete</button>
            </div>
          </div>
        `;
      });
    })
    .catch((error) => {
      console.error("Error loading vehicles:", error);
      if (vehiclesList) {
        vehiclesList.innerHTML = '<p>Error loading vehicles.</p>';
      }
    });
}

// show section helper
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.style.display = 'block';
  const nav = document.getElementById('nav-' + id);
  if (nav) nav.classList.add('active');
  
  // Close mobile menu when selecting a section
  const sidebar = document.getElementById('sidebar');
  const mobileOverlay = document.getElementById('mobileOverlay');
  if (sidebar && mobileOverlay) {
    sidebar.classList.remove('mobile-open');
    mobileOverlay.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  if (id === 'attendance') loadAttendanceByDate();
  if (id === 'daily') calculateDailyStatus();
  if (id === 'weekly') {
    const wk = document.getElementById('weekPicker');
    if (!wk.value) wk.value = new Date().toISOString().split('T')[0];
    calculateWeeklySummary();
  }
  if (id === 'monthly') calculateMonthlySummary();
  if (id === 'workday') {
    const now = new Date();
    
    // ‚úÖ FIX: Initialize calendar variables if undefined
    if (typeof currentCalendarYear === 'undefined' || typeof currentCalendarMonth === 'undefined') {
      currentCalendarYear = now.getFullYear();
      currentCalendarMonth = now.getMonth();
      console.log('üìÖ Initializing calendar variables:', currentCalendarYear, currentCalendarMonth);
    }
    
    console.log('üìÖ Workday - Rendering:', currentCalendarYear, currentCalendarMonth);
    renderCalendar(currentCalendarYear, currentCalendarMonth);
  }
  if (id === 'register') loadRegisteredVehicles();
  if (id === 'settings') loadUserSettings();
  if (id === 'user-management') loadUsers();

  if (id === 'user-settings') {
    console.log('Settings section loaded');
    // Populate current name jika perlu
    const nameInput = document.getElementById('userNameInput');
    if (nameInput && userName) {
      nameInput.value = userName;
    }
  }

}

// logout
function logout() {
  firebase.auth().signOut().then(() => location.href = 'index.html');
}

// ========== Enhanced Pagination Functions ==========
function updatePaginationControls() {
  const firstPageBtn = document.getElementById('firstPageBtn');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const lastPageBtn = document.getElementById('lastPageBtn');
  const paginationInfo = document.getElementById('paginationInfo');
  
  // Update button states
  firstPageBtn.disabled = currentAttendancePage <= 1;
  prevPageBtn.disabled = currentAttendancePage <= 1;
  nextPageBtn.disabled = currentAttendancePage >= totalAttendancePages;
  lastPageBtn.disabled = currentAttendancePage >= totalAttendancePages;
  
  // Update pagination info
  const startRecord = (currentAttendancePage - 1) * attendancePerPage + 1;
  const endRecord = Math.min(currentAttendancePage * attendancePerPage, totalAttendanceRecords);
  
  if (totalAttendanceRecords > 0) {
    paginationInfo.textContent = `Showing ${startRecord}-${endRecord} of ${totalAttendanceRecords} records`;
  } else {
    paginationInfo.textContent = 'No records found';
  }
}

function goToPage(page) {
  if (page < 1 || page > totalAttendancePages) return;
  currentAttendancePage = page;
  loadAttendanceByDate(false);
}

function goToPreviousPage() {
  if (currentAttendancePage > 1) {
    currentAttendancePage--;
    loadAttendanceByDate(false);
  }
}

function goToNextPage() {
  if (currentAttendancePage < totalAttendancePages) {
    currentAttendancePage++;
    loadAttendanceByDate(false);
  }
}

function goToLastPage() {
  if (currentAttendancePage < totalAttendancePages) {
    currentAttendancePage = totalAttendancePages;
    loadAttendanceByDate(false);
  }
}

// ========== Daily Status Pagination Functions ==========
function updateDailyPaginationControls() {
  // HANYA update bottom pagination (atas sudah dibuang)
  const firstPageBtnBottom = document.getElementById('dailyFirstPageBtnBottom');
  const prevPageBtnBottom = document.getElementById('dailyPrevPageBtnBottom');
  const nextPageBtnBottom = document.getElementById('dailyNextPageBtnBottom');
  const lastPageBtnBottom = document.getElementById('dailyLastPageBtnBottom');
  const paginationInfoBottom = document.getElementById('dailyPaginationInfoBottom');
  
  // Check jika element wujud sebelum update
  if (firstPageBtnBottom) {
    firstPageBtnBottom.disabled = currentDailyPage <= 1;
    prevPageBtnBottom.disabled = currentDailyPage <= 1;
    nextPageBtnBottom.disabled = currentDailyPage >= totalDailyPages;
    lastPageBtnBottom.disabled = currentDailyPage >= totalDailyPages;
  }
  
  // Update pagination info - BETULKAN "seconds" kepada "records"
  const startRecord = (currentDailyPage - 1) * dailyPerPage + 1;
  const endRecord = Math.min(currentDailyPage * dailyPerPage, totalDailyRecords);
  
  if (totalDailyRecords > 0) {
    if (paginationInfoBottom) {
      paginationInfoBottom.textContent = `Showing ${startRecord}-${endRecord} of ${totalDailyRecords} records`;
    }
  } else {
    if (paginationInfoBottom) {
      paginationInfoBottom.textContent = 'No records found';
    }
  }
}

function goToDailyPage(page) {
  if (page < 1 || page > totalDailyPages) return;
  currentDailyPage = page;
  displayDailyRecords();
  updateDailyPaginationControls();
}

function goToPreviousDailyPage() {
  if (currentDailyPage > 1) {
    currentDailyPage--;
    displayDailyRecords();
    updateDailyPaginationControls();
  }
}

function goToNextDailyPage() {
  if (currentDailyPage < totalDailyPages) {
    currentDailyPage++;
    displayDailyRecords();
    updateDailyPaginationControls();
  }
}

function goToLastDailyPage() {
  if (currentDailyPage < totalDailyPages) {
    currentDailyPage = totalDailyPages;
    displayDailyRecords();
    updateDailyPaginationControls();
  }
}

function displayDailyRecords() {
  const startIndex = (currentDailyPage - 1) * dailyPerPage;
  const endIndex = startIndex + dailyPerPage;
  const recordsToShow = allDailyRecords.slice(startIndex, endIndex);
  
  const dailyTable = document.getElementById('dailyStatusTable');
  
  if (recordsToShow.length === 0) {
    dailyTable.innerHTML = '<p style="text-align:center;padding:20px;">No records found.</p>';
    return;
  }
  
  let html = '<table class="data-table"><tr><th>Name</th><th>Department</th><th>Status</th></tr>';
  
  recordsToShow.forEach(record => {
    // ‚úÖ FIX: Guna label "-" untuk holiday (bukan "Holiday")
    let statusClass = '';
    let displayText = record.status;
    
    if (record.status === 'Present') {
      statusClass = 'status-present';
      displayText = 'Present';
    } else if (record.status === 'Absent') {
      statusClass = 'status-absent';
      displayText = 'Absent';
    } else {
      statusClass = 'status-holiday';
      displayText = '-'; // ‚úÖ GUNA "-" UNTUK HOLIDAY
    }
    
    html += `
      <tr>
        <td>${record.name}</td>
        <td>${record.jabatan}</td>
        <td><span class="${statusClass}">${displayText}</span></td>
      </tr>`;
  });
  
  html += '</table>';
  dailyTable.innerHTML = html;
}

// ========== User Management Functions ==========

// ‚úÖ FIXED FUNCTION: Get user department from plates
function getUserDepartment(userEmail, userName) {
  if (!allPlatesData || Object.keys(allPlatesData).length === 0) return '-';
  
  // Cari semua plates yang belong kepada user ini
  const userPlates = Object.keys(allPlatesData).filter(plate => {
    const vehicle = allPlatesData[plate];
    return (
      vehicle.registeredBy === userEmail || 
      (vehicle.name && matchByNameVariations(vehicle.name, userName))
    );
  });
  
  // Ambil department dari plate pertama (jika ada)
  if (userPlates.length > 0) {
    const firstPlate = userPlates[0];
    return allPlatesData[firstPlate].jabatan || '-';
  }
  
  return '-';
}

async function loadUsers() {
  if (!isAdmin) return;
  
  showSpinner();
  try {
    // ‚úÖ FIX: Load plates data sekali untuk semua user
    const [usersSnapshot, platesSnapshot] = await Promise.all([
      db.ref('users').once('value'),
      db.ref('plates').once('value')
    ]);
    
    const users = usersSnapshot.val() || {};
    allPlatesData = platesSnapshot.val() || {}; // ‚úÖ STORE plates data globally
    
    // Convert to array and add user ID
    allUsers = Object.keys(users).map(uid => {
      return {
        id: uid,
        ...users[uid]
      };
    });
    
    // ‚úÖ FIX: Filter out admin user from the list
    allUsers = allUsers.filter(user => user.email !== ADMIN_EMAIL);
    
    totalUsers = allUsers.length;
    totalUserPages = Math.ceil(totalUsers / usersPerPage);
    
    displayUsers();
    updateUserPaginationControls();
    
  } catch (err) {
    console.error('Error loading users:', err);
    showSnackbar('‚ùå Failed to load users: ' + err.message);
  } finally {
    hideSpinner();
  }
}

function displayUsers() {
  const startIndex = (currentUserPage - 1) * usersPerPage;
  const endIndex = startIndex + usersPerPage;
  const usersToShow = allUsers.slice(startIndex, endIndex);
  
  const userTable = document.getElementById('userTable');
  
  if (usersToShow.length === 0) {
    userTable.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:12px;">No users found.</td></tr>';
    return;
  }
  
  let html = '';
  usersToShow.forEach(user => {
    const statusIcon = user.status === 'inactive' ? 'üî¥' : '‚úÖ';
    const statusClass = user.status === 'inactive' ? 'user-status-inactive' : 'user-status-active';
    
    // ‚úÖ FIX: Get department from user's plates
    const userDepartment = getUserDepartment(user.email, user.name);
    
    html += `
      <tr class="user-list-item" onclick="showUserDetail('${user.id}')">
        <td style="text-align:left;padding-left:8px;">${user.name || 'Unknown'}</td>
        <td>${userDepartment}</td>
        <td><span class="${statusClass}">${statusIcon} ${user.status === 'inactive' ? 'Inactive' : 'Active'}</span></td>
      </tr>
    `;
  });
  
  userTable.innerHTML = html;
}

function updateUserPaginationControls() {
  const firstPageBtn = document.getElementById('userFirstPageBtn');
  const prevPageBtn = document.getElementById('userPrevPageBtn');
  const nextPageBtn = document.getElementById('userNextPageBtn');
  const lastPageBtn = document.getElementById('userLastPageBtn');
  const paginationInfo = document.getElementById('userPaginationInfo');
  const paginationInfoBottom = document.getElementById('userPaginationInfoBottom');
  
  // Update button states
  firstPageBtn.disabled = currentUserPage <= 1;
  prevPageBtn.disabled = currentUserPage <= 1;
  nextPageBtn.disabled = currentUserPage >= totalUserPages;
  lastPageBtn.disabled = currentUserPage >= totalUserPages;
  
  // Update pagination info
  const startRecord = (currentUserPage - 1) * usersPerPage + 1;
  const endRecord = Math.min(currentUserPage * usersPerPage, totalUsers);
  
  if (totalUsers > 0) {
    paginationInfo.textContent = `Showing ${startRecord}-${endRecord} of ${totalUsers} users`;
    paginationInfoBottom.textContent = `Showing ${startRecord}-${endRecord} of ${totalUsers} users`;
  } else {
    paginationInfo.textContent = 'No users found';
    paginationInfoBottom.textContent = 'No users found';
  }
}

function goToUserPage(page) {
  if (page < 1 || page > totalUserPages) return;
  currentUserPage = page;
  displayUsers();
  updateUserPaginationControls();
}

function goToPreviousUserPage() {
  if (currentUserPage > 1) {
    currentUserPage--;
    displayUsers();
    updateUserPaginationControls();
  }
}

function goToNextUserPage() {
  if (currentUserPage < totalUserPages) {
    currentUserPage++;
    displayUsers();
    updateUserPaginationControls();
  }
}

function goToLastUserPage() {
  if (currentUserPage < totalUserPages) {
    currentUserPage = totalUserPages;
    displayUsers();
    updateUserPaginationControls();
  }
}

function filterUsers() {
  const searchTerm = document.getElementById('searchUser').value.toLowerCase();
  const departmentFilter = document.getElementById('userDepartmentFilter').value;
  
  let filteredUsers = allUsers;
  
  // Apply department filter
  if (departmentFilter) {
    filteredUsers = filteredUsers.filter(user => {
      const userDepartment = getUserDepartment(user.email, user.name);
      return userDepartment === departmentFilter;
    });
  }
  
  // Apply search filter
  if (searchTerm) {
    filteredUsers = filteredUsers.filter(user => 
      (user.name && user.name.toLowerCase().includes(searchTerm)) ||
      (user.email && user.email.toLowerCase().includes(searchTerm)) ||
      (user.jabatan && user.jabatan.toLowerCase().includes(searchTerm))
    );
  }
  
  const startIndex = (currentUserPage - 1) * usersPerPage;
  const endIndex = startIndex + usersPerPage;
  const usersToShow = filteredUsers.slice(startIndex, endIndex);
  
  const userTable = document.getElementById('userTable');
  
  if (usersToShow.length === 0) {
    userTable.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:12px;">No matching users found.</td></tr>';
    return;
  }
  
  let html = '';
  usersToShow.forEach(user => {
    const statusIcon = user.status === 'inactive' ? 'üî¥' : '‚úÖ';
    const statusClass = user.status === 'inactive' ? 'user-status-inactive' : 'user-status-active';
    
    // ‚úÖ FIX: Get department from user's plates
    const userDepartment = getUserDepartment(user.email, user.name);
    
    html += `
      <tr class="user-list-item" onclick="showUserDetail('${user.id}')">
        <td style="text-align:left;padding-left:8px;">${user.name || 'Unknown'}</td>
        <td>${userDepartment}</td>
        <td><span class="${statusClass}">${statusIcon} ${user.status === 'inactive' ? 'Inactive' : 'Active'}</span></td>
      </tr>
    `;
  });
  
  userTable.innerHTML = html;
}

async function showUserDetail(userId) {
  if (!isAdmin) return;
  
  showSpinner();
  try {
    const userSnapshot = await db.ref('users/' + userId).once('value');
    const user = userSnapshot.val();
    
    if (!user) {
      showSnackbar('‚ùå User not found');
      return;
    }
    
    currentEditingUser = {
      id: userId,
      ...user
    };
    
    // Load user's vehicles
    const platesSnapshot = await db.ref('plates').once('value');
    const allPlates = platesSnapshot.val() || {};
    const userVehicles = [];
    
    Object.keys(allPlates).forEach(plate => {
      const vehicle = allPlates[plate];
      if (vehicle.registeredBy === user.email || 
          (vehicle.name && matchByNameVariations(vehicle.name, user.name))) {
        userVehicles.push({
          plate: plate,
          name: vehicle.name,
          jabatan: vehicle.jabatan
        });
      }
    });
    
    // Load user's RFID
    let userRFID = '';
    const rfidSnapshot = await db.ref('rfid_cards').once('value');
    const rfidCards = rfidSnapshot.val() || {};
    
    Object.keys(rfidCards).forEach(rfid => {
      const card = rfidCards[rfid];
      if (card.user_id === userId) {
        userRFID = rfid;
      }
    });
    
    // ‚úÖ FIX: Get user's department from their plates
    let userDepartment = '-';
    if (userVehicles.length > 0) {
      // Use the department from the first vehicle
      userDepartment = userVehicles[0].jabatan;
    }
    
    // Populate user detail form
    document.getElementById('userDetailTitle').textContent = `User Profile: ${user.name}`;
    document.getElementById('userDetailName').value = user.name || '';
    document.getElementById('userDetailDepartment').value = userDepartment;
    document.getElementById('userDetailEmail').value = user.email || '';
    document.getElementById('userDetailRFID').value = userRFID || '';
    
    // Update toggle button text
    const toggleBtn = document.getElementById('toggleUserStatusBtn');
    toggleBtn.textContent = user.status === 'inactive' ? 'Activate User' : 'Deactivate User';
    
    // Display user vehicles
    const vehiclesList = document.getElementById('userVehiclesList');
    if (userVehicles.length === 0) {
      vehiclesList.innerHTML = '<p>No vehicles registered for this user.</p>';
    } else {
      let vehiclesHtml = '<table class="data-table"><tr><th>Plate</th><th>Department</th><th>Actions</th></tr>';
      userVehicles.forEach(vehicle => {
        vehiclesHtml += `
          <tr>
            <td>${vehicle.plate}</td>
            <td>${vehicle.jabatan}</td>
            <td>
              <button onclick="deleteUserVehicle('${vehicle.plate}')" style="padding:4px 8px;font-size:12px;">Delete</button>
            </td>
          </tr>
        `;
      });
      vehiclesHtml += '</table>';
      vehiclesList.innerHTML = vehiclesHtml;
    }
    
    showSection('user-detail');
    
  } catch (err) {
    console.error('Error loading user detail:', err);
    showSnackbar('‚ùå Failed to load user details: ' + err.message);
  } finally {
    hideSpinner();
  }
}

async function saveUserRFID() {
  if (!isAdmin || !currentEditingUser) return;
  
  const rfidInput = document.getElementById('userDetailRFID');
  const rfidValue = rfidInput.value.trim().toUpperCase();
  
  if (!rfidValue) {
    showSnackbar('‚ùå Please enter an RFID UID');
    return;
  }
  
  // Validate RFID format (hexadecimal, 8 characters)
  const hexRegex = /^[0-9A-F]{8}$/;
  if (!hexRegex.test(rfidValue)) {
    showSnackbar('‚ùå RFID must be 8 hexadecimal characters (e.g., E4F77C05)');
    return;
  }
  
  showSpinner();
  try {
    // Check if RFID is already assigned to another user
    const rfidSnapshot = await db.ref('rfid_cards/' + rfidValue).once('value');
    if (rfidSnapshot.exists() && rfidSnapshot.val().user_id !== currentEditingUser.id) {
      showSnackbar('‚ùå This RFID is already assigned to another user');
      hideSpinner();
      return;
    }
    
    // Remove any existing RFID for this user
    const allRfidSnapshot = await db.ref('rfid_cards').once('value');
    const allRfid = allRfidSnapshot.val() || {};
    
    const updates = {};
    
    // Remove any existing RFID for this user
    Object.keys(allRfid).forEach(rfid => {
      if (allRfid[rfid].user_id === currentEditingUser.id) {
        updates[`rfid_cards/${rfid}`] = null;
      }
    });
    
    // Add new RFID
    updates[`rfid_cards/${rfidValue}`] = {
      user_id: currentEditingUser.id,
      assigned_by: currentUser.email,
      assigned_at: new Date().toISOString(),
      status: 'active'
    };
    
    // Update lookup table
    updates[`rfid_to_user/${rfidValue}`] = currentEditingUser.id;
    
    await db.ref().update(updates);
    
    showSnackbar('‚úÖ RFID saved successfully');
    
  } catch (err) {
    console.error('Error saving RFID:', err);
    showSnackbar('‚ùå Failed to save RFID: ' + err.message);
  } finally {
    hideSpinner();
  }
}

async function toggleUserStatus() {
  if (!isAdmin || !currentEditingUser) return;
  
  const newStatus = currentEditingUser.status === 'inactive' ? 'active' : 'inactive';
  const confirmMessage = newStatus === 'inactive' 
    ? `Are you sure you want to deactivate ${currentEditingUser.name}?` 
    : `Are you sure you want to activate ${currentEditingUser.name}?`;
  
  if (!confirm(confirmMessage)) return;
  
  showSpinner();
  try {
    await db.ref(`users/${currentEditingUser.id}/status`).set(newStatus);
    
    showSnackbar(`‚úÖ User ${newStatus === 'inactive' ? 'deactivated' : 'activated'} successfully`);
    
    // Reload user detail
    showUserDetail(currentEditingUser.id);
    
  } catch (err) {
    console.error('Error toggling user status:', err);
    showSnackbar('‚ùå Failed to update user status: ' + err.message);
  } finally {
    hideSpinner();
  }
}

async function deleteUserVehicle(plate) {
  if (!isAdmin || !currentEditingUser) return;
  
  if (!confirm(`Are you sure you want to delete plate ${plate}?`)) return;
  
  showSpinner();
  try {
    await db.ref('plates/' + plate).remove();
    
    showSnackbar(`‚úÖ Plate ${plate} deleted successfully`);
    
    // Reload user detail
    showUserDetail(currentEditingUser.id);
    
  } catch (err) {
    console.error('Error deleting vehicle:', err);
    showSnackbar('‚ùå Failed to delete vehicle: ' + err.message);
  } finally {
    hideSpinner();
  }
}

// ========== MISSING FUNCTIONS ==========

// Filter vehicles function
function filterVehicles() {
  const searchTerm = document.getElementById('searchVehicles').value.toLowerCase();
  const vehicleItems = document.querySelectorAll('.vehicle-item');
  
  vehicleItems.forEach(item => {
    const text = item.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

// Delete vehicle function
function deleteVehicle(plate) {
  if (!confirm(`Are you sure you want to delete vehicle ${plate}?`)) return;
  
  showSpinner();
  db.ref('plates/' + plate).remove()
    .then(() => {
      showSnackbar('Vehicle deleted successfully');
      loadRegisteredVehicles();
    })
    .catch(error => {
      showSnackbar('Error deleting vehicle: ' + error.message);
    })
    .finally(() => {
      hideSpinner();
    });
}

// Register plate function
function registerPlate() {
  const plateInput = document.getElementById('regPlate');
  const jabatanSelect = document.getElementById('regJawatan');
  
  const plate = plateInput.value.trim().toUpperCase();
  const jabatan = jabatanSelect.value;
  
  if (!plate) {
    showSnackbar('‚ùå Please enter a plate number');
    return;
  }
  
  if (!jabatan) {
    showSnackbar('‚ùå Please select a department');
    return;
  }
  
  showSpinner();
  
  const plateData = {
    name: userName,
    jabatan: jabatan,
    registeredBy: currentUser.email,
    registeredAt: new Date().toISOString()
  };
  
  db.ref('plates/' + plate).set(plateData)
    .then(() => {
      showSnackbar('‚úÖ Vehicle registered successfully');
      plateInput.value = '';
      jabatanSelect.value = '';
      loadRegisteredVehicles();
    })
    .catch(error => {
      showSnackbar('‚ùå Error registering vehicle: ' + error.message);
    })
    .finally(() => {
      hideSpinner();
    });
}

// Load user settings function
function loadUserSettings() {
  // Populate the name input with current user name
  const nameInput = document.getElementById('userNameInput');
  if (nameInput && userName) {
    nameInput.value = userName;
  }
  
  console.log('Settings loaded for user:', userName);
}

// Filter daily table function
function filterDailyTable() {
  const searchTerm = document.getElementById('searchDaily').value.toLowerCase();
  const rows = document.querySelectorAll('#dailyStatusTable tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// ‚úÖ COMPLETE FIXED VERSION dengan card layout untuk mobile users
async function loadAttendanceByDate(resetPage = true) {
  console.log("üîÑ loadAttendanceByDate() called");
  
  if (resetPage) {
    currentAttendancePage = 1;
  }
  
  const date = document.getElementById("datePicker").value;
  const jabatanFilter = document.getElementById("jabatanFilter").value;
  const table = document.getElementById("attendanceTable");
  const cardsContainer = document.getElementById("attendanceCardsContainer");

  if (!date) {
    table.innerHTML = "<tr><td colspan='8' style='text-align:center;padding:12px;'>Please select a date.</td></tr>";
    cardsContainer.innerHTML = '<div class="no-attendance-cards">Please select a date.</div>';
    return;
  }

  showSpinner();

  try {
    // Add debug logging to see what's happening
    console.log("üì° Loading FRESH data for:", date);

    // Load BOTH attendance data, plates data, DAN workdays data
    const [attendanceSnap, platesSnap, workdaysData] = await Promise.all([
      db.ref("attendance/" + date).once("value"),
      db.ref("plates").once("value"),
      loadWorkdaysRange(date, date)
    ]);

    const attendanceData = attendanceSnap.exists() ? attendanceSnap.val() : {};
    const platesData = platesSnap.val() || {};
    
    // Check workday status
    const selectedDate = new Date(date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    selectedDate.setHours(0, 0, 0, 0);
    
    const isToday = selectedDate.getTime() === today.getTime();
    const isFuture = selectedDate > today;
    const isWorkday = date in workdaysData ? !!workdaysData[date] : isDefaultWorkdayISO(date);

    // Use Map to avoid duplicate names
    const uniqueStaffMap = new Map();
    
    // Process plates data to get staff list without duplicates
    Object.values(platesData).forEach(staff => {
      const staffName = staff.name || "-";
      const staffJabatan = staff.jabatan || "-";
      
      // Filter by department if admin
      if (isAdmin && jabatanFilter && staffJabatan !== jabatanFilter) return;
      
      // Filter by user if not admin
      if (!isAdmin && !matchByNameVariations(staffName, userName)) return;
      
      // Use Map to avoid duplicate names
      if (!uniqueStaffMap.has(staffName)) {
        uniqueStaffMap.set(staffName, {
          name: staffName,
          jabatan: staffJabatan,
          plates: []
        });
      }
    });

    // If regular user has no plates, add user
    if (!isAdmin && uniqueStaffMap.size === 0) {
      uniqueStaffMap.set(userName, {
        name: userName,
        jabatan: 'Unknown',
        plates: []
      });
    }

    let allRows = [];
    let allCards = [];

    // Process each staff from unique list
    uniqueStaffMap.forEach((staff, staffName) => {
      // Find attendance record for this staff
      const attendanceRecord = findAttendanceRecord(attendanceData, staffName);
      
      let shift = "-";
      let status = "-";
      let checkin = "-";
      let checkout = "-";
      let workedHours = "-";
      let punctuality = "-";

      // If attendance record exists, use that data
      if (attendanceRecord) {
        shift = attendanceRecord.shift || "-";
        status = attendanceRecord.status || "Present";
        checkin = attendanceRecord.checkin || "-";
        checkout = attendanceRecord.checkout || "-";
        workedHours = calculateWorkedHours(attendanceRecord);
        punctuality = attendanceRecord.punctuality || "-";
      } else {
        // If NO attendance record, check workday status
        if (!isWorkday) {
          status = "-";
        } else if (isFuture) {
          status = "-";
        } else {
          status = "Absent";
        }
      }

      // Apply color coding
      const statusColor = getStatusColor(status);
      const punctualityColor = getPunctualityColor(punctuality);

      // For table rows
      allRows.push(`
        <tr>
          <td>${staffName}</td>
          <td class="${isAdmin ? '' : 'admin-only'} mobile-hidden">${staff.jabatan}</td>
          <td>${shift}</td>
          <td style="${statusColor}">${status}</td>
          <td>${checkin}</td>
          <td class="mobile-hidden">${checkout}</td>
          <td class="mobile-hidden">${workedHours}</td>
          <td class="mobile-hidden" style="${punctualityColor}">${punctuality}</td>
        </tr>`);
        
      // For card layout
      allCards.push({
        name: staffName,
        jabatan: staff.jabatan,
        shift: shift,
        status: status,
        checkin: checkin,
        checkout: checkout,
        workedHours: workedHours,
        punctuality: punctuality
      });
    });

    // ‚úÖ THIS IS THE MISSING PAGINATION CODE:
    // Handle pagination and display data
    if (isAdmin) {
      totalAttendanceRecords = allRows.length;
      totalAttendancePages = Math.ceil(totalAttendanceRecords / attendancePerPage);
      const startIndex = (currentAttendancePage - 1) * attendancePerPage;
      const endIndex = startIndex + attendancePerPage;
      const pageRows = allRows.slice(startIndex, endIndex);
      
      table.innerHTML = pageRows.join('') || "<tr><td colspan='8' style='text-align:center;padding:12px;'>No staff found.</td></tr>";
      
      updatePaginationControls();
      // Render cards untuk mobile users
      renderAttendanceCards(allCards);
    } else {
      table.innerHTML = allRows.join('') || "<tr><td colspan='8' style='text-align:center;padding:12px;'>No attendance records found.</td></tr>";
    }

  } catch (err) {
    console.error("Firebase error:", err);
    table.innerHTML = "<tr><td colspan='8' style='text-align:center;padding:12px;'>Firebase connection error.</td></tr>";
    cardsContainer.innerHTML = '<div class="no-attendance-cards">Firebase connection error.</div>';
  } finally {
    hideSpinner();
  }
}

// Filter attendance table
function filterAttendanceTable() {
  const searchTerm = document.getElementById('searchAttendance').value.toLowerCase();
  const rows = document.querySelectorAll('#attendanceTable tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// Export attendance data
function exportAttendanceData() {
  const date = document.getElementById("datePicker").value;
  if (!date) {
    showSnackbar('Please select a date first');
    return;
  }
  
  let csvContent = "Name,Department,Shift,Status,Checkin,Checkout,Worked Hours,Punctuality\n";
  
  const rows = document.querySelectorAll('#attendanceTable tr');
  rows.forEach(row => {
    if (row.style.display !== 'none') {
      const cells = row.querySelectorAll('td');
      if (cells.length > 0) {
        const rowData = Array.from(cells).map(cell => {
          let text = cell.textContent.trim();
          if (text.includes(',') || text.includes('"') || text.includes('\n')) {
            text = '"' + text.replace(/"/g, '""') + '"';
          }
          return text;
        });
        csvContent += rowData.join(',') + '\n';
      }
    }
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", `attendance_${date}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showSnackbar('Data exported successfully');
}

// ========== Daily Status - SUPER SIMPLE FIX ==========
async function calculateDailyStatus() {
  showSpinner();
  try {
    const targetDate = todayISO();
    const filterJabatan = document.getElementById('jabatanFilterDaily') ? document.getElementById('jabatanFilterDaily').value : '';
    
    console.log('üîç DAILY START - Date:', targetDate);
    
    // ‚úÖ LOAD DATA SAMA SEPERTI ATTENDANCE
    const [platesSnap, attendanceSnap] = await Promise.all([
      db.ref('plates').once('value'),
      db.ref('attendance/' + targetDate).once('value')
    ]);

    const allPlates = platesSnap.val() || {};
    const attendanceData = attendanceSnap.exists() ? attendanceSnap.val() : {};
    
    // ‚úÖ DIRECT CHECK WORKDAY - CARA MUDAH
    await ensureWorkdaysLoadedOnce();
    
    let isWorkday;
    if (workdaysFullSnapshot && targetDate in workdaysFullSnapshot) {
      isWorkday = workdaysFullSnapshot[targetDate];
      console.log('‚úÖ DAILY: Workday Manager setting =', isWorkday);
    } else {
      isWorkday = isDefaultWorkdayISO(targetDate);
      console.log('‚úÖ DAILY: Default setting =', isWorkday);
    }

    console.log('üîç DAILY FINAL - isWorkday:', isWorkday, 'Workday Data:', workdaysFullSnapshot);

    // Reset pagination
    currentDailyPage = 1;
    allDailyRecords = [];
    const uniqueStaffMap = new Map();

    if (isAdmin) {
      Object.values(allPlates).forEach(staff => {
        const staffName = staff.name || "-";
        const staffJabatan = staff.jabatan || "-";
        
        if (!staffName || staffName === "-") return;
        if (filterJabatan && staffJabatan !== filterJabatan) return;
        
        if (!uniqueStaffMap.has(staffName)) {
          const attendanceRecord = findAttendanceRecord(attendanceData, staffName);
          
          let status = "-";
          if (isWorkday) {
            status = attendanceRecord ? "Present" : "Absent";
          }
          
          uniqueStaffMap.set(staffName, {
            name: staffName,
            jabatan: staffJabatan,
            status: status
          });
        }
      });

      allDailyRecords = Array.from(uniqueStaffMap.values());
      
    } else {
      // Untuk user biasa
      Object.values(allPlates).forEach(staff => {
        const staffName = staff.name || "-";
        const staffJabatan = staff.jabatan || "-";
        
        if (matchByNameVariations(staffName, userName)) {
          const attendanceRecord = findAttendanceRecord(attendanceData, staffName);
          
          let status = "-";
          if (isWorkday) {
            status = attendanceRecord ? "Present" : "Absent";
          }
          
          allDailyRecords.push({
            name: staffName,
            jabatan: staffJabatan,
            status: status
          });
        }
      });
      
      if (allDailyRecords.length === 0) {
        const attendanceRecord = findAttendanceRecord(attendanceData, userName);
        
        let status = "-";
        if (isWorkday) {
          status = attendanceRecord ? "Present" : "Absent";
        }
        
        allDailyRecords.push({
          name: userName,
          jabatan: 'Unknown',
          status: status
        });
      }
    }

    // Update dan display
    totalDailyRecords = allDailyRecords.length;
    totalDailyPages = Math.ceil(totalDailyRecords / dailyPerPage);
    displayDailyRecords();
    updateDailyPaginationControls();

    // Show date info
    const dateDisplay = new Date().toLocaleDateString('en-MY', {
      weekday: 'long',
      day: 'numeric', 
      month: 'long', 
      year: 'numeric'
    });
    
    let dateInfoElement = document.getElementById('dailyDateInfo');
    if (!dateInfoElement) {
      dateInfoElement = document.createElement('div');
      dateInfoElement.id = 'dailyDateInfo';
      dateInfoElement.className = 'daily-date-info';
      
      const dailyTable = document.getElementById('dailyStatusTable');
      dailyTable.parentNode.insertBefore(dateInfoElement, dailyTable);
    }
    
    const workdayStatus = isWorkday ? 
      '<span style="color:#10b981;margin-left:8px;">(Workday)</span>' : 
      '<span style="color:#6b7280;margin-left:8px;">(Non-Workday)</span>';
    
    dateInfoElement.innerHTML = `<strong>üìÖ Today: ${dateDisplay}</strong> ${workdayStatus}`;

    console.log('‚úÖ DAILY COMPLETED SUCCESSFULLY');

  } catch (err) {
    console.error('‚ùå DAILY ERROR:', err);
    showSnackbar('‚ùå Failed to load daily status: ' + err.message);
  } finally {
    hideSpinner();
  }
}

// ========== Weekly Summary - DEBUG VERSION ==========
async function calculateWeeklySummary() {
  showSpinner();
  try {
    const pick = document.getElementById('weekPicker').value || todayISO();
    const base = new Date(pick);
    const day = base.getDay();
    const diffToMonday = (day === 0) ? -6 : (1 - day);
    const monday = new Date(base);
    monday.setDate(base.getDate() + diffToMonday);

    const dates = Array.from({ length: 7 }, (_, i) => {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      return ymdFromDate(d);
    });

    console.log('üìÖ DATES FOR WEEK:', dates);
    
    const workdaysMap = await loadWorkdaysRange(dates[0], dates[dates.length - 1]);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    console.log('üóìÔ∏è WORKDAYS MAP:', workdaysMap);
    console.log('üïí TODAY:', todayISO());

    // Load data
    const [attendanceSnaps, platesSnap] = await Promise.all([
      Promise.all(dates.map(dt => db.ref('attendance/' + dt).once('value'))),
      db.ref('plates').once('value')
    ]);

    const plates = platesSnap.val() || {};
    const filterJabatan = document.getElementById('weekJabatanFilter')?.value || '';

    console.log('üë• TOTAL PLATES:', Object.keys(plates).length);
    console.log('üîç FILTER DEPARTMENT:', filterJabatan);

    // Process attendance data
    const attendanceByDate = {};
    attendanceSnaps.forEach((snap, idx) => {
      const dt = dates[idx];
      attendanceByDate[dt] = {};
      if (snap.exists()) {
        snap.forEach(r => {
          const v = r.val();
          const name = v.name || 'Unknown';
          attendanceByDate[dt][name] = v;
        });
      }
      console.log(`üìä ${dt} - Attendance records:`, Object.keys(attendanceByDate[dt]).length);
    });

    const namesSet = new Set();
    
    if (isAdmin) {
      Object.values(plates).forEach(p => {
        const name = p.name || 'Unknown';
        const jab = p.jabatan || '';
        if (filterJabatan && jab !== filterJabatan) return;
        namesSet.add(name);
      });
    } else {
      Object.values(plates).forEach(p => {
        const name = p.name || 'Unknown';
        if (matchByNameVariations(name, userName)) {
          namesSet.add(name);
        }
      });
      if (namesSet.size === 0) {
        namesSet.add(userName);
      }
    }

    console.log('üë§ NAMES TO PROCESS:', Array.from(namesSet));

    const stats = {};
    const perDayTotals = dates.map(() => ({ present: 0, late: 0, absent: 0 }));

    // DEBUG: Log workday status for each date
    dates.forEach((dt, i) => {
      const dtObj = new Date(dt);
      dtObj.setHours(0, 0, 0, 0);
      const isWork = dt in workdaysMap ? !!workdaysMap[dt] : isDefaultWorkdayISO(dt);
      const isFuture = dtObj > today;
      console.log(`üìÜ ${dt} - Workday: ${isWork}, Future: ${isFuture}, Default: ${isDefaultWorkdayISO(dt)}`);
    });

    namesSet.forEach(name => {
      stats[name] = { t: 0, p: 0, l: 0, dayStatus: Array(dates.length).fill('') };
      
      dates.forEach((dt, i) => {
        const dtObj = new Date(dt);
        dtObj.setHours(0, 0, 0, 0);
        
        let isWork = dt in workdaysMap ? !!workdaysMap[dt] : isDefaultWorkdayISO(dt);
        const isFuture = dtObj > today;
        
        console.log(`üîç ${name} - ${dt}: Workday=${isWork}, Future=${isFuture}`);
        
        // Future dates atau non-workday - show '-'
        if (isFuture || !isWork) {
          stats[name].dayStatus[i] = '-';
          console.log(`   ${name} - ${dt}: Show '-' (Future or Non-workday)`);
          return;
        }
        
        // Process workdays that have passed
        const rec = attendanceByDate[dt] && attendanceByDate[dt][name];
        let status = 'A'; // Default to Absent for workdays with no data
        
        if (rec && rec.checkin) {
          if (rec.status && rec.status.toLowerCase().includes('late')) {
            status = 'L';
            console.log(`   ${name} - ${dt}: Show 'L' (Late)`);
          } else if (rec.punctuality && rec.punctuality.toLowerCase().includes('late')) {
            status = 'L';
            console.log(`   ${name} - ${dt}: Show 'L' (Late from punctuality)`);
          } else {
            status = 'P';
            console.log(`   ${name} - ${dt}: Show 'P' (Present)`);
          }
        } else {
          console.log(`   ${name} - ${dt}: Show 'A' (Absent - No record)`);
        }
        
        stats[name].dayStatus[i] = status;

        // Update counters for charts
        if (isWork && !isFuture) {
          stats[name].t++;
          if (status === 'P') {
            stats[name].p++;
            perDayTotals[i].present++;
          } else if (status === 'L') {
            stats[name].l++;
            perDayTotals[i].late++;
          } else if (status === 'A') {
            perDayTotals[i].absent++;
          }
        }
      });
    });

    console.log('üìà PER DAY TOTALS:', perDayTotals);
    console.log('üë§ STAFF STATS:', stats);

    // Rest of the function remains the same...
    if (isAdmin) {
      const rows = Object.entries(stats).map(([name, st]) => {
        const perc = st.t ? ((st.p + st.l) / st.t * 100).toFixed(1) : '0.0';
        return {
          name,
          t: st.t,
          p: st.p,
          l: st.l,
          absent: st.t - st.p - st.l,
          perc,
          dayStatus: st.dayStatus
        };
      }).sort((a, b) => (b.perc === 'N/A' ? 0 : parseFloat(b.perc)) - (a.perc === 'N/A' ? 0 : parseFloat(a.perc)));

      console.log('üìä FINAL ROWS:', rows);

      const totalPresent = rows.reduce((sum, row) => sum + row.p, 0);
      const totalLate = rows.reduce((sum, row) => sum + row.l, 0);
      const totalAbsent = rows.reduce((sum, row) => sum + row.absent, 0);
      const totalStaff = rows.length;
      const totalWorkdays = rows.reduce((sum, row) => sum + row.t, 0);
      const attendanceRate = totalWorkdays > 0 ? ((totalPresent + totalLate) / totalWorkdays * 100).toFixed(1) : 0;
      
      console.log('üìà FINAL TOTALS:', { totalPresent, totalLate, totalAbsent, totalStaff, totalWorkdays, attendanceRate });

      let tblHtml = `
      <div class="summary-cards">
        <div class="summary-card" style="background: #10b981;">
          <div class="number">${totalPresent}</div>
          <div class="label">Present On Time</div>
        </div>
        <div class="summary-card" style="background: #f59e0b;">
          <div class="number">${totalLate}</div>
          <div class="label">Present Late</div>
        </div>
        <div class="summary-card" style="background: #ef4444;">
          <div class="number">${totalAbsent}</div>
          <div class="label">Absent</div>
        </div>
        <div class="summary-card" style="background: #3b82f6;">
          <div class="number">${totalStaff}</div>
          <div class="label">Total Staff</div>
        </div>
      </div>

      <table class="mini-table">
        <tr><th>Department</th><td>${filterJabatan || "All Departments"}</td></tr>
        <tr><th>Period</th><td>${dates[0]} to ${dates[6]}</td></tr>
        <tr><th>Attendance Rate</th><td>${attendanceRate}%</td></tr>
      </table>`;
      
      document.getElementById("weeklySummaryTable").innerHTML = tblHtml;

      // ‚úÖ FIXED CHART CODE - TAMBAH KURUNGAN TERTUTUP
      const labels = dates.map(date => {
        const d = new Date(date);
        return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}`;
      });
      
      const presentData = [], lateData = [], absentData = [];
      for (let i = 0; i < dates.length; i++) {
        const dt = dates[i];
        const dtObj = new Date(dt);
        dtObj.setHours(0, 0, 0, 0);
        const isWork = dt in workdaysMap ? !!workdaysMap[dt] : isDefaultWorkdayISO(dt);

        if (!isWork || dtObj > today) {
          presentData.push(0);
          lateData.push(0);
          absentData.push(0);
        } else {
          presentData.push(perDayTotals[i].present);
          lateData.push(perDayTotals[i].late);
          absentData.push(perDayTotals[i].absent);
        }
      }
      
      console.log('üìä CHART DATA:', { presentData, lateData, absentData });
      
      const ctx = document.getElementById("weeklyChart").getContext('2d');
      if (weeklyChartInstance) weeklyChartInstance.destroy();

      const allData = [...presentData, ...lateData, ...absentData];
      const maxData = Math.max(...allData, 1); // Minimum 1
      const totalUsers = Object.keys(stats).length;

      // ‚úÖ FIXED: Kira maxY dengan cara yang lebih dinamik
      let maxY;
      if (totalUsers <= 5) {
        maxY = Math.max(maxData + 1, 3); // Untuk user sedikit
      } else if (totalUsers <= 10) {
        maxY = Math.max(maxData + 2, 5); // Untuk user sederhana
      } else {
        maxY = Math.max(maxData + 3, Math.ceil(totalUsers * 0.3)); // Untuk user banyak
      }

      // ‚úÖ FIXED: PASTIKAN maxY adalah integer
      maxY = Math.ceil(maxY);

      weeklyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Present', data: presentData, backgroundColor: '#10b981' },
            { label: 'Late', data: lateData, backgroundColor: '#f59e0b' },
            { label: 'Absent', data: absentData, backgroundColor: '#ef4444' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 12
                }
              }
            },
            title: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              min: 0,
              max: maxY,
              ticks: {
                stepSize: 1,
                precision: 0,
                font: { size: 11 },
                callback: function(value) {
                  return Number.isInteger(value) ? value : '';
                }
              }
            },
            x: {
              ticks: {
                font: { size: 11 }
              }
            }
          }
        }
      }); // ‚úÖ INI KURUNGAN TERTUTUP YANG HILANG

      console.log('üìä Weekly Chart Settings:', { 
        totalUsers, 
        maxData, 
        maxY,
        presentData,
        lateData, 
        absentData 
      });
    } // ‚úÖ TAMBAH INI - tutup if (isAdmin) untuk chart

    // Rest of the function for Staff Attendance Details...
    const rows = Object.entries(stats).map(([name, st]) => {
      const perc = st.t ? ((st.p + st.l) / st.t * 100).toFixed(1) : '0.0';
      return {
        name,
        t: st.t,
        p: st.p,
        l: st.l,
        absent: st.t - st.p - st.l,
        perc,
        dayStatus: st.dayStatus
      };
    }).sort((a, b) => (b.perc === 'N/A' ? 0 : parseFloat(b.perc)) - (a.perc === 'N/A' ? 0 : parseFloat(a.perc)));

    console.log('üë• FINAL STAFF DETAILS ROWS:', rows);

    let gridHtml = `
    <div style="overflow-x: auto;">
      <table class="data-table">
        <thead>
          <tr>
            <th style="text-align: left; min-width: 140px;">Name</th>`;

    dates.forEach(date => {
      const d = new Date(date);
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      gridHtml += `<th title="${date}" style="min-width: 50px;">${pad(d.getDate())}/${pad(d.getMonth() + 1)}<br><small style="font-size:11px;">${dayNames[d.getDay()]}</small></th>`;
    });

    gridHtml += `
            <th style="min-width: 70px;">Attendance %</th>
          </tr>
        </thead>
        <tbody>`;

    rows.forEach(r => {
      console.log(`üîÑ RENDERING: ${r.name} - Status: [${r.dayStatus.join(', ')}]`);
      
      gridHtml += `<tr><td style="text-align: left; font-weight: 500;">${r.name}</td>`;
      
      r.dayStatus.forEach((s, index) => {
        const dt = dates[index];
        const dtObj = new Date(dt);
        dtObj.setHours(0, 0, 0, 0);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let statusClass = '';
        let displayText = s;
        
        console.log(`   üìÖ ${dt}: Raw status='${s}', Today=${todayISO()}, IsFuture=${dtObj > today}`);
        
        // ‚úÖ FIX: Proper future date check
        if (dtObj > today) {
          statusClass = 'status-holiday';
          displayText = '-';
          console.log(`      ‚Üí Future date: Show '-'`);
        } else if (s === 'P') {
          statusClass = 'status-present';
          displayText = '‚úì';
          console.log(`      ‚Üí Present: Show '‚úì'`);
        } else if (s === 'L') {
          statusClass = 'status-late';
          displayText = '‚ö†';
          console.log(`      ‚Üí Late: Show '‚ö†'`);
        } else if (s === 'A') {
          statusClass = 'status-absent';
          displayText = '‚úó';
          console.log(`      ‚Üí Absent: Show '‚úó'`);
        } else if (s === '-') {
          statusClass = 'status-holiday';
          displayText = '-';
          console.log(`      ‚Üí Holiday: Show '-'`);
        } else {
          // Fallback - should not happen
          statusClass = 'status-holiday';
          displayText = '-';
          console.log(`      ‚Üí Unknown status '${s}': Show '-'`);
        }
        
        gridHtml += `<td><span class="${statusClass}">${displayText}</span></td>`;
      });
      
      gridHtml += `<td style="font-weight: 600; background: #f8fafc;">${r.perc}%</td></tr>`;
    });

    gridHtml += `</tbody></table></div>`;

    gridHtml += `
    <div style="display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; font-size: 12px;">
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="status-present" style="padding: 3px 5px;">‚úì</span>
        <span>Present On Time</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="status-late" style="padding: 3px 5px;">‚ö†</span>
        <span>Present Late</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="status-absent" style="padding: 3px 5px;">‚úó</span>
        <span>Absent</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="status-holiday" style="padding: 3px 5px;">-</span>
        <span>Holiday/Future</span>
      </div>
    </div>`;

    document.getElementById("weeklyDetailGrid").innerHTML = gridHtml;

  } catch (err) {
    console.error('‚ùå ERROR in calculateWeeklySummary:', err);
    showSnackbar('‚ùå Error building weekly report');
  } finally {
    hideSpinner();
  }
}

// Filter weekly table
function filterWeeklyTable() {
  const searchTerm = document.getElementById('searchWeekly').value.toLowerCase();
  const rows = document.querySelectorAll('#weeklyDetailGrid tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// ========== Monthly Summary ==========
async function calculateMonthlySummary() {
  showSpinner();
  try {
    const month = parseInt(document.getElementById('monthSelect').value, 10);
    const year = parseInt(document.getElementById('yearSelect').value, 10);
    const filterJabatan = document.getElementById('monthJabatanFilter') ? document.getElementById('monthJabatanFilter').value : '';
    const daysInMonth = new Date(year, month, 0).getDate();
    const dates = [];
    for (let d = 1; d <= daysInMonth; d++) dates.push(`${year}-${pad(month)}-${pad(d)}`);

    const workdaysMap = await loadWorkdaysRange(dates[0], dates[dates.length - 1]);
    const snaps = await Promise.all(dates.map(dt => db.ref('attendance/' + dt).once('value')));
    const platesSnap = await db.ref('plates').once('value');
    const plates = platesSnap.val() || {};
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const stats = {};
    const perDayTotals = dates.map(() => ({ present: 0, late: 0, absent: 0 }));

    const attendanceByDate = {};
    snaps.forEach((snap, idx) => {
      const dt = dates[idx];
      attendanceByDate[dt] = {};
      if (snap.exists()) {
        snap.forEach(r => {
          const v = r.val();
          const name = v.name || 'Unknown';
          attendanceByDate[dt][name] = v;
        });
      }
    });

const namesToProcess = isAdmin ?
            [...new Set(Object.values(plates)
                .filter(p => !filterJabatan || p.jabatan === filterJabatan)
                .map(p => p.name)
                .filter(name => name))] :
            [...new Set(Object.values(plates)
                .filter(p => matchByNameVariations(p.name, userName))
                .map(p => p.name)
                .filter(name => name))];
        
        if (!isAdmin && namesToProcess.length === 0) {
            namesToProcess.push(userName);
        }
    namesToProcess.forEach(name => {
      stats[name] = { totalWorkdays: 0, present: 0, late: 0, absent: 0, byDate: {} };
      dates.forEach((dt, idx) => {
        const dtObj = new Date(dt);
        dtObj.setHours(0, 0, 0, 0);
        if (dtObj > today) {
          stats[name].byDate[dt] = 'Future';
          return;
        }
        const isWork = (dt in workdaysMap) ? !!workdaysMap[dt] : isDefaultWorkdayISO(dt);
        if (!isWork) {
          stats[name].byDate[dt] = 'Holiday';
          return;
        }
        stats[name].totalWorkdays++;
        const recA = attendanceByDate[dt] && attendanceByDate[dt][name];
        let status = 'Absent';
        if (recA) {
          if (recA.status) status = recA.status;
          else if (recA.checkin) {
            const cMin = parseTimeToMinutes(recA.checkin);
            let shiftStart = '08:00';
            if (recA.shift && recA.shift.toUpperCase().includes('10')) shiftStart = '10:00';
            const sMin = parseTimeToMinutes(shiftStart);
            if (cMin !== null && sMin !== null) status = (cMin > sMin) ? 'Late' : 'Present';
            else status = 'Present';
          } else status = 'Absent';
        } else status = 'Absent';
        stats[name].byDate[dt] = status;
        if (status === 'Absent') stats[name].absent++;
        else if (status === 'Late') stats[name].late++;
        else stats[name].present++;
        if (status === 'Absent') perDayTotals[idx].absent++;
        else if (status === 'Late') perDayTotals[idx].late++;
        else if (status === 'Present') perDayTotals[idx].present++;
      });
    });

    if (isAdmin) {
      const labels = dates.map(d => d.split('-')[2]);
      const dataPresents = perDayTotals.map(x => x.present);
      const dataLates = perDayTotals.map(x => x.late);
      const dataAbsents = perDayTotals.map(x => x.absent);
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      if (monthlyChart) monthlyChart.destroy();
      monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Present', data: dataPresents, backgroundColor: '#10b981' },
            { label: 'Late', data: dataLates, backgroundColor: '#f59e0b' },
            { label: 'Absent', data: dataAbsents, backgroundColor: '#ef4444' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              ticks: {
                font: { size: 12 }
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                font: { size: 12 },
                stepSize: 1,
                callback: function(value) {
                  return Number.isInteger(value) ? value : '';
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 13
                }
              }
            }
          }
        }
      });
    }

    const rows = [];
    for (const [name, st] of Object.entries(stats)) {
      const perc = st.totalWorkdays ? (((st.present + st.late) / st.totalWorkdays) * 100).toFixed(1) : '0.0';
      rows.push({
        name,
        total: st.totalWorkdays,
        present: st.present,
        late: st.late,
        absent: st.absent,
        perc
      });
    }
    rows.sort((a, b) => parseFloat(b.perc) - parseFloat(a.perc));
    
    let topAttendant = rows.length > 0 ? rows[0] : null;
    let tbl = '';
    
    if (isAdmin) {
      tbl = `
      <div style="margin-bottom:12px; padding:10px; background:#f0f9ff; border-radius:6px; border:1px solid #bae6fd;">
        <strong style="color:#0369a1; font-size:14px;">Top Attendance: </strong>
        <span style="color:#0c4a6e;">${topAttendant ? `${topAttendant.name} (${topAttendant.perc}%)` : 'No data'}</span>
      </div>`;
    }
    
    tbl += '<table class="data-table"><tr><th>Name</th><th>Work Days</th><th>Present</th><th>Late</th><th>Absent</th><th>Attendance %</th></tr>';
    rows.forEach(r => {
      tbl += `<tr>
        <td style="text-align:left;padding-left:8px">${r.name}</td>
        <td>${r.total}</td>
        <td>${r.present}</td>
        <td>${r.late}</td>
        <td>${r.absent}</td>
        <td style="font-weight:600;">${r.perc}%</td>
      </tr>`;
    });
    tbl += '</table>';
    document.getElementById('monthlySummaryTable').innerHTML = tbl;

    let grid = '<div style="overflow-x: auto;"><table class="data-table"><tr><th style="min-width:120px;text-align:left;">Name</th>';
    const labels = dates.map(d => d.split('-')[2]);
    labels.forEach(l => grid += `<th style="min-width:28px;">${l}</th>`);
    grid += '</tr>';
    
    rows.forEach(r => {
      const st = stats[r.name];
      grid += `<tr><td style="text-align:left;padding-left:8px;font-weight:500;">${r.name}</td>`;
      dates.forEach(dt => {
        const status = st.byDate[dt] || ((dt in workdaysMap) ? (!workdaysMap[dt] ? 'Holiday' : 'Absent') : (isDefaultWorkdayISO(dt) ? 'Absent' : 'Holiday'));
        let cell = '', cls = '';
        if (status === 'Holiday' || status === 'Future') {
          cell = '-';
          cls = 'status-holiday';
        } else if (status === 'Absent') {
          cell = 'A';
          cls = 'status-absent';
        } else if (status === 'Late') {
          cell = 'L';
          cls = 'status-late';
        } else {
          cell = 'P';
          cls = 'status-present';
        }
        grid += `<td><span class="${cls}">${cell}</span></td>`;
      });
      grid += '</tr>';
    });
    grid += '</table></div>';
    document.getElementById('monthlyDetailGrid').innerHTML = grid;

  } catch (err) {
    console.error(err);
    showSnackbar('‚ùå Error while building monthly report');
  } finally {
    hideSpinner();
  }
}

// Filter monthly table
function filterMonthlyTable() {
  const searchTerm = document.getElementById('searchMonthly').value.toLowerCase();
  const rows = document.querySelectorAll('#monthlyDetailGrid tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// ========== Workday Manager ==========
function trackModification(iso, currentState, originalState) {
  modifiedDates.set(iso, {
    current: currentState,
    original: originalState,
    isModified: currentState !== originalState
  });
  updateWorkdayStatus();
}

// ‚úÖ Function to clear all modifications for current month
function clearAllModifications() {
  modifiedDates.clear();
  updateWorkdayStatus();
  
  // Re-render calendar to show original state
  renderCalendar(currentCalendarYear, currentCalendarMonth);
  showSnackbar('All modifications cleared');
}

// ‚úÖ Function to update workday status display
function updateWorkdayStatus() {
  const statusElement = document.getElementById('workdayStatus');
  const modifiedCount = Array.from(modifiedDates.values()).filter(m => m.isModified).length;
  
  if (modifiedCount > 0) {
    statusElement.style.display = 'block';
    statusElement.style.background = '#fef3c7';
    statusElement.style.border = '1px solid #f59e0b';
    statusElement.style.color = '#92400e';
    statusElement.innerHTML = `‚ö†Ô∏è You have ${modifiedCount} unsaved modification(s). Click "Save All" to save changes.`;
  } else {
    statusElement.style.display = 'none';
  }
}

// Initialize year selector for workday manager
function initWorkdayYearSelector() {
  const yearSelect = document.getElementById('yearSelectWorkday');
  const monthSelect = document.getElementById('monthSelectWorkday');
  
  if (!yearSelect || !monthSelect) return;
  
  // Clear existing options
  yearSelect.innerHTML = '';
  
  // Add year options (current year -2 to current year +2)
  const currentYear = new Date().getFullYear();
  for (let year = currentYear - 2; year <= currentYear + 2; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
  
  // Set current year and month
  yearSelect.value = currentCalendarYear || currentYear;
  monthSelect.value = currentCalendarMonth || new Date().getMonth();
}

// Handle year/month change
function onYearMonthChange() {
  const yearSelect = document.getElementById('yearSelectWorkday');
  const monthSelect = document.getElementById('monthSelectWorkday');
  
  if (!yearSelect || !monthSelect) return;
  
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  
  // Update global variables
  currentCalendarYear = year;
  currentCalendarMonth = month;
  
  // Render calendar with new selection
  renderCalendar(year, month);
}

async function renderCalendar(year, month0) {
  // ‚úÖ FIX: Prevent multiple simultaneous renders
  if (isRenderingCalendar) {
    console.log('‚è≥ renderCalendar already in progress, skipping...');
    return;
  }
  
  isRenderingCalendar = true;
  console.log('üéØ renderCalendar START with:', year, month0, '(month0 means:', month0 + 1, '= actual month)');
  
  try {
    // ‚úÖ FIX: Ensure global variables are synced with parameters
    currentCalendarYear = year;
    currentCalendarMonth = month0;
    
    // Update selectors if they exist
    const yearSelect = document.getElementById('yearSelectWorkday');
    const monthSelect = document.getElementById('monthSelectWorkday');
    if (yearSelect && monthSelect) {
      yearSelect.value = year;
      monthSelect.value = month0;
    }
    
    const first = new Date(year, month0, 1);
    const startDow = first.getDay();
    const daysInMonth = new Date(year, month0 + 1, 0).getDate();
    
    // ‚úÖ FIX: Use the CORRECT month calculation
    const actualMonth = month0 + 1; // month0 is 0-indexed, actual month is 1-indexed
    const startISO = `${year}-${pad(actualMonth)}-01`;
    const endISO = `${year}-${pad(actualMonth)}-${pad(daysInMonth)}`;
    
    console.log('üìÖ renderCalendar CALCULATION:', {
      calledWith: { year, month0 },
      actualMonth: actualMonth,
      daysInMonth: daysInMonth,
      range: `${startISO} to ${endISO}`,
    });

    const workdaysMap = await loadWorkdaysRange(startISO, endISO);

    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    // Create empty cells for days before the first day of month
    for (let i = 0; i < startDow; i++) {
      const cell = document.createElement('div');
      cell.className = 'cal-cell';
      cell.style.background = '#f8fafc';
      cell.style.cursor = 'default';
      grid.appendChild(cell);
    }

    // Create cells for each day of the month
    for (let d = 1; d <= daysInMonth; d++) {
      const dt = new Date(year, month0, d);
      const iso = ymdFromDate(dt);
      
      // Determine original state
      const explicit = (iso in workdaysMap);
      const originalIsWork = explicit ? !!workdaysMap[iso] : isDefaultWorkdayObj(dt);
      
      // Check if this date has been modified temporarily
      const modification = modifiedDates.get(iso);
      const currentIsWork = modification ? modification.current : originalIsWork;
      const isModified = modification ? modification.isModified : false;

      const cell = document.createElement('div');
      cell.className = 'cal-cell ' + (currentIsWork ? 'work' : 'holiday') + 
                      (iso === new Date().toISOString().split('T')[0] ? ' today' : '') +
                      (isModified ? ' modified' : '');
      
      cell.setAttribute('data-iso', iso);
      cell.setAttribute('data-original', originalIsWork.toString());
      
      // Create date and status label
      const dateDiv = document.createElement('div');
      dateDiv.className = 'date';
      dateDiv.textContent = d;
      
      const statusDiv = document.createElement('div');
      statusDiv.className = 'status-label';
      statusDiv.textContent = currentIsWork ? 'Work' : 'Holiday';
      
      cell.appendChild(dateDiv);
      cell.appendChild(statusDiv);

      // Click handler
      cell.addEventListener('click', async (ev) => {
        if (ev.ctrlKey || ev.metaKey) {
          return;
        }
        
        const iso = cell.getAttribute('data-iso');
        const originalIsWork = cell.getAttribute('data-original') === 'true';
        
        const existingModification = modifiedDates.get(iso);
        const currentIsWork = existingModification ? existingModification.current : originalIsWork;
        
        const newIsWork = !currentIsWork;
        
        // Update cell appearance
        cell.classList.remove('work', 'holiday');
        cell.classList.add(newIsWork ? 'work' : 'holiday');
        
        // Update status label
        cell.querySelector('.status-label').textContent = newIsWork ? 'Work' : 'Holiday';
        
        cell.classList.add('modified');
        
        trackModification(iso, newIsWork, originalIsWork);
        
        showSnackbar(`Changed ${iso} to ${newIsWork ? 'Work Day' : 'Holiday'} - Remember to Save!`);
      });

      grid.appendChild(cell);
    }

    // Create empty cells for days after the last day of month
    const totalCells = startDow + daysInMonth;
    const remaining = (7 - (totalCells % 7)) % 7;
    for (let i = 0; i < remaining; i++) {
      const cell = document.createElement('div');
      cell.className = 'cal-cell';
      cell.style.background = '#f8fafc';
      cell.style.cursor = 'default';
      grid.appendChild(cell);
    }
    
    // Update status display
    updateWorkdayStatus();
    
    console.log('‚úÖ renderCalendar COMPLETED for:', year, month0);
    
  } catch (error) {
    console.error('‚ùå renderCalendar ERROR:', error);
    showSnackbar('‚ùå Error loading calendar: ' + error.message);
  } finally {
    // ‚úÖ FIX: Always reset the flag, even if there's an error
    isRenderingCalendar = false;
  }
}

// Updated showSection function to initialize workday manager
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.style.display = 'block';
  const nav = document.getElementById('nav-' + id);
  if (nav) nav.classList.add('active');
  
  // Close mobile menu when selecting a section
  const sidebar = document.getElementById('sidebar');
  const mobileOverlay = document.getElementById('mobileOverlay');
  if (sidebar && mobileOverlay) {
    sidebar.classList.remove('mobile-open');
    mobileOverlay.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  if (id === 'attendance') loadAttendanceByDate();
  if (id === 'daily') calculateDailyStatus();
  if (id === 'weekly') {
    const wk = document.getElementById('weekPicker');
    if (!wk.value) wk.value = new Date().toISOString().split('T')[0];
    calculateWeeklySummary();
  }
  if (id === 'monthly') calculateMonthlySummary();
  if (id === 'workday') {
    const now = new Date();
    
    // ‚úÖ FIX: Initialize calendar variables if undefined
    if (typeof currentCalendarYear === 'undefined' || typeof currentCalendarMonth === 'undefined') {
      currentCalendarYear = now.getFullYear();
      currentCalendarMonth = now.getMonth();
      console.log('üìÖ Initializing calendar variables:', currentCalendarYear, currentCalendarMonth);
    }
    
    // Initialize year selector
    initWorkdayYearSelector();
    
    console.log('üìÖ Workday - Rendering:', currentCalendarYear, currentCalendarMonth);
    renderCalendar(currentCalendarYear, currentCalendarMonth);
  }
  if (id === 'register') loadRegisteredVehicles();
  if (id === 'settings') loadUserSettings();
  if (id === 'user-management') loadUsers();
}

// ‚úÖ UPDATED: clearSelection function (sekarang clear semua modification)
function clearSelection() {
  if (modifiedDates.size === 0) {
    showSnackbar('No modifications to clear.');
    return;
  }
  
  if (confirm('Are you sure you want to clear all unsaved changes for this month?')) {
    clearAllModifications();
  }
}

// ‚úÖ UPDATED: saveVisibleWorkdays function
async function saveVisibleWorkdays() {
  if (modifiedDates.size === 0) {
    showSnackbar('No changes to save.');
    return;
  }
  
  showSpinner();
  try {
    const updates = {};
    let saveCount = 0;
    
    // Process all modifications
    modifiedDates.forEach((modification, iso) => {
      if (modification.isModified) {
        const newVal = modification.current;
        const defaultVal = isDefaultWorkdayISO(iso);
        
        if (newVal === defaultVal) {
          updates[iso] = null; // Remove override jika sama dengan default
        } else {
          updates[iso] = newVal; // Set new value
        }
        saveCount++;
      }
    });
    
    if (Object.keys(updates).length === 0) {
      showSnackbar('No valid changes to save.');
      return;
    }
    
    // Save to Firebase
    await persistWorkdaysMap(updates);
    
    // Clear modifications after successful save
    clearAllModifications();
    
    showSnackbar(`‚úÖ Successfully saved ${saveCount} day(s)`);
    
    // Refresh calendar to show saved state
    renderCalendar(currentCalendarYear, currentCalendarMonth);
    
  } catch (err) {
    console.error('Error saving workdays:', err);
    showSnackbar('‚ùå Failed to save changes: ' + err.message);
  } finally {
    hideSpinner();
  }
}

// ========== Utils: init pickers, months, years ==========
function initPickers() {
  const monthSel = document.getElementById('monthSelect');
  const yearSel = document.getElementById('yearSelect');
  monthSel.innerHTML = '';
  for (let m = 1; m <= 12; m++) {
    const o = document.createElement('option');
    o.value = m;
    o.text = new Date(2000, m - 1, 1).toLocaleString(undefined, { month: 'short' });
    monthSel.appendChild(o);
  }
  const now = new Date();
  monthSel.value = now.getMonth() + 1;
  yearSel.innerHTML = '';
  const startYear = now.getFullYear() - 3;
  for (let y = startYear; y <= now.getFullYear() + 1; y++) {
    const o = document.createElement('option');
    o.value = y;
    o.text = y;
    yearSel.appendChild(o);
  }
  yearSel.value = now.getFullYear();
  const wp = document.getElementById('weekPicker');
  if (wp) wp.value = now.toISOString().split('T')[0];
  const dp = document.getElementById('datePicker');
  if (dp) dp.value = now.toISOString().split('T')[0];
  
  // ‚úÖ TAMBAH: Set daily date picker kepada hari ini
  const dailyDatePicker = document.getElementById('dailyDatePicker');
  if (dailyDatePicker) {
    dailyDatePicker.value = new Date().toISOString().split('T')[0];
  }
  
  document.getElementById('monthSelect').addEventListener('change', calculateMonthlySummary);
  document.getElementById('yearSelect').addEventListener('change', calculateMonthlySummary);
}

// ========== Auto load on DOM ready ==========
document.addEventListener('DOMContentLoaded', () => {
  initPickers();
  setupMobileMenu();
  loadAttendanceByDate();
});
function debugSettingsStructure() {
  const settings = document.getElementById('settings');
  console.log('üèóÔ∏è SETTINGS STRUCTURE:');
  
  // Check the actual HTML
  console.log('HTML:', settings.outerHTML);
  
  // Check all parent containers up to body
  let parent = settings;
  let path = [];
  while (parent && parent !== document.body) {
    const style = window.getComputedStyle(parent);
    path.push({
      element: parent.tagName + (parent.id ? '#' + parent.id : '') + (parent.className ? '.' + parent.className.replace(/ /g, '.') : ''),
      display: style.display,
      width: style.width,
      height: style.height,
      position: style.position
    });
    parent = parent.parentElement;
  }
  console.log('üìã PARENT PATH:', path);
}

debugSettingsStructure();
// Initialize with current date
document.getElementById('weekPicker').valueAsDate = new Date();


</script>
</body>
</html>

