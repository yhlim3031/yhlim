<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Attendance Dashboard</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">

  <style>
    /* ========== USER MONTHLY DETAIL STYLES ========== */
    #user-monthly-detail {
      display: none;
    }

    .monthly-header {
      margin: 0 0 12px 0;
      color: #1e293b;
      font-size: 16px;
    }

    .user-monthly-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .user-monthly-info h3 {
      margin: 0 0 8px 0;
      color: #1e293b;
      font-size: 20px;
      font-weight: 600;
    }

    .user-monthly-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-present {
      color: #10b981;
    }

    .stat-late {
      color: #f59e0b;
    }

    .stat-absent {
      color: #ef4444;
    }

    .stat-percentage {
      color: #3b82f6;
    }

    /* Calendar Container for User Detail */
    .user-calendar-container {
      margin-top: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      background: white;
    }

    .user-calendar-headers {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .user-cal-header {
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      color: #475569;
      padding: 10px 4px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .user-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .user-cal-cell {
      background: #fff;
      border-radius: 6px;
      padding: 8px 4px;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid #e2e8f0;
      user-select: none;
      font-size: 13px;
      transition: all 0.2s ease;
      position: relative;
    }

    .user-cal-cell:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .user-cal-cell .date {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .user-cal-cell .status {
      font-size: 10px;
      font-weight: 500;
      padding: 2px 4px;
      border-radius: 3px;
      text-align: center;
      width: 100%;
    }

    .user-cal-cell.present .status {
      background: rgba(16, 185, 129, 0.1);
      color: #047857;
    }

    .user-cal-cell.late .status {
      background: rgba(245, 158, 11, 0.1);
      color: #b45309;
    }

    .user-cal-cell.absent .status {
      background: rgba(239, 68, 68, 0.1);
      color: #b91c1c;
    }

    .user-cal-cell.holiday .status {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
    }

    .user-cal-cell.future .status {
      background: rgba(148, 163, 184, 0.1);
      color: #94a3b8;
    }

    .user-cal-cell .time {
      font-size: 9px;
      color: #64748b;
      text-align: center;
      margin-top: 2px;
    }

    /* Details Panel */
    .details-panel {
      margin-top: 20px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      display: none;
    }

    .details-panel.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }

    .detail-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      margin: 0;
    }

    .detail-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #64748b;
      padding: 4px;
    }

    .detail-close:hover {
      color: #374151;
    }

    .detail-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .detail-item {
      display: flex;
      align-items: center;
      padding: 2px 0;
    }

    .detail-label {
      font-weight: 500;
      color: #475569;
      font-size: 14px;
      width: 120px;
      /* Fixed width */
      flex-shrink: 0;
    }

    .detail-value {
      font-weight: 600;
      color: #1e293b;
      font-size: 14px;
      margin-left: 8px;
      /* Consistent spacing */
    }

    .detail-value.present {
      color: #10b981;
    }

    .detail-value.late {
      color: #f59e0b;
    }

    .detail-value.absent {
      color: #ef4444;
    }

    .detail-value.holiday {
      color: #6b7280;
    }

    /* Empty state */
    .empty-calendar {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .empty-calendar-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Loading state */
    .calendar-loading {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Dalam bahagian CSS untuk Daily Status */
    #daily .status-late {
      background: #f59e0b;
      color: white;
      border-radius: 4px;
      padding: 6px 9px;
      font-weight: 500;
      display: inline-block;
      min-width: 24px;
      font-size: 9px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f8fafc;
      display: flex;
      min-height: 100vh;
      font-size: 14px;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: #1e293b;
      color: #fff;
      padding: 16px;
      position: fixed;
      height: 100vh;
      transition: width 0.3s;
      overflow: hidden;
      z-index: 1000;
    }

    .sidebar.collapsed {
      width: 60px
    }

    .sidebar h2 {
      font-size: 18px;
      margin-bottom: 16px;
      transition: opacity 0.3s, visibility 0.3s
    }

    .sidebar.collapsed h2 {
      opacity: 0;
      visibility: hidden;
      display: none
    }

    .sidebar a {
      display: flex;
      align-items: center;
      color: #cbd5e1;
      padding: 10px;
      border-radius: 6px;
      text-decoration: none;
      margin-bottom: 6px;
      transition: 0.3s;
      position: relative;
      font-size: 14px;
    }

    .sidebar a i {
      margin-right: 10px;
      min-width: 18px;
      text-align: center;
      font-style: normal
    }

    .sidebar a.active,
    .sidebar a:hover {
      background: #3b82f6;
      color: #fff
    }

    .sidebar a span {
      transition: opacity 0.3s, visibility 0.3s
    }

    .sidebar.collapsed a span {
      opacity: 0;
      visibility: hidden;
      display: none
    }

    .sidebar .toggle-btn {
      display: block;
      margin-top: 16px;
      text-align: center;
      cursor: pointer;
      color: #fff;
      transition: transform 0.3s
    }

    /* Tooltip for collapsed sidebar */
    .sidebar.collapsed a:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 70px;
      top: 50%;
      transform: translateY(-50%);
      background: #334155;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      z-index: 100;
      opacity: 0;
      animation: fadeIn 0.25s forwards;
      font-size: 12px;
    }

    @keyframes fadeIn {
      to {
        opacity: 1
      }
    }

    .sidebar:not(.collapsed) a:hover::after {
      display: none
    }

    /* Main */
    .main {
      margin-left: 220px;
      padding: 20px;
      flex: 1;
      transition: margin-left 0.3s
    }

    .sidebar.collapsed+.main {
      margin-left: 60px
    }

    /* Cards */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    /* Professional Table Styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
      background: white;
      border: 1px solid #e2e8f0;
    }

    .data-table th {
      background: #f8fafc;
      color: #475569;
      padding: 12px 10px;
      font-weight: 600;
      text-align: center;
      border: 1px solid #e2e8f0;
      font-size: 13px;
    }

    .data-table td {
      padding: 10px;
      text-align: center;
      border: 1px solid #e2e8f0;
      font-size: 13px;
    }

    .data-table tr:hover {
      background: #f8fafc;
    }

    /* Status colors */
    .status-present {
      background: #10b981;
      color: white;
      border-radius: 4px;
      padding: 6px 8px;
      font-weight: 500;
      display: inline-block;
      min-width: 24px;
      font-size: 13px;
    }

    .status-late {
      background: #f59e0b;
      color: white;
      border-radius: 4px;
      padding: 6px 8px;
      font-weight: 500;
      display: inline-block;
      min-width: 24px;
      font-size: 13px;
    }

    .status-absent {
      background: #ef4444;
      color: white;
      border-radius: 4px;
      padding: 6px 8px;
      font-weight: 500;
      display: inline-block;
      min-width: 24px;
      font-size: 13px;
    }

    .status-holiday {
      background: #6b7280;
      color: white;
      border-radius: 4px;
      padding: 6px 8px;
      font-weight: 500;
      display: inline-block;
      min-width: 24px;
      font-size: 13px;
    }

    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .summary-card {
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .summary-card .number {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .summary-card .label {
      font-size: 14px;
      opacity: 0.9;
    }

    /* small helpers */
    .small {
      font-size: 13px;
      color: #64748b
    }

    /* Buttons */
    button {
      background: #3b82f6;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.15s;
      font-size: 13px;
      margin: 4px;
    }

    button:hover {
      background: #2563eb
    }

    /* Inputs */
    input[type=text],
    input[type=date],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 14px;
    }

    /* snackbar */
    #snackbar {
      visibility: hidden;
      min-width: 250px;
      background: #334155;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 12px;
      position: fixed;
      z-index: 999;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      font-size: 13px;
      transition: 0.5s
    }

    #snackbar.show {
      visibility: visible;
      opacity: 1
    }

    /* spinner */
    #spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      z-index: 1000
    }

    @keyframes spin {
      0% {
        transform: translate(-50%, -50%) rotate(0deg)
      }

      100% {
        transform: translate(-50%, -50%) rotate(360deg)
      }
    }

    /* calendar grid */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px
    }

    .cal-cell {
      background: #fff;
      border-radius: 6px;
      padding: 8px;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      cursor: pointer;
      border: 1px solid #e2e8f0;
      user-select: none;
      font-size: 13px;
    }

    .cal-cell .date {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .cal-cell.work {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.06), #fff)
    }

    .cal-cell.holiday {
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.04), #fff)
    }

    .cal-cell.today {
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.12)
    }

    .cal-cell.selected {
      outline: 2px solid rgba(59, 130, 246, 0.16)
    }

    .cal-legend {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px
    }

    .legend-work {
      background: #3b82f6
    }

    .legend-holiday {
      background: #ef4444
    }

    /* Mini table for summary */
    .mini-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      border: 1px solid #e2e8f0;
      font-size: 13px;
    }

    .mini-table th,
    .mini-table td {
      padding: 8px 10px;
      text-align: left;
      border: 1px solid #e2e8f0;
    }

    .mini-table th {
      font-weight: 600;
      color: #475569;
      width: 40%;
      background: #f8fafc;
    }

    .mini-table td {
      color: #334155;
    }

    /* Calendar Container with Headers */
    .calendar-container {
      margin-top: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      background: white;
    }

    .calendar-headers {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .cal-header {
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      color: #475569;
      padding: 10px 4px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Calendar Grid */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .cal-cell {
      background: #fff;
      border-radius: 6px;
      padding: 8px 4px;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid #e2e8f0;
      user-select: none;
      font-size: 13px;
      transition: all 0.2s ease;
      position: relative;
    }

    /* Rest of your existing cal-cell styles... */
    .workday-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .workday-selector-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .selector-container {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .selector-label {
      font-size: 13px;
      font-weight: 500;
      color: #475569;
      white-space: nowrap;
    }

    .year-selector,
    .month-selector {
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      background: white;
      min-width: 100px;
    }

    .year-selector {
      min-width: 80px;
    }

    .month-selector {
      min-width: 120px;
    }

    .workday-action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .workday-action-buttons button {
      padding: 6px 12px;
      font-size: 13px;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Calendar cell improvements */
    .cal-cell {
      background: #fff;
      border-radius: 6px;
      padding: 8px 4px;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid #e2e8f0;
      user-select: none;
      font-size: 13px;
      transition: all 0.2s ease;
      position: relative;
    }

    .cal-cell:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .cal-cell .date {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .cal-cell .status-label {
      font-size: 10px;
      font-weight: 500;
      padding: 2px 4px;
      border-radius: 3px;
      background: rgba(0, 0, 0, 0.05);
      text-align: center;
      width: 100%;
    }

    .cal-cell.work .status-label {
      background: rgba(59, 130, 246, 0.1);
      color: #1e40af;
    }

    .cal-cell.holiday .status-label {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .cal-cell.modified {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }

    /* Remove old navigation buttons */
    .workday-nav-buttons {
      display: none !important;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
      min-height: 40px;
    }

    .section-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 18px;
      font-weight: 600;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .action-buttons button {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      font-size: 13px;
    }

    .action-buttons button .icon {
      font-size: 14px;
    }

    .action-buttons button .text {
      font-size: 13px;
    }

    /* Chart size adjustments */
    #weeklyChart {
      height: 220px !important;
    }

    #monthlyChart {
      height: 250px !important;
    }

    /* Adjust chart container spacing */
    .card canvas {
      margin-top: 10px;
    }

    /* Scroll optimization */
    .scroll-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      margin-top: 10px;
    }

    .scroll-container table {
      margin-top: 0;
    }

    /* Register plate improvements */
    .vehicle-list {
      margin-top: 15px;
      border-top: 1px solid #e2e8f0;
      padding-top: 15px;
    }

    .vehicle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f8fafc;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .vehicle-actions {
      display: flex;
      gap: 8px;
    }

    /* Search and filter */
    .search-box {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    .search-box input {
      flex: 1;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 15px;
      gap: 8px;
    }

    .pagination button {
      padding: 6px 12px;
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }

    .pagination button.active {
      background: #3b82f6;
      color: white;
    }

    /* Enhanced pagination controls */
    .pagination-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding: 10px 0;
    }

    .pagination-info {
      font-size: 13px;
      color: #64748b;
    }

    .pagination-buttons {
      display: flex;
      gap: 8px;
    }

    .pagination-buttons button {
      padding: 6px 12px;
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
      font-size: 12px;
    }

    .pagination-buttons button:hover:not(:disabled) {
      background: #3b82f6;
      color: white;
    }

    .pagination-buttons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Mobile Menu Button */
    .mobile-menu-btn {
      display: none;
      position: fixed !important;
      top: 15px !important;
      left: 10px !important;
      transform: none !important;
      will-change: transform;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      z-index: 1001;
      font-size: 16px;
      transition: none !important;
    }


    /* Mobile Overlay */
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    /* Daily Status Date Info */
    .daily-date-info {
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #f0f9ff;
      border-radius: 6px;
      border: 1px solid #bae6fd;
      font-size: 14px;
      color: #0369a1;
    }

    /* User-specific styles */
    .user-only {
      display: none;
    }

    .admin-user .admin-only {
      display: block !important;
    }

    .admin-user .filter-section {
      display: flex !important;
      flex-direction: column;
      gap: 12px;
    }

    /* Ensure filter elements are visible */
    .admin-user .filter-section select,
    .admin-user .filter-section input {
      display: block !important;
      width: 100%;
    }

    /* Add vehicle form improvements */
    .add-vehicle-form {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid #e2e8f0;
    }

    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #475569;
      font-size: 14px;
    }

    /* PERBAIKI Settings Section */
    #user-settings {
      position: relative;
      width: 100%;
      display: none;
      background: white;
      padding: 20px;
      margin: 0;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    /* Pastikan main container layout benar */
    .main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .main>.section {
      order: 0;
      flex: none;
    }

    /* Auto-capitalize input */
    .auto-capitalize {
      text-transform: capitalize;
    }

    /* User Management Styles */
    .user-status-active {
      color: #10b981;
      font-weight: 500;
    }

    .user-status-inactive {
      color: #ef4444;
      font-weight: 500;
    }

    .user-detail-section {
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .user-detail-section h4 {
      margin: 0 0 12px 0;
      color: #1e293b;
      font-size: 16px;
    }

    .user-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .user-actions button {
      margin: 0;
      transition: all 0.2s ease;
    }

    .user-actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Style khusus untuk delete button */
    .user-actions button[style*="background:#dc2626"] {
      background: #dc2626 !important;
    }

    .user-actions button[style*="background:#dc2626"]:hover {
      background: #b91c1c !important;
    }

    /* Warning state untuk actions berbahaya */
    .user-actions button.danger {
      background: #dc2626;
      animation: pulse-danger 2s infinite;
    }

    .rfid-input {
      font-family: monospace;
      letter-spacing: 1px;
    }

    .user-list-item {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .user-list-item:hover {
      background-color: #f8fafc;
    }

    /* Improved filter section for monthly view */
    .compact-filter-section {
      padding: 12px !important;
      margin-bottom: 12px !important;
    }

    .compact-filter-section label {
      font-size: 13px !important;
      font-weight: 500 !important;
      margin-bottom: 0 !important;
    }

    .compact-filter-section select,
    .compact-filter-section input {
      padding: 6px !important;
      font-size: 13px !important;
      margin-top: 0 !important;
    }

    /* ========== ATTENDANCE CARD STYLES ========== */
    .attendance-card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .attendance-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .attendance-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f1f5f9;
    }

    .attendance-card-name {
      font-weight: 600;
      font-size: 16px;
      color: #1e293b;
      flex: 1;
    }

    .attendance-card-status {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .attendance-card-status.present {
      background: #10b981;
      color: white;
    }

    .attendance-card-status.late {
      background: #f59e0b;
      color: white;
    }

    .attendance-card-status.absent {
      background: #ef4444;
      color: white;
    }

    .attendance-card-status.holiday {
      background: #6b7280;
      color: white;
    }

    .attendance-card-details {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .attendance-card-detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
    }

    .attendance-card-detail-label {
      color: #64748b;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .attendance-card-detail-value {
      color: #334155;
      font-size: 14px;
      font-weight: 500;
    }

    .attendance-card-department {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #475569;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .attendance-card-department-icon {
      font-size: 16px;
    }

    .no-attendance-cards {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
      font-size: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px dashed #e2e8f0;
    }

    /* Hide cards on desktop by default */
    .mobile-attendance-cards {
      display: none;
    }

    /* ========== MOBILE RESPONySIVE IMPROVEMENTS ========== */
    @media(max-width:900px) {
      .monthly-header {
        font-size: 13px !important;
        margin-bottom: 10px !important;
      }

      /* Monthly Section Mobile Styles */
      /* Monthly Filter Section - Mobile HORIZONTAL 2 baris */
      #monthly .filter-section.compact-filter-section>div {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }

      /* Baris pertama - Month & Year */
      #monthly .filter-section.compact-filter-section>div>div:nth-child(1),
      #monthly .filter-section.compact-filter-section>div>div:nth-child(2) {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8 px;
        width: 100%;
      }

      /* Baris kedua - Department & Search */
      #monthly .filter-section.compact-filter-section>div>div:nth-child(3),
      #monthly .filter-section.compact-filter-section>div>div:nth-child(4) {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 6px;
        width: 100%;
      }

      /* Styling untuk semua items */
      #monthly .filter-section.compact-filter-section>div>div {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 4px;
      }

      #monthly .filter-section.compact-filter-section>div>div label {
        font-size: 13px !important;
        font-weight: 500 !important;
        margin: 0 !important;
        min-width: 85px;
        white-space: nowrap;
      }

      #monthly .filter-section.compact-filter-section>div>div select,
      #monthly .filter-section.compact-filter-section>div>div input {
        padding: 6px 8px !important;
        font-size: 13px !important;
        min-height: 30px;
        border: 1px solid #d1d5db !important;
        border-radius: 6px;
      }

      /* Box kecil untuk Month & Year */
      #monthly .filter-section.compact-filter-section>div>div:nth-child(1) select,
      #monthly .filter-section.compact-filter-section>div>div:nth-child(2) select {
        width: 100px !important;
      }

      /* Box sederhana untuk Department & Search */
      #monthly .filter-section.compact-filter-section>div>div:nth-child(3) select,
      #monthly .filter-section.compact-filter-section>div>div:nth-child(4) input {
        width: 250px !important;
      }

      #monthly .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding-bottom: 12px;
      }

      #monthly .section-header h3 {
        font-size: 18px;
        margin: 0;
      }

      #monthly .action-buttons {
        align-self: stretch;
        justify-content: flex-start;
      }

      #monthly .action-buttons button {
        flex: 1;
        min-width: auto;
        padding: 8px 12px;
        font-size: 13px;
      }

      /* Compact Filter Section - Mobile */
      #monthly .filter-section.compact-filter-section {
        padding: 12px !important;
        margin-bottom: 12px !important;
      }

      #monthly .filter-section.compact-filter-section>div {
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }

      #monthly .filter-section.compact-filter-section>div>div {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      #monthly .filter-section.compact-filter-section label {
        font-size: 13px !important;
        font-weight: 500 !important;
        margin: 0 !important;
      }

      #monthly .filter-section.compact-filter-section select,
      #monthly .filter-section.compact-filter-section input {
        width: 100% !important;
        padding: 10px !important;
        font-size: 14px !important;
        min-height: 44px;
        border: 1px solid #d1d5db !important;
        border-radius: 6px;
      }

      #monthlyChart {
        height: 300px !important;
        /* More height for vertical labels */
        min-height: 300px !important;
      }

      /* Force chart container to have enough space */
      #monthly .card.admin-only {
        padding-bottom: 30px;
        overflow: visible !important;
      }

      /* Ensure chart canvas has enough space */
      #monthlyChart+div {
        min-height: 320px !important;
      }

      #monthly .card.admin-only h4 {
        font-size: 15px;
        margin-bottom: 10px;
      }

      /* Force Chart.js to show ALL labels vertically */
      #monthlyChart~div canvas {
        max-height: 300px !important;
      }

      /* Summary Table - Mobile */
      #monthly .card:last-child {
        padding: 12px;
      }

      #monthly .card:last-child h4 {
        font-size: 15px;
        margin-bottom: 10px;
      }

      #monthlySummaryTable {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      #monthlySummaryTable table {
        min-width: 400px;
        font-size: 12px;
      }

      #monthlySummaryTable th {
        font-size: 11px;
        padding: 10px 6px;
        white-space: nowrap;
      }

      #monthlySummaryTable td {
        font-size: 11px;
        padding: 8px 6px;
      }

      /* Pagination - Mobile */
      #monthlyPaginationBottom {
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
        padding: 10px 0;
      }

      #monthlyPaginationInfoBottom {
        font-size: 12px;
        text-align: center;
      }

      #monthlyPaginationBottom .pagination-buttons {
        display: flex;
        gap: 4px;
        justify-content: center;
        flex-wrap: wrap;
      }

      #monthlyPaginationBottom .pagination-buttons button {
        padding: 6px 8px;
        font-size: 11px;
        min-height: 36px;
        flex: 1;
        min-width: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Hide some text in buttons for very small screens */
      #monthlyPaginationBottom .pagination-buttons button .full-text {
        display: none;
      }

      body:has(#user-monthly-detail[style*="display: block"]) .mobile-menu-btn {
        display: none !important;
      }

      /* User Monthly Detail Mobile Styles - FIXED */
      #user-monthly-detail .user-monthly-header {
        flex-direction: row;
        justify-content: space-between;
        /* Button kanan, info kiri */
        align-items: flex-start;
        padding: 12px;
        margin-bottom: 16px;
        gap: 12px;
      }

      #user-monthly-detail .user-monthly-info {
        text-align: left;
        /* Info di kiri */
        flex: 1;
        order: 1;
        /* Info di kiri */
      }

      #user-monthly-detail .user-monthly-info h3 {
        font-size: 16px;
        margin-bottom: 4px;
        line-height: 1.2;
      }

      #user-monthly-detail .user-monthly-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 16px;
      }

      #user-monthly-detail .stat-card {
        padding: 10px 6px;
      }

      #user-monthly-detail .stat-number {
        font-size: 18px;
        margin-bottom: 2px;
      }

      #user-monthly-detail .stat-label {
        font-size: 10px;
        letter-spacing: 0.3px;
      }

      /* FIX: Action buttons di sebelah kanan dengan size sama seperti info */
      #user-monthly-detail .user-monthly-header .action-buttons {
        order: 2;
        /* Button di kanan */
        align-self: flex-start;
        /* Sejajar dengan info */
      }

      #user-monthly-detail .user-monthly-header .action-buttons button {
        padding: 6px 10px;
        font-size: 12px;
        /* Size sama dengan info */
        min-height: 34px;
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
        /* Elak text wrap */
      }

      #user-monthly-detail .user-monthly-header .action-buttons button .icon {
        font-size: 13px;
        /* Size sesuai */
      }

      #user-monthly-detail .user-monthly-header .action-buttons button .text {
        font-size: 12px;
        /* Size sama dengan info */
      }

      /* Calendar styles yang lain */
      #user-monthly-detail .user-calendar-container {
        margin-top: 12px;
        padding: 12px;
      }

      #user-monthly-detail .user-calendar-headers {
        gap: 3px;
        margin-bottom: 6px;
      }

      #user-monthly-detail .user-cal-header {
        font-size: 10px;
        padding: 8px 2px;
      }

      #user-monthly-detail .user-calendar {
        gap: 3px;
      }

      #user-monthly-detail .user-cal-cell {
        min-height: 65px;
        padding: 5px 2px;
        font-size: 11px;
      }

      #user-monthly-detail .user-cal-cell .date {
        font-size: 11px;
        margin-bottom: 2px;
      }

      #user-monthly-detail .user-cal-cell .status {
        font-size: 8px;
        padding: 1px 2px;
      }

      #user-monthly-detail .user-cal-cell .time {
        font-size: 7px;
        margin-top: 1px;
      }

      #user-monthly-detail .details-panel {
        margin-top: 16px;
        padding: 12px;
      }

      #user-monthly-detail .detail-header {
        margin-bottom: 8px;
        padding-bottom: 8px;
      }

      #user-monthly-detail .detail-title {
        font-size: 14px;
      }

      #user-monthly-detail .detail-content {
        gap: 3px;
      }

      #user-monthly-detail .detail-item {
        padding: 1px 0;
      }

      #user-monthly-detail .detail-label {
        width: 90px;
        font-size: 12px;
      }

      #user-monthly-detail .detail-value {
        font-size: 12px;
        margin-left: 6px;
      }

      #user-detail #userVehiclesList {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }

      #user-detail #userVehiclesList table {
        min-width: 300px !important;
      }

      #user-detail .user-detail-section {
        padding: 12px !important;
        margin-bottom: 16px !important;
      }

      #user-detail .user-detail-section h4 {
        font-size: 16px !important;
        margin-bottom: 6px !important;
      }

      /* Reduce spacing between form rows */
      #user-detail .form-row {
        gap: 2px !important;
        /* REDUCE spacing between rows */
        margin-bottom: 4px !important;
        /* REDUCE spacing between rows */
      }

      /* Make form groups stack vertically on mobile */
      #user-detail .form-row {
        flex-direction: column !important;
        gap: 2px !important;
        /* Reduce spacing between rows */
        margin-bottom: 4px !important;
        /* Reduce spacing between rows */
      }

      #user-detail .form-group {
        width: 100% !important;
        margin-bottom: 0 !important;
      }

      /* Reduce label size */
      #user-detail .form-group label {
        font-size: 13px !important;
        font-weight: 500 !important;
        margin-bottom: 0px !important;
      }

      /* Reduce input size and spacing */
      #user-detail .form-group input {
        padding: 6px 8px !important;
        font-size: 13px !important;
        min-height: 36px !important;
      }

      /* Specifically reduce department text size */
      #userDetailDepartment {
        font-size: 13px !important;
      }

      /* Registered Vehicles Section */
      #user-detail #userVehiclesList table {
        font-size: 12px !important;
      }

      #user-detail #userVehiclesList th {
        font-size: 11px !important;
        padding: 8px 6px !important;
      }

      #user-detail #userVehiclesList td {
        font-size: 11px !important;
        padding: 6px 4px !important;
      }

      #user-detail #userVehiclesList button {
        padding: 4px 8px !important;
        font-size: 11px !important;
        min-height: 32px !important;
      }

      /* Adjust filter section layout for mobile */
      #user-management .filter-section {
        flex-direction: column !important;
        padding: 10px !important;
        gap: 12px !important;
        background: #f8fafc !important;
        border-radius: 8px !important;
        margin-bottom: 16px !important;
      }

      #user-management .filter-section .form-group {
        width: 100% !important;
        margin-bottom: 0 !important;
      }

      #user-management .filter-section label {
        font-size: 10px !important;
        font-weight: 600 !important;
        color: #374151 !important;
        margin-bottom: 6px !important;
        display: block !important;
      }

      #user-management .filter-section select,
      #user-management .filter-section input {
        width: 100% !important;
        padding: 8px 10px !important;
        font-size: 14px !important;
        /* Prevent zoom on iOS */
        min-height: 40px !important;
        /* Better touch targets */
        border: 1px solid #d1d5db !important;
        border-radius: 6px !important;
        background: white !important;
      }

      /* Improve dropdown appearance on mobile */
      #user-management .filter-section select {
        appearance: none !important;
        background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23333' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>") !important;
        background-repeat: no-repeat !important;
        background-position: right 8px center !important;
        background-size: 12px !important;
        padding-right: 30px !important;
      }

      /* Search input specific styles */
      #user-management .filter-section input[type="text"] {
        background-image: url("data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'><circle cx='11' cy='11' r='8'/><path d='m21 21-4.35-4.35'/></svg>") !important;
        background-repeat: no-repeat !important;
        background-position: left 8px center !important;
        background-size: 18px !important;
        padding-left: 30px !important;
      }

      #user-management .data-table {
        font-size: 12px !important;
      }

      #user-management .data-table th {
        font-size: 11px !important;
        padding: 10px 6px !important;
        font-weight: 600 !important;
      }

      #user-management .data-table td {
        font-size: 11px !important;
        padding: 8px 6px !important;
      }

      /* Make table horizontally scrollable on mobile */
      #user-management .scroll-container {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }

      #user-management .data-table {
        min-width: 300px !important;
      }

      /* Adjust status badges for mobile */
      #user-management .user-status-active,
      #user-management .user-status-inactive {
        font-size: 10px !important;
        padding: 4px 6px !important;
        display: inline-block !important;
        white-space: nowrap !important;
      }

      /* Adjust filter section for mobile */
      #user-management .filter-section {
        padding: 8px !important;
        gap: 8px !important;
      }

      #user-management .filter-section label {
        font-size: 11px !important;
        font-weight: 500 !important;
      }

      #user-management .filter-section select,
      #user-management .filter-section input {
        padding: 6px 8px !important;
        font-size: 13px !important;
        min-height: 36px !important;
      }

      /* Adjust pagination for mobile */
      #user-management .pagination-info {
        font-size: 11px !important;
      }

      #user-management .pagination-buttons button {
        padding: 6px 8px !important;
        font-size: 11px !important;
        min-height: 36px !important;
      }

      /* Show cards and hide table on mobile */
      .mobile-attendance-cards {
        display: block !important;
      }

      body.admin-user .admin-only {
        display: block !important;
        visibility: visible !important;
      }

      /* Fix filter section layout for mobile */
      body.admin-user .filter-section {
        display: flex !important;
        flex-direction: column;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        margin-bottom: 16px;
      }

      /* Ensure filter inputs are visible and properly sized */
      body.admin-user .filter-section select,
      body.admin-user .filter-section input {
        display: block !important;
        width: 100% !important;
        min-height: 44px;
        /* Better touch targets */
        font-size: 16px !important;
        /* Prevent zoom on iOS */
      }

      /* Fix pagination for admin on mobile */
      body.admin-user .pagination-controls {
        display: flex !important;
        flex-direction: column;
        gap: 8px;
      }

      /* Fix action buttons for admin */
      body.admin-user .action-buttons {
        display: flex !important;
        gap: 6px;
      }
    }

    /* ========== SPECIFIC FIX FOR ATTENDANCE SECTION ========== */
    @media(max-width:900px) {
      #attendance .filter-section {
        display: flex !important;
        flex-direction: column;
        gap: 12px;
      }

      /* Show both table and cards but hide table on mobile */
      #attendance .scroll-container {
        display: none !important;
      }

      #attendance .mobile-attendance-cards {
        display: block !important;
      }

      /* Admin-specific attendance fixes */
      body.admin-user #attendance .filter-section {
        background: #f0f9ff;
        border: 1px solid #e0f2fe;
      }

      /* Hide table on mobile for all users */
      #attendance .scroll-container {
        display: none !important;
      }

      #user-settings .section-header h3 {
        display: none;
      }

      .sidebar.mobile-open~.main #user-settings .section-header::before {
        display: none !important;
      }

      #user-settings .section-header {
        display: flex;
        align-items: center;
        margin-top: 0 !important;
        padding-top: 30px !important;
      }

      #user-settings .section-header::before {
        content: "⚙️ Settings";
        position: fixed;
        top: 22px;
        left: 55px;
        font-size: 18px !important;
        font-weight: 600;
        z-index: 1000;
      }

      #user-settings .section-header h3 {
        display: none;
      }

      #user-settings .settings-section h4 {
        font-size: 16px !important;
        font-weight: 500 !important;
        color: #1e293b !important;
        margin-bottom: 14px !important;
      }

      /* Besarkan label "Your Display Name:" */
      #user-settings .form-group label {
        font-size: 14px !important;
        font-weight: 500 !important;
        color: #374151 !important;
        margin-bottom: 10px !important;
      }

      /* Besarkan input field */
      #user-settings .form-group input {
        font-size: 16px !important;
        padding: 10px 12px !important;
        border: 2px solid #d1d5db !important;
        border-radius: 8px !important;
      }

      /* Besarkan button */
      #user-settings .form-group button {
        font-size: 16px !important;
        padding: 10px 16px !important;
        font-weight: 600 !important;
        margin-top: 16px !important;
      }

      .sidebar.mobile-open~#user-settings .section-header::before {
        display: none !important;
      }

      .workday-btn-clear,
      .workday-btn-save {
        min-height: 36px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: 500 !important;
      }

      .workday-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .workday-selector-group {
        justify-content: center;
      }

      .workday-action-buttons {
        justify-content: center;
      }

      .year-selector,
      .month-selector {
        min-width: 70px;
        font-size: 12px;
      }

      .selector-label {
        font-size: 12px;
      }

      /* Adjust mobile menu button */
      .mobile-menu-btn {
        display: block !important;
        position: fixed !important;
        will-change: transform;
        top: 15px;
        left: 15px;
        padding: 5px 8px;
        font-size: 12px;
        background: rgba(59, 130, 246, 0.9);
        backdrop-filter: blur(4px);
        z-index: 1001 !important;
        transition: none !important;
        transform: translateY(0);
        opacity: 1;
      }



      /* FIX: Gunakan selector yang lebih spesifik */
      .sidebar.mobile-open+.main .mobile-menu-btn,
      .sidebar.mobile-open~.mobile-menu-btn {
        display: none !important;
      }

      /* Atau cuba ini - lebih direct */
      body:has(.sidebar.mobile-open) .mobile-menu-btn {
        display: none !important;
      }

      /* Improve sidebar for mobile */
      .sidebar {
        position: fixed;
        left: -220px;
        z-index: 1000;
      }

      .sidebar.mobile-open {
        left: 0;
        width: 280px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
      }

      .sidebar.collapsed {
        left: 0;
        width: 220px;
      }

      /* Hide toggle button on mobile */
      .toggle-btn {
        display: none !important;
      }

      /* Adjust main content */
      .main {
        margin-left: 0;
        padding: 12px 8px;
      }

      /* Improve card spacing */
      .card {
        padding: 10px;
        margin-bottom: 10px;
      }

      /* Better table readability on mobile */
      .data-table {
        font-size: 10px;
      }

      .data-table th,
      .data-table td {
        padding: 6px 4px;
      }

      /* Adjust section headers */
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      /* FIX: Selaraskan section headers untuk mobile */
      .section-header {
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 12px;
        min-height: 40px;
      }

      .section-header h3 {
        font-size: 18px !important;
        margin: 0 !important;
        flex: 1;
        padding-left: 26px !important;
      }

      #home .section-header {
        display: flex;
        align-items: center;
        margin-top: 0 !important;
        padding-top: 30px !important;
      }

      #home .section-header::before {
        content: "Welcome";
        position: fixed;
        top: 22px;
        left: 55px;
        font-size: 18px !important;
        font-weight: 600;
        z-index: 1000;
      }

      #home .section-header h3 {
        display: none;
      }

      .sidebar.mobile-open~.main #home .section-header::before {
        display: none !important;
      }

      /* FIX: Selaraskan action buttons */
      .action-buttons {
        display: flex;
        gap: 6px;
        align-items: center;
        margin-top: 0 !important;
      }

      .action-buttons button {
        padding: 6px 8px;
        font-size: 11px;
        min-height: 36px;
        min-width: auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .action-buttons button .text {
        display: none;
      }

      .action-buttons button .icon {
        margin-right: 0;
        font-size: 12px;
      }

      /* Improve filter sections */
      .filter-section {
        padding: 8px;
        gap: 8px;
      }

      .filter-section label {
        font-size: 11px;
      }

      /* Better button sizing */
      button {
        padding: 8px 10px;
        font-size: 12px;
        min-height: 40px;
      }

      /* Improve form elements */
      input[type=text],
      input[type=date],
      select {
        padding: 8px 10px;
        font-size: 14px;
        min-height: 40px;
      }

      /* Adjust summary cards */
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .summary-card {
        padding: 10px;
      }

      .summary-card .number {
        font-size: 18px;
      }

      .summary-card .label {
        font-size: 11px;
      }

      /* Mobile overlay */
      .mobile-overlay.active {
        display: block;
      }

      /* Improve pagination */
      .pagination-controls {
        flex-direction: column;
        gap: 8px;
      }

      .pagination-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }

      .pagination-buttons button {
        flex: 1;
        min-width: 60px;
        margin: 2px;
        padding: 4px 6px;
        font-size: 10px;
      }

      /* Better calendar for mobile */
      .calendar-headers {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-bottom: 6px;
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
      }

      .cal-header {
        padding: 8px 2px;
        font-size: 11px;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      .cal-cell {
        min-height: 50px !important;
        padding: 4px 2px !important;
        font-size: 12px;
        text-align: center;
      }

      /* Ensure both headers and cells have same width distribution */
      .cal-header,
      .cal-cell {
        width: 100%;
        box-sizing: border-box;
      }

      /* Adjust chart sizes */
      #weeklyChart,
      #monthlyChart {
        height: 150px !important;
      }

      /* Improve user management */
      .user-detail-section {
        padding: 10px;
      }

      .user-actions {
        flex-direction: column;
      }

      .user-actions button {
        width: 100%;
      }

      /* Adjust form rows for mobile */
      .form-row {
        flex-direction: column;
      }

      .form-group {
        min-width: 100%;
      }

      /* Smaller status badges */
      .status-present,
      .status-late,
      .status-absent,
      .status-holiday {
        padding: 3px 5px;
        font-size: 10px;
        min-width: 20px;
      }

      /* Smaller vehicle items */
      .vehicle-item {
        padding: 6px;
      }

      /* Smaller search boxes */
      .search-box input {
        padding: 6px 8px;
        font-size: 12px;
      }

      /* Reduce text sizes for mobile */
      body {
        font-size: 12px;
      }

      .pagination-info {
        font-size: 10px;
      }

      /* Smaller form elements */
      .form-group label {
        font-size: 11px;
      }

      .add-vehicle-form,
      .settings-section,
      .user-detail-section {
        padding: 10px;
      }

      /* ========== CUSTOM DAILY ADMIN TEXT SIZES ========== */
      #daily .section-header h3 {
        font-size: 14px !important;
        font-weight: 600 !important;
      }

      #daily .filter-section label {
        font-size: 10px !important;
        font-weight: 500 !important;
      }

      #daily .filter-section select,
      #daily .filter-section input {
        font-size: 10px !important;
      }

      #dailyDateInfo {
        font-size: 10px !important;
        font-weight: 500 !important;
      }

      #daily .data-table th {
        font-size: 12px !important;
        padding: 14px 12px !important;
        font-weight: 500 !important;
      }

      #daily .data-table td {
        font-size: 9px !important;
        padding: 12px 10px !important;
      }

      #daily .status-present,
      #daily .status-absent,
      #daily .status-holiday {
        font-size: 9px !important;
        padding: 6px 9px !important;
        font-weight: 500 !important;
      }

      #daily .pagination-info {
        font-size: 8px !important;
        font-weight: 500 !important;
      }

      #daily .pagination-buttons button {
        font-size: 8px !important;
        padding: 8px 14px !important;
        font-weight: 400 !important;
      }

    }

    /* ========== 600px BREAKPOINT ========== */
    @media(max-width:600px) {
      #user-monthly-detail .user-monthly-header {
        padding: 10px;
        gap: 8px;
      }

      #user-monthly-detail .user-monthly-info h3 {
        font-size: 15px;
      }

      #user-monthly-detail .user-monthly-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }

      #user-monthly-detail .stat-card {
        padding: 8px 4px;
      }

      #user-monthly-detail .stat-number {
        font-size: 16px;
      }

      #user-monthly-detail .stat-label {
        font-size: 9px;
      }

      #user-monthly-detail .user-monthly-header .action-buttons button {
        padding: 5px 8px;
        font-size: 11px;
        min-height: 32px;
      }

      #user-monthly-detail .user-monthly-header .action-buttons button .text {
        font-size: 11px;
      }

      #user-monthly-detail .user-cal-cell {
        min-height: 60px;
      }

      #user-detail .user-detail-section {
        padding: 10px !important;
      }

      #user-detail .user-detail-section h4 {
        font-size: 15px !important;
      }

      #user-detail .form-row {
        gap: 2px !important;
        margin-bottom: 4px !important;
      }

      #user-detail .form-group label {
        font-size: 12px !important;
        margin-bottom: 0px !important;
      }

      #user-detail .form-group input {
        padding: 5px 6px !important;
        font-size: 12px !important;
        min-height: 32px !important;
      }

      #userDetailDepartment {
        font-size: 12px !important;
      }

      /* Vehicles table - even smaller */
      #user-detail #userVehiclesList table {
        font-size: 11px !important;
      }

      #user-detail #userVehiclesList th {
        font-size: 10px !important;
        padding: 6px 4px !important;
      }

      #user-detail #userVehiclesList td {
        font-size: 10px !important;
        padding: 5px 3px !important;
      }

      #user-detail #userVehiclesList button {
        padding: 3px 6px !important;
        font-size: 10px !important;
        min-height: 28px !important;
      }

      #user-management .filter-section {
        padding: 10px !important;
        gap: 10px !important;
      }

      #user-management .filter-section label {
        font-size: 13px !important;
      }

      #user-management .filter-section select,
      #user-management .filter-section input {
        padding: 5px 6px !important;
        font-size: 12px !important;
        min-height: 32px !important;
      }

      #user-management .filter-section select {
        background-position: right 10px center !important;
        padding-right: 36px !important;
      }

      #user-management .filter-section input[type="text"] {
        background-position: left 10px center !important;
        padding-left: 36px !important;
      }

      #user-management .data-table {
        font-size: 11px !important;
      }

      #user-management .data-table th {
        font-size: 10px !important;
        padding: 8px 4px !important;
      }

      #user-management .data-table td {
        font-size: 10px !important;
        padding: 6px 4px !important;
      }

      #user-management .user-status-active,
      #user-management .user-status-inactive {
        font-size: 9px !important;
        padding: 3px 5px !important;
      }

      #user-management .pagination-buttons button {
        padding: 5px 6px !important;
        font-size: 10px !important;
      }

      body.admin-user .filter-section {
        padding: 8px !important;
        gap: 8px !important;
      }

      body.admin-user .filter-section label {
        font-size: 14px !important;
        font-weight: 500 !important;
      }

      body.admin-user .filter-section select,
      body.admin-user .filter-section input {
        font-size: 14px !important;
        padding: 10px !important;
      }

      /* Mobile menu button fixes */
      .sidebar.mobile-open+.main .mobile-menu-btn,
      .sidebar.mobile-open~.mobile-menu-btn {
        display: none !important;
      }

      .workday-selector-group {
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }

      .selector-container {
        justify-content: space-between;
        width: 100%;
      }

      .year-selector,
      .month-selector {
        flex: 1;
        min-width: auto;
      }

      .cal-cell {
        min-height: 45px !important;
      }

      .cal-cell .date {
        font-size: 13px !important;
      }

      .cal-cell .status-label {
        font-size: 9px;
      }

      .calendar-headers {
        gap: 1px;
      }

      .calendar {
        gap: 1px;
      }

      .cal-header {
        font-size: 10px;
        padding: 6px 1px;
        min-height: 28px;
      }

      .cal-cell {
        min-height: 40px;
        padding: 4px 1px;
        font-size: 11px;
      }

      body:has(.sidebar.mobile-open) .mobile-menu-btn {
        display: none !important;
      }

      /* Further adjustments for small phones */
      .sidebar.mobile-open {
        width: 260px;
      }

      .data-table {
        font-size: 9px;
      }

      .data-table th,
      .data-table td {
        padding: 4px 2px;
      }

      .summary-cards {
        grid-template-columns: 1fr;
      }

      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }

      /* Better weekly layout */
      #weekly .card {
        flex-direction: column;
      }

      /* Adjust calendar further */
      .calendar {
        gap: 1px;
      }

      .cal-cell {
        min-height: 30px;
        padding: 1px;
      }

      .cal-cell .date {
        font-size: 9px;
      }

      /* FIX: Even smaller but selari */
      .action-buttons button {
        padding: 5px 6px;
        font-size: 10px;
        min-height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* FIX: Smaller section headers tapi tetap selari */
      .section-header h3 {
        font-size: 17px !important;
        margin: 0 !important;
      }

      .section-header {
        gap: 8px !important;
        padding-left: 26px !important;
      }

      /* Smaller cards */
      .card {
        padding: 8px;
      }

      /* Smaller charts */
      #weeklyChart,
      #monthlyChart {
        height: 130px !important;
      }

      .sidebar.mobile-open~.main #home .section-header::before {
        display: none !important;
      }

      .toggle-btn {
        display: none !important;
      }

      /* ========== ATTENDANCE CARD LAYOUT FOR PHONE USERS ========== */
      /* Hide table for all users on mobile */
      #attendance .data-table {
        display: none !important;
      }

      /* Show card layout for all users on mobile */
      #attendance .mobile-attendance-cards {
        display: block !important;
      }

      .workday-action-buttons {
        flex-direction: column;
        gap: 4px;
      }

      .workday-action-buttons button {
        width: 100%;
        min-width: auto;
        padding: 5px 6px;
        font-size: 10px;
      }

      .workday-nav-buttons button {
        padding: 4px 6px;
        font-size: 10px;
      }

      #calendarTitle {
        font-size: 13px;
        padding: 0 4px;
      }
    }

    /* ========== 400px BREAKPOINT ========== */
    @media(max-width:400px) {
      #user-monthly-detail .user-monthly-header .action-buttons button .text {
        display: none;
        /* Sembunyikan text, hanya icon pada screen sangat kecil */
      }

      #user-monthly-detail .user-monthly-header .action-buttons button {
        padding: 6px;
        min-width: 36px;
        font-size: 10px;
      }

      #user-detail .user-detail-section {
        padding: 8px !important;
      }

      #user-detail .user-detail-section h4 {
        font-size: 14px !important;
      }

      #user-detail .form-row {
        gap: 1px !important;
        margin-bottom: 3px !important;
      }

      #user-detail .form-group label {
        font-size: 11px !important;
        margin-bottom: 0px !important;
      }

      #user-detail .form-group input {
        padding: 4px 5px !important;
        font-size: 11px !important;
        min-height: 32px !important;
      }

      #userDetailDepartment {
        font-size: 11px !important;
      }

      /* Vehicles table - smallest */
      #user-detail #userVehiclesList table {
        font-size: 10px !important;
      }

      #user-detail #userVehiclesList th {
        font-size: 9px !important;
        padding: 4px 3px !important;
      }

      #user-detail #userVehiclesList td {
        font-size: 9px !important;
        padding: 4px 2px !important;
      }

      #user-detail #userVehiclesList button {
        padding: 2px 4px !important;
        font-size: 9px !important;
        min-height: 24px !important;
      }

      #user-management .filter-section {
        padding: 8px !important;
        gap: 8px !important;
      }

      #user-management .filter-section label {
        font-size: 12px !important;
      }

      #user-management .filter-section select,
      #user-management .filter-section input {
        padding: 8px 10px !important;
        font-size: 14px !important;
        min-height: 40px !important;
      }

      #user-management .filter-section select {
        background-position: right 8px center !important;
        padding-right: 32px !important;
        background-size: 10px !important;
      }

      #user-management .filter-section input[type="text"] {
        background-position: left 8px center !important;
        padding-left: 32px !important;
        background-size: 16px !important;
      }

      #user-management .data-table {
        font-size: 10px !important;
      }

      #user-management .data-table th {
        font-size: 9px !important;
        padding: 6px 3px !important;
      }

      #user-management .data-table td {
        font-size: 9px !important;
        padding: 5px 3px !important;
      }

      #user-management .user-status-active,
      #user-management .user-status-inactive {
        font-size: 8px !important;
        padding: 2px 4px !important;
      }

      #user-management .pagination-buttons button {
        padding: 4px 5px !important;
        font-size: 9px !important;
        min-height: 32px !important;
      }

      #user-management .pagination-info {
        font-size: 9px !important;
      }

      .calendar-headers {
        gap: 1px;
      }

      .calendar {
        gap: 1px;
      }

      .cal-header {
        font-size: 9px;
        padding: 4px 1px;
        min-height: 26px;
      }

      .cal-cell {
        min-height: 60px;
        padding: 3px 1px;
        font-size: 10px;
      }

      /* Mobile menu button fixes */
      .sidebar.mobile-open+.main .mobile-menu-btn,
      .sidebar.mobile-open~.mobile-menu-btn {
        display: none !important;
      }

      .workday-btn-clear,
      .workday-btn-save {
        min-height: 30px !important;
        font-size: 10px !important;
      }

      .workday-action-buttons button {
        padding: 4px 5px;
        font-size: 9px;
      }

      .workday-action-buttons .workday-btn-clear .full-text {
        display: none;
      }

      .workday-action-buttons .workday-btn-save .full-text {
        display: none;
      }

      .workday-nav-buttons button {
        padding: 4px 5px;
        font-size: 9px;
        min-width: 24px;
      }

      #calendarTitle {
        font-size: 11px;
        padding: 0 2px;
      }

      body:has(.sidebar.mobile-open) .mobile-menu-btn {
        display: none !important;
      }

      /* Extra small phone adjustments */
      .sidebar.mobile-open {
        width: 240px;
      }

      .data-table {
        font-size: 8px;
      }

      .data-table th,
      .data-table td {
        padding: 3px 1px;
      }

      .card {
        padding: 6px;
      }

      .section-header h3 {
        font-size: 16px !important;
        margin: 0 !important;
      }

      .section-header {
        gap: 6px !important;
        min-height: 35px;
        padding-left: 26px !important;
      }

      .sidebar.mobile-open~.main #home .section-header::before {
        display: none !important;
      }

      button {
        padding: 4px 5px;
        font-size: 9px;
        min-height: 32px;
      }

      /* Even smaller summary cards */
      .summary-card {
        padding: 8px;
      }

      .summary-card .number {
        font-size: 16px;
      }

      .summary-card .label {
        font-size: 10px;
      }

      /* Ultra compact for very small devices */
      .main {
        padding: 8px 6px;
      }

      .action-buttons button {
        padding: 4px 5px;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Ultra compact tables */
      .data-table th,
      .data-table td {
        padding: 2px 1px;
      }

      .toggle-btn {
        display: none !important;
      }

      /* ========== ATTENDANCE CARD LAYOUT ENHANCEMENTS FOR 400px ========== */
      .attendance-card {
        padding: 12px;
        margin-bottom: 10px;
      }

      .attendance-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .attendance-card-name {
        font-size: 15px;
      }

      .attendance-card-status {
        font-size: 11px;
        padding: 5px 8px;
        align-self: flex-start;
      }

      .attendance-card-details {
        grid-template-columns: 1fr;
        gap: 6px;
      }

      .attendance-card-detail-row {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      .attendance-card-detail-label {
        font-size: 12px;
        min-width: 80px;
      }

      .attendance-card-detail-value {
        font-size: 12px;
        text-align: right;
      }

      .no-attendance-cards {
        padding: 20px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>

  <div id="spinner"></div>

  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay" id="mobileOverlay"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2>📊 Smart Attendance</h2>
    <a href="#" id="nav-home" onclick="showSection('home')" data-tooltip="Home"><i>🏠</i><span>Home</span></a>
    <a href="#" id="nav-attendance" onclick="showSection('attendance')"
      data-tooltip="Attendance"><i>📋</i><span>Attendance</span></a>
    <a href="#" id="nav-register" onclick="showSection('register')"
      data-tooltip="Register Plate"><i>📝</i><span>Register Plate</span></a>
    <a href="#" id="nav-user-management" onclick="showSection('user-management')" style="display:none"
      data-tooltip="User Management"><i>👥</i><span>User Management</span></a>
    <a href="#" id="nav-daily" onclick="showSection('daily')" style="display:none"
      data-tooltip="Daily"><i>📅</i><span>Daily</span></a>
    <a href="#" id="nav-weekly" onclick="showSection('weekly')" style="display:none"
      data-tooltip="Weekly"><i>🗓️</i><span>Weekly</span></a>
    <a href="#" id="nav-monthly" onclick="showSection('monthly')" style="display:none"
      data-tooltip="Monthly"><i>📆</i><span>Monthly</span></a>
    <a href="#" id="nav-workday" onclick="showSection('workday')" style="display:none"
      data-tooltip="Workday Manager"><i>🛠️</i><span>Workday</span></a>
    <a href="#" id="nav-settings" onclick="showSection('user-settings')"
      data-tooltip="Settings"><i>⚙️</i><span>Settings</span></a>
    <a href="#" onclick="logout()" data-tooltip="Logout"><i>🔓</i><span>Logout</span></a>
    <span class="toggle-btn" id="toggleBtn" onclick="toggleSidebar()">⬅️</span>
  </div>

  <!-- Main -->
  <div class="main">

    <!-- Home -->
    <div id="home" class="card section">
      <div class="section-header">
        <h3>Welcome</h3>
      </div>
      <p>Signed in as <strong id="userEmail">-</strong></p>
      <p id="userRoleInfo" class="small"></p>
    </div>

    <!-- Attendance Section Example -->
    <div id="attendance" class="card section" style="display:none">
      <div class="section-header">
        <h3>📋 Attendance Records</h3>
        <div class="action-buttons">
          <button onclick="loadAttendanceByDate()">
            <span class="icon">🔄</span>
            <span class="text"> Refresh</span>
          </button>
          <button class="admin-only" onclick="exportAttendanceData()">
            <span class="icon">📤</span>
            <span class="text"> Export</span>
          </button>
        </div>
      </div>

      <div class="filter-section compact-filter-section">
        <div>
          <label>Select Date</label>
          <input type="date" id="datePicker" onchange="loadAttendanceByDate()" />
        </div>
        <div class="admin-only">
          <label>Filter by Department</label>
          <select id="jabatanFilter" onchange="loadAttendanceByDate()">
            <option value="">ALL</option>
            <option>PENGARAH</option>
            <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
            <option>TIMBALAN PENGARAH AKADEMIK</option>
            <option>KETUA JAMINAN KUALITI</option>
            <option>JABATAN TEKNOLOGI AWAM</option>
            <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
            <option>JABATAN TEKNOLOGI MAKLUMAT</option>
            <option>JABATAN PERNIAGAAN</option>
            <option>JABATAN PENDIDIKAN UMUM</option>
            <option>UNIT PSIKOLOGI DAN KERJAYA</option>
          </select>
        </div>
        <div class="admin-only">
          <label>Search by Name</label>
          <input type="text" id="searchAttendance" placeholder="Enter name..." onkeyup="filterAttendanceTable()">
        </div>
      </div>

      <!-- Card Layout Container (for mobile users) -->
      <div class="mobile-attendance-cards" id="mobileAttendanceCards"></div>

      <!-- Table Layout (for desktop users) -->
      <div class="scroll-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Department</th>
              <th>Shift</th>
              <th>Status</th>
              <th>Checkin</th>
              <th>Checkout</th>
              <th>Worked Hours</th>
              <th>Punctuality</th>
            </tr>
          </thead>
          <tbody id="attendanceTable"></tbody>
        </table>
      </div>

      <!-- Enhanced Pagination Controls -->
      <div id="attendancePagination" class="pagination-controls admin-only">
        <div class="pagination-info" id="paginationInfo">Showing 0-0 of 0 records</div>
        <div class="pagination-buttons">
          <button id="firstPageBtn" onclick="goToPage(1)" disabled>⏮️ First</button>
          <button id="prevPageBtn" onclick="goToPreviousPage()" disabled>◀️Previous</button>
          <button id="nextPageBtn" onclick="goToNextPage()" disabled>Next ▶️</button>
          <button id="lastPageBtn" onclick="goToLastPage()" disabled>Last ⏭️</button>
        </div>
      </div>
    </div>

    <!-- Rest of your HTML sections remain the same -->
    <!-- Register (for regular users) -->
    <div id="register" class="card section" style="display:none">
      <div class="section-header">
        <h3>📝 Register Vehicle</h3>
        <div class="action-buttons">
          <button onclick="loadRegisteredVehicles()"><span class="icon">🔄</span><span class="text">
              Refresh</span></button>
        </div>
      </div>

      <div class="add-vehicle-form">
        <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">➕ Add New Vehicle</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="regPlate">Plate Number</label>
            <input type="text" id="regPlate" placeholder="">
          </div>
          <div class="form-group">
            <label for="regJawatan">Department</label>
            <select id="regJawatan">
              <option value="">Select Department</option>
              <option>PENGARAH</option>
              <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
              <option>TIMBALAN PENGARAH AKADEMIK</option>
              <option>KETUA JAMINAN KUALITI</option>
              <option>JABATAN TEKNOLOGI AWAM</option>
              <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
              <option>JABATAN TEKNOLOGI MAKLUMAT</option>
              <option>JABATAN PERNIAGAAN</option>
              <option>JABATAN PENDIDIKAN UMUM</option>
              <option>UNIT PSIKOLOGI DAN KERJAYA</option>
            </select>
          </div>
        </div>
        <button onclick="registerPlate()" style="margin-top: 8px;">✅ Register Vehicle</button>
        <p class="small" style="margin-top: 8px;">Your name <strong id="currentUserName"></strong> will be automatically
          used for registration.</p>
      </div>

      <div class="vehicle-list">
        <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">🚗 Your Registered Vehicles</h4>
        <div class="search-box">
          <input type="text" id="searchVehicles" placeholder="Search your vehicles..." onkeyup="filterVehicles()">
        </div>
        <div id="registeredVehicles"></div>
      </div>
    </div>

    <!-- User Management (for admin only) -->
    <div id="user-management" class="card section" style="display:none">
      <div class="section-header">
        <h3>👥 User Management</h3>
        <div class="action-buttons">
          <button onclick="loadUsers()"><span class="icon">🔄</span><span class="text"> Refresh</span></button>
        </div>
      </div>

      <div class="filter-section">
        <div class="form-group">
          <label for="userDepartmentFilter">Filter by Department</label>
          <select id="userDepartmentFilter" onchange="filterUsers()">
            <option value="">ALL</option>
            <option>PENGARAH</option>
            <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
            <option>TIMBALAN PENGARAH AKADEMIK</option>
            <option>KETUA JAMINAN KUALITI</option>
            <option>JABATAN TEKNOLOGI AWAM</option>
            <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
            <option>JABATAN TEKNOLOGI MAKLUMAT</option>
            <option>JABATAN PERNIAGAAN</option>
            <option>JABATAN PENDIDIKAN UMUM</option>
            <option>UNIT PSIKOLOGI DAN KERJAYA</option>
          </select>
        </div>
        <div class="form-group">
          <label for="searchUser">Search User</label>
          <input type="text" id="searchUser" placeholder="Search User..." onkeyup="filterUsers()">
        </div>
      </div>

      <div class="scroll-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Department</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="userTable"></tbody>
        </table>
      </div>

      <div class="pagination-controls">
        <div class="pagination-info" id="userPaginationInfoBottom">Showing 1-25 of 0 users</div>
        <div class="pagination-buttons">
          <button id="userFirstPageBtn" onclick="goToUserPage(1)" disabled>⏮️ First</button>
          <button id="userPrevPageBtn" onclick="goToPreviousUserPage()" disabled>◀️ Previous</button>
          <button id="userNextPageBtn" onclick="goToNextUserPage()" disabled>Next ▶️</button>
          <button id="userLastPageBtn" onclick="goToLastUserPage()" disabled>Last ⏭️</button>
        </div>
      </div>
    </div>

    <!-- User Detail Page (for admin only) -->
    <div id="user-detail" class="card section" style="display:none">
      <div class="section-header">
        <h3 id="userDetailTitle">User Profile</h3>
        <div class="action-buttons">
          <button onclick="showSection('user-management')"><span class="icon">←</span><span class="text">
              Back</span></button>
        </div>
      </div>

      <div class="user-detail-section">
        <h4>📋 Basic Information</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="userDetailName">Name</label>
            <input type="text" id="userDetailName" class="auto-capitalize" readonly>
          </div>
          <div class="form-group">
            <label for="userDetailDepartment">Department</label>
            <input type="text" id="userDetailDepartment" readonly>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="userDetailEmail">Email</label>
            <input type="text" id="userDetailEmail" readonly>
          </div>
          <div class="form-group">
            <label for="userDetailRFID">RFID UID</label>
            <input type="text" id="userDetailRFID" class="rfid-input" placeholder="E4F77C05"
              oninput="this.value = this.value.toUpperCase()">
          </div>
        </div>
      </div>

      <div class="user-detail-section">
        <h4>🚗 Registered Vehicles</h4>
        <div id="userVehiclesList"></div>
        <p class="small" style="margin-top: 10px; color: #64748b;">
        </p>
      </div>

      <div class="user-detail-section">
        <h4>⚙️ Admin Actions</h4>
        <div class="user-actions">
          <button onclick="saveUserRFID()">Save RFID UID</button>
          <button onclick="toggleUserStatus()" id="toggleUserStatusBtn">Deactivate User</button>
          <button onclick="deleteUser()" id="deleteUserBtn" style="background:#dc2626;">🗑️ Delete User</button>
        </div>
      </div>
    </div>

    <!-- Daily - FIXED VERSION -->
    <div id="daily" class="card section" style="display:none">
      <div class="section-header">
        <h3>📅 Daily Status</h3>
        <div class="action-buttons">
          <button onclick="calculateDailyStatus()"><span class="icon">🔄</span><span class="text">
              Refresh</span></button>
        </div>
      </div>

      <div class="filter-section admin-only compact-filter-section">
        <div>
          <label>Filter by Department</label>
          <select id="jabatanFilterDaily" onchange="calculateDailyStatus()">
            <option value="">All</option>
            <option>PENGARAH</option>
            <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
            <option>TIMBALAN PENGARAH AKADEMIK</option>
            <option>KETUA JAMINAN KUALITI</option>
            <option>JABATAN TEKNOLOGI AWAM</option>
            <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
            <option>JABATAN TEKNOLOGI MAKLUMAT</option>
            <option>JABATAN PERNIAGAAN</option>
            <option>JABATAN PENDIDIKAN UMUM</option>
            <option>UNIT PSIKOLOGI DAN KERJAYA</option>
          </select>
        </div>
        <div>>
          <label>Filter by Status</label>
          <select id="statusFilterDaily" onchange="filterByStatus()">
            <option value="All">All Status</option>
            <option value="Present">Present</option>
            <option value="Late">Late</option>
            <option value="Absent">Absent</option>
          </select>
        </div>
        <div>
          <label>Search by Name</label>
          <input type="text" id="searchDaily" placeholder="Search by name..." onkeyup="filterDailyTable()">
        </div>
      </div>

      <!-- Date Info Display -->
      <div id="dailyDateInfo" class="daily-date-info"></div>

      <div class="scroll-container">
        <div id="dailyStatusTable"></div>
      </div>

      <!-- Daily Status Pagination Controls Bottom -->
      <div id="dailyPaginationBottom" class="pagination-controls admin-only">
        <div class="pagination-info" id="dailyPaginationInfoBottom">Showing 0-0 of 0 records</div>
        <div class="pagination-buttons">
          <button id="dailyFirstPageBtnBottom" onclick="goToDailyPage(1)" disabled>⏮️ First</button>
          <button id="dailyPrevPageBtnBottom" onclick="goToPreviousDailyPage()" disabled>◀️ Previous</button>
          <button id="dailyNextPageBtnBottom" onclick="goToNextDailyPage()" disabled>Next ▶️</button>
          <button id="dailyLastPageBtnBottom" onclick="goToLastDailyPage()" disabled>Last ⏭️</button>
        </div>
      </div>
    </div>

    <!-- Weekly Report -->
    <div id="weekly" class="card section" style="display:none">
      <div class="section-header">
        <h3>🗓️ Weekly Attendance Report</h3>
        <div class="action-buttons">
          <button onclick="calculateWeeklySummary()" title="Refresh Summary"><span class="icon">🔄</span><span
              class="text"> Refresh</span></button>
        </div>
      </div>

      <!-- Filters -->
      <div class="filter-section admin-only">
        <div>
          <label>Week containing date:</label>
          <input type="date" id="weekPicker" onchange="calculateWeeklySummary()" />
        </div>
        <div>
          <label>Filter Department:</label>
          <select id="weekJabatanFilter" onchange="calculateWeeklySummary()">
            <option value="">All Departments</option>
            <option>PENGARAH</option>
            <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
            <option>TIMBALAN PENGARAH AKADEMIK</option>
            <option>KETUA JAMINAN KUALITI</option>
            <option>JABATAN TEKNOLOGI AWAM</option>
            <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
            <option>JABATAN TEKNOLOGI MAKLUMAT</option>
            <option>JABATAN PERNIAGAAN</option>
            <option>JABATAN PENDIDIKAN UMUM</option>
            <option>UNIT PSIKOLOGI DAN KERJAYA</option>
          </select>
        </div>
      </div>

      <!-- Layout -->
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;">
        <div style="flex:1;min-width:280px;">
          <div class="card admin-only" style="margin-top:12px;">
            <h4 style="margin:0 0 10px 0;color:#1e293b;font-size:16px;">📈 Attendance Trend</h4>
            <canvas id="weeklyChart" height="220"></canvas>
          </div>
        </div>

        <div style="flex:2;min-width:500px;">
          <div class="card" style="margin-top:12px;">
            <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:16px;">👥 Staff Attendance Details</h4>
            <div class="search-box admin-only">
              <input type="text" id="searchWeekly" placeholder="Search by name..." onkeyup="filterWeeklyTable()">
            </div>
            <div class="scroll-container">
              <div id="weeklyDetailGrid"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly - UPDATED VERSION (with Pagination for Summary Table) -->
    <div id="monthly" class="card section" style="display:none">
      <div class="section-header">
        <h3>📆 Monthly Summary</h3>
        <div class="action-buttons">
          <button onclick="calculateMonthlySummary()"><span class="icon">🔄</span><span class="text">
              Refresh</span></button>
        </div>
      </div>

      <!-- Compact Filter Section -->
      <div class="filter-section admin-only compact-filter-section">
        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <label style="margin: 0; font-size: 13px; font-weight: 500;">Month:</label>
            <select id="monthSelect" style="width: 100px; padding: 6px; font-size: 13px;"></select>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <label style="margin: 0; font-size: 13px; font-weight: 500;">Year:</label>
            <select id="yearSelect" style="width: 90px; padding: 6px; font-size: 13px;"></select>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <label style="margin: 0; font-size: 13px; font-weight: 500;">Department:</label>
            <select id="monthJabatanFilter" style="width: 180px; padding: 6px; font-size: 13px;"
              onchange="calculateMonthlySummary()">
              <option value="">ALL</option>
              <option>PENGARAH</option>
              <option>TIMBALAN PENGARAH SOKONGAN AKADEMIK</option>
              <option>TIMBALAN PENGARAH AKADEMIK</option>
              <option>KETUA JAMINAN KUALITI</option>
              <option>JABATAN TEKNOLOGI AWAM</option>
              <option>JABATAN TEKNOLOGI ELEKTRIK DAN ELEKTRONIK</option>
              <option>JABATAN TEKNOLOGI MAKLUMAT</option>
              <option>JABATAN PERNIAGAAN</option>
              <option>JABATAN PENDIDIKAN UMUM</option>
              <option>UNIT PSIKOLOGI DAN KERJAYA</option>
            </select>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <label style="margin: 0; font-size: 13px; font-weight: 500;">Search:</label>
            <input type="text" id="searchMonthly" placeholder="Search by name..."
              style="width: 180px; padding: 6px; font-size: 13px;" onkeyup="filterMonthlyTable()">
          </div>
        </div>
      </div>

      <!-- Larger Chart -->
      <div class="card admin-only" style="margin-bottom: 16px;">
        <h4 class="monthly-header">📊 Monthly Attendance Overview</h4>
        <canvas id="monthlyChart" height="250"></canvas>
      </div>

      <!-- Summary Table with Pagination -->
      <div class="card">
        <h4 class="monthly-header">📋Summary Details</h4>
        <div id="monthlySummaryTable"></div>

        <!-- Monthly Summary Pagination Controls -->
        <div id="monthlyPaginationBottom" class="pagination-controls admin-only">
          <div class="pagination-info" id="monthlyPaginationInfoBottom">Showing 0-0 of 0 users</div>
          <div class="pagination-buttons">
            <button id="monthlyFirstPageBtnBottom" onclick="goToMonthlyPage(1)" disabled>⏮️ First</button>
            <button id="monthlyPrevPageBtnBottom" onclick="goToPreviousMonthlyPage()" disabled>◀️ Previous</button>
            <button id="monthlyNextPageBtnBottom" onclick="goToNextMonthlyPage()" disabled>Next ▶️</button>
            <button id="monthlyLastPageBtnBottom" onclick="goToLastMonthlyPage()" disabled>Last ⏭️</button>
          </div>
        </div>
      </div>
    </div>
    <!-- User Monthly Detail -->
    <div id="user-monthly-detail" class="card section" style="display:none">
      <div class="user-monthly-header">
        <div class="user-monthly-info">
          <h3 id="userMonthlyTitle">User Monthly Details</h3>
          <div id="userMonthlyPeriod" class="small"></div>
        </div>
        <div class="action-buttons">
          <button onclick="showSection('monthly')">
            <span class="icon">←</span>
            <span class="text"> Back to Monthly</span>
          </button>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="user-monthly-stats" id="userMonthlyStats">
        <!-- Stats will be populated by JavaScript -->
      </div>

      <!-- Calendar View -->
      <div class="user-calendar-container">
        <div class="user-calendar-headers">
          <div class="user-cal-header">Sun</div>
          <div class="user-cal-header">Mon</div>
          <div class="user-cal-header">Tue</div>
          <div class="user-cal-header">Wed</div>
          <div class="user-cal-header">Thu</div>
          <div class="user-cal-header">Fri</div>
          <div class="user-cal-header">Sat</div>
        </div>
        <div id="userCalendarGrid" class="user-calendar">
          <!-- Calendar will be populated by JavaScript -->
        </div>
      </div>

      <!-- Details Panel -->
      <div id="detailsPanel" class="details-panel">
        <div class="detail-header">
          <h4 class="detail-title" id="detailDateTitle">Date Details</h4>
          <button class="detail-close" onclick="closeDetailsPanel()">×</button>
        </div>
        <div class="detail-content" id="detailContent">
          <!-- Details will be populated by JavaScript -->
        </div>
      </div>

      <!-- Loading State -->
      <div id="calendarLoading" class="calendar-loading">
        Loading calendar data...
      </div>

      <!-- Empty State -->
      <div id="calendarEmpty" class="empty-calendar" style="display:none">
        <div class="empty-calendar-icon">📅</div>
        <h4>No data available</h4>
        <p>No attendance data found for this user and period.</p>
      </div>
    </div>

    <!-- Workday Manager (admin only) - UPDATED VERSION -->
    <div id="workday" class="card section" style="display:none">
      <div class="section-header">
        <h3>🛠️ Workday Manager</h3>
        <div class="action-buttons">
          <button onclick="renderCalendar(currentCalendarYear,currentCalendarMonth)"><span class="icon">🔄</span><span
              class="text"> Refresh</span></button>
        </div>
      </div>

      <!-- Year/Month Selector Controls -->
      <div class="workday-controls">
        <div class="workday-selector-group">
          <div class="selector-container">
            <label for="yearSelectWorkday" class="selector-label">Year:</label>
            <select id="yearSelectWorkday" class="year-selector" onchange="onYearMonthChange()">
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>
          <div class="selector-container">
            <label for="monthSelectWorkday" class="selector-label">Month:</label>
            <select id="monthSelectWorkday" class="month-selector" onchange="onYearMonthChange()">
              <option value="0">January</option>
              <option value="1">February</option>
              <option value="2">March</option>
              <option value="3">April</option>
              <option value="4">May</option>
              <option value="5">June</option>
              <option value="6">July</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">October</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
        </div>

        <div class="workday-action-buttons">
          <button onclick="clearSelection()" style="background:#ef4444;" class="workday-btn-clear">Clear
            Selection</button>
          <button onclick="saveVisibleWorkdays()" style="background:#10b981;" class="workday-btn-save">Save All</button>
        </div>
      </div>
      <!-- Calendar Grid with Day Headers -->
      <div class="calendar-container">
        <!-- Day of Week Headers -->
        <div class="calendar-headers">
          <div class="cal-header">Sun</div>
          <div class="cal-header">Mon</div>
          <div class="cal-header">Tue</div>
          <div class="cal-header">Wed</div>
          <div class="cal-header">Thu</div>
          <div class="cal-header">Fri</div>
          <div class="cal-header">Sat</div>
        </div>
        <div id="calendarGrid" class="calendar" aria-hidden="false"></div>

        <div id="workdayStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none;"></div>
      </div>
    </div>


    <!-- Settings -->
    <div id="user-settings" class="card section" style="display:none">
      <div class="section-header">
        <h3>⚙️ Settings</h3>
      </div>

      <!-- User Name Settings -->
      <div class="settings-section">
        <h4>👤 Your Profile</h4>
        <div class="form-group">
          <label for="userNameInput">Your Display Name:</label>
          <input type="text" id="userNameInput" class="auto-capitalize"
            placeholder="Enter your name as it appears in attendance records" oninput="autoCapitalize(this)">
          <button onclick="updateUserName()" style="margin-top: 8px;">💾 Update Name</button>
        </div>
      </div>
    </div>

  </div>

  <div id="snackbar"></div>

  <script>
    // ========== Firebase config ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDXM92nMwpSqPVWifILYeDMTMEh_fuhN5M",
      authDomain: "drive-thru-smartattendance.firebaseapp.com",
      databaseURL: "https://drive-thru-smartattendance-default-rtdb.asia-southeast1.firebasedatabase.app", // FIXED URL
      projectId: "drive-thru-smartattendance",
      storageBucket: "drive-thru-smartattendance.appspot.com",
      messagingSenderId: "235048051665",
      appId: "1:235048051665:web:a8c68cc40eb83946e9f6f0"
    };

    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (error) {
      console.log('Firebase already initialized');
    }

    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);
    const db = firebase.database();

    // ========== Enhanced Mobile Menu Functionality ==========
    function setupMobileMenu() {
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('sidebar');
      const mobileOverlay = document.getElementById('mobileOverlay');

      if (mobileMenuBtn && sidebar && mobileOverlay) {
        mobileMenuBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          sidebar.classList.toggle('mobile-open');
          mobileOverlay.classList.toggle('active');
          document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
        });

        mobileOverlay.addEventListener('click', function () {
          sidebar.classList.remove('mobile-open');
          mobileOverlay.classList.remove('active');
          document.body.style.overflow = '';
        });

        // Close menu when clicking on a link - FIXED VERSION
        document.querySelectorAll('.sidebar a').forEach(link => {
          link.addEventListener('click', function (e) {
            sidebar.classList.remove('mobile-open');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';

            // Allow the click to proceed to section navigation
            setTimeout(() => {
              const sectionId = this.getAttribute('onclick')?.match(/showSection\('([^']+)'\)/)?.[1];
              if (sectionId) {
                showSection(sectionId);
              }
            }, 100);
          });
        });

        // Close menu when window is resized to desktop
        window.addEventListener('resize', function () {
          if (window.innerWidth > 900) {
            sidebar.classList.remove('mobile-open');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
          }
        });
      }
    }
    // AGGRESSIVE mobile chart fix - GUARANTEED no skipping
    function setupMobileChartAggressive() {
      if (window.innerWidth > 900) return;

      if (window.monthlyChart) {
        // COMPLETELY override Chart.js auto behavior
        monthlyChart.options.scales.x = {
          type: 'category',
          offset: true,
          ticks: {
            autoSkip: false,
            maxRotation: 90,
            minRotation: 90,
            padding: 12,
            font: {
              size: 10,
              family: "'Poppins', sans-serif"
            },
            callback: function (value, index) {
              // Force display of all labels
              return (index + 1).toString().padStart(2, '0');
            }
          },
          grid: {
            display: true,
            drawBorder: true
          }
        };

        monthlyChart.options.layout = {
          padding: {
            left: 10,
            right: 10,
            top: 10,
            bottom: 70
          }
        };

        monthlyChart.update();
        console.log('📱 AGGRESSIVE: Mobile chart with forced vertical labels');
      }
    }
    // Add this to your calculateMonthlySummary() function
    // RIGHT AFTER creating the monthlyChart:

    // FIXED: Mobile chart configuration
    function configureChartForMobile() {
      if (window.innerWidth <= 900 && monthlyChart) {
        console.log('📱 Configuring chart for mobile...');

        monthlyChart.options.scales.x.ticks.autoSkip = false;
        monthlyChart.options.scales.x.ticks.maxTicksLimit = null;
        monthlyChart.options.scales.x.ticks.minRotation = 90;
        monthlyChart.options.scales.x.ticks.maxRotation = 90;
        monthlyChart.options.scales.x.ticks.padding = 15;

        // Add more bottom padding for vertical labels
        if (!monthlyChart.options.layout) monthlyChart.options.layout = {};
        monthlyChart.options.layout.padding = {
          bottom: 60,
          left: 10,
          right: 10,
          top: 10
        };

        monthlyChart.update();
        console.log('✅ Mobile chart configured with vertical labels');
      }
    }

    // Call it after chart creation
    setTimeout(configureChartForMobile, 150);

    // Also call on resize
    window.addEventListener('resize', configureChartForMobile);

    // ========== Mobile Menu Button Visibility Based on Section Header ==========
    let lastScrollTop = 0;
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    let isMobileMenuButtonVisible = true;

    function handleMobileMenuScroll() {
      if (window.innerWidth > 900) return; // Only on mobile

      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const sectionHeader = getCurrentSectionHeader();

      if (!sectionHeader) {
        // If no section header found, show the button
        showMobileMenuButton();
        return;
      }

      const headerRect = sectionHeader.getBoundingClientRect();
      const headerVisible = headerRect.top >= 0 && headerRect.bottom <= window.innerHeight;

      if (headerVisible) {
        // Section header is fully visible - show button
        showMobileMenuButton();
      } else {
        // Section header is not visible - hide button
        hideMobileMenuButton();
      }

      lastScrollTop = scrollTop;
    }

    function getCurrentSectionHeader() {
      // Find the currently visible section
      const sections = document.querySelectorAll('.section');
      let currentSection = null;

      for (const section of sections) {
        if (section.style.display === 'block') {
          currentSection = section;
          break;
        }
      }

      if (!currentSection) return null;

      // Find the section header within the current section
      return currentSection.querySelector('.section-header');
    }

    function showMobileMenuButton() {
      if (!isMobileMenuButtonVisible) {
        mobileMenuBtn.style.transform = 'translateY(0)';
        mobileMenuBtn.style.opacity = '1';
        isMobileMenuButtonVisible = true;
      }
    }

    function hideMobileMenuButton() {
      if (isMobileMenuButtonVisible) {
        mobileMenuBtn.style.transform = 'translateY(-100px)';
        mobileMenuBtn.style.opacity = '0';
        isMobileMenuButtonVisible = false;
      }
    }

    // Add scroll event listener with throttling
    let scrollTimeout;
    window.addEventListener('scroll', function () {
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }

      scrollTimeout = setTimeout(() => {
        handleMobileMenuScroll();
      }, 50); // Throttle to improve performance
    });

    // Reset on resize and initial load
    window.addEventListener('resize', function () {
      if (window.innerWidth > 900) {
        showMobileMenuButton();
      } else {
        // Re-check visibility on mobile resize
        setTimeout(handleMobileMenuScroll, 100);
      }
    });

    // Initial check
    setTimeout(handleMobileMenuScroll, 500);

    // Reset on resize
    window.addEventListener('resize', function () {
      if (window.innerWidth > 900) {
        mobileMenuBtn.style.transform = 'translateY(0)';
        mobileMenuBtn.style.opacity = '1';
      }
    });
    function showSpinner() {
      document.getElementById('spinner').style.display = 'block';
    }

    function hideSpinner() {
      document.getElementById('spinner').style.display = 'none';
    }

    function showSnackbar(msg) {
      const sb = document.getElementById('snackbar');
      sb.textContent = msg;
      sb.className = "show";
      setTimeout(() => sb.className = "", 3000);
    }

    function normalizePlate(txt) {
      return (txt || '').trim().toUpperCase().replace(/\s+/g, '');
    }

    function pad(n) {
      return n.toString().padStart(2, '0');
    }

    function ymdFromDate(d) {
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function isDefaultWorkdayObj(dateObj) {
      const dow = dateObj.getDay();
      return (dow >= 1 && dow <= 5);
    }

    function isDefaultWorkdayISO(iso) {
      const parts = iso.split('-').map(x => parseInt(x, 10));
      return isDefaultWorkdayObj(new Date(parts[0], parts[1] - 1, parts[2]));
    }

    function parseTimeToMinutes(t) {
      if (!t || typeof t !== 'string') return null;
      const m = t.match(/(\d{1,2}):(\d{2})/);
      if (!m) return null;
      return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
    }

    // FIXED: Simple todayISO()
    function todayISO() {
      const now = new Date();

      // Debug info
      console.log('🕒 TIME DEBUG:', {
        UTC: now.toISOString(),
        Local: now.toString(),
        Hours: now.getHours(),
        Date: now.getDate()
      });

      // Simple local date (akan auto-adjust untuk timezone Malaysia)
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');

      const result = `${year}-${month}-${day}`;
      console.log('📅 todayISO() RESULT:', result);

      return result;
    }

    // ========== AUTO CAPITALIZE FUNCTION ==========
    function autoCapitalize(input) {
      const start = input.selectionStart;
      const end = input.selectionEnd;

      input.value = input.value
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');

      input.setSelectionRange(start, end);
    }

    // Workdays cache
    let workdaysCache = {};
    let selectedDatesSet = new Set();

    // Chart instances
    let weeklyChartInstance = null;
    let monthlyChart = null;

    // Pagination variables
    let currentAttendancePage = 1;
    const attendancePerPage = 10;
    let totalAttendanceRecords = 0;
    let totalAttendancePages = 0;

    // User management
    let currentUser = null;
    let isAdmin = false;
    let userPlates = [];
    let userName = '';

    // User Management Variables
    let currentUserPage = 1;
    const usersPerPage = 25;
    let totalUsers = 0;
    let totalUserPages = 0;
    let allUsers = [];
    let currentEditingUser = null;

    // Daily Status Pagination Variables
    let currentDailyPage = 1;
    const dailyPerPage = 10;
    let totalDailyRecords = 0;
    let totalDailyPages = 0;
    let allDailyRecords = [];

    // Global plates data for department lookup
    let allPlatesData = {};

    // Calendar rendering control
    let isRenderingCalendar = false;
    let lastRenderCall = { year: null, month0: null };

    // Workday modifications
    let modifiedDates = new Map();
    let workdaysFullSnapshot = null;

    // ========== USER PROFILE SYSTEM ==========
    function extractNameFromEmail(email) {
      if (!email) return 'User';
      const namePart = email.split('@')[0];
      const cleanName = namePart.replace(/[0-9._-]/g, ' ').trim();
      if (!cleanName) return 'User';
      return cleanName
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }

    // IMPROVED: Better name matching function
    function matchByNameVariations(attendanceName, userName) {
      if (!attendanceName || !userName) return false;

      const cleanAttendance = attendanceName.toLowerCase().replace(/\s+/g, ' ').trim();
      const cleanUser = userName.toLowerCase().replace(/\s+/g, ' ').trim();

      // Exact match
      if (cleanAttendance === cleanUser) return true;

      // First name match
      const attendanceFirst = cleanAttendance.split(' ')[0];
      const userFirst = cleanUser.split(' ')[0];
      if (attendanceFirst && userFirst && attendanceFirst === userFirst) return true;

      // Contains match
      if (cleanAttendance.includes(cleanUser) || cleanUser.includes(cleanAttendance)) return true;

      // Initials match (for cases like "N Shah" vs "Naufal Shah")
      const attendanceWords = cleanAttendance.split(' ');
      const userWords = cleanUser.split(' ');

      if (attendanceWords.length > 0 && userWords.length > 0) {
        const attendanceInitials = attendanceWords.map(n => n[0]).join('');
        const userInitials = userWords.map(n => n[0]).join('');
        if (attendanceInitials === userInitials) return true;
      }

      return false;
    }

    // NEW HELPER FUNCTIONS untuk color coding
    function getStatusColor(status) {
      const lowerS = (status || "").toLowerCase();
      if (lowerS.includes("present") || lowerS.includes("complete")) {
        return "color:#10b981;font-weight:500;";
      } else if (lowerS.includes("incomplete")) {
        return "color:#f59e0b;font-weight:500;";
      } else if (lowerS.includes("absent")) {
        return "color:#ef4444;font-weight:500;";
      }
      return "color:#334155;font-weight:500;";
    }

    function getPunctualityColor(punctuality) {
      const lowerP = (punctuality || "").toLowerCase();
      if (lowerP.includes("late")) {
        return "color:#ef4444;font-weight:500;";
      } else if (lowerP.includes("punctual") || lowerP.includes("on time")) {
        return "color:#10b981;font-weight:500;";
      }
      return "color:#334155;font-weight:500;";
    }

    // NEW FUNCTION: Render attendance cards untuk mobile users
    function renderAttendanceCards(records) {
      const container = document.getElementById('mobileAttendanceCards');

      if (!records || records.length === 0) {
        container.innerHTML = '<div class="no-attendance-cards">No attendance records found for selected date.</div>';
        return;
      }

      let cardsHtml = '';

      records.forEach(record => {
        const status = record.status || '-';
        const shift = record.shift || '-';
        const checkin = record.checkin || '-';
        const checkout = record.checkout || '-';
        const workedHours = record.workedHours || '-';
        const punctuality = record.punctuality || '-';

        // Determine status class
        let statusClass = 'holiday';
        if (status.toLowerCase().includes('present')) {
          statusClass = 'present';
        } else if (status.toLowerCase().includes('late')) {
          statusClass = 'late';
        } else if (status.toLowerCase().includes('absent')) {
          statusClass = 'absent';
        }

        cardsHtml += `
      <div class="attendance-card">
        <div class="attendance-card-header">
          <div class="attendance-card-name">${record.name}</div>
          <div class="attendance-card-status ${statusClass}">${status}</div>
        </div>
        <div class="attendance-card-department">
          <span class="attendance-card-department-icon">🏢</span>
          <span>${record.jabatan || '-'}</span>
        </div>
        <div class="attendance-card-details">
          <div class="attendance-card-detail-row">
            <span class="attendance-card-detail-label">
              <span>📥 IN</span>
            </span>
            <span class="attendance-card-detail-value">${checkin}</span>
          </div>
          <div class="attendance-card-detail-row">
            <span class="attendance-card-detail-label">
              <span>📤 OUT</span>
            </span>
            <span class="attendance-card-detail-value">${checkout}</span>
          </div>
          <div class="attendance-card-detail-row">
            <span class="attendance-card-detail-label">
              <span>⏰ HRS</span>
            </span>
            <span class="attendance-card-detail-value">${workedHours}</span>
          </div>
          <div class="attendance-card-detail-row">
            <span class="attendance-card-detail-label">
              <span>🎯 PUNCTUALITY</span>
            </span>
            <span class="attendance-card-detail-value">${punctuality || '-'}</span>
          </div>
        </div>
      </div>
    `;
      });

      container.innerHTML = cardsHtml;
    }

    // IMPROVED: Find attendance record dengan better matching
    function findAttendanceRecord(attendanceData, staffName) {
      if (!attendanceData || !staffName) return null;

      const cleanStaffName = staffName.toLowerCase().trim();

      for (const uid in attendanceData) {
        const record = attendanceData[uid];
        if (!record.name) continue;

        const cleanRecordName = record.name.toLowerCase().trim();

        // Exact match
        if (cleanRecordName === cleanStaffName) {
          return record;
        }

        // Partial match (first word)
        const staffFirstWord = cleanStaffName.split(' ')[0];
        const recordFirstWord = cleanRecordName.split(' ')[0];

        if (staffFirstWord && recordFirstWord && staffFirstWord === recordFirstWord) {
          return record;
        }
      }

      return null;
    }

    // NEW FUNCTION: Sync plates dengan nama baru
    async function syncPlatesWithNewName(newName) {
      try {
        const platesSnapshot = await db.ref('plates').once('value');
        const plates = platesSnapshot.val() || {};

        const updates = {};
        let updatedPlatesCount = 0;

        // Cari semua plates yang registered oleh user ini
        Object.keys(plates).forEach(plate => {
          const vehicle = plates[plate];

          // Check jika plate ini belong kepada current user
          const isUserPlate = (
            vehicle.registeredBy === currentUser.email ||
            matchByNameVariations(vehicle.name, userName)
          );

          if (isUserPlate) {
            updates[`plates/${plate}/name`] = newName;
            updatedPlatesCount++;
          }
        });

        // Apply updates jika ada plates yang perlu diupdate
        if (updatedPlatesCount > 0) {
          await db.ref().update(updates);
          console.log(`✅ Updated ${updatedPlatesCount} plates with new name: ${newName}`);
        }

        return updatedPlatesCount;

      } catch (err) {
        console.error('Error syncing plates:', err);
        throw err;
      }
    }

    // NEW FUNCTION: Check dan sync plates jika out of sync
    async function checkAndSyncPlates(currentUserName) {
      try {
        const platesSnapshot = await db.ref('plates').once('value');
        const plates = platesSnapshot.val() || {};

        let needsSync = false;
        const updates = {};

        Object.keys(plates).forEach(plate => {
          const vehicle = plates[plate];

          // Jika plate registered oleh user ini tapi nama tidak match
          if (vehicle.registeredBy === currentUser.email &&
            !matchByNameVariations(vehicle.name, currentUserName)) {
            updates[`plates/${plate}/name`] = currentUserName;
            needsSync = true;
          }
        });

        if (needsSync) {
          await db.ref().update(updates);
          console.log('✅ Auto-synced plates with current profile name');
        }

      } catch (err) {
        console.error('Error checking plate sync:', err);
      }
    }

    async function ensureUserProfile() {
      const userRef = db.ref('users/' + currentUser.uid);

      try {
        const snapshot = await userRef.once('value');

        if (!snapshot.exists()) {
          const userNameFromEmail = extractNameFromEmail(currentUser.email);
          await userRef.set({
            email: currentUser.email,
            name: userNameFromEmail,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
          });
          userName = userNameFromEmail;

          // Auto-sync existing plates dengan nama baru
          await syncPlatesWithNewName(userNameFromEmail);

        } else {
          const userData = snapshot.val();
          userName = userData.name;
          await userRef.update({
            lastLogin: new Date().toISOString()
          });

          // Check dan sync plates jika perlu
          await checkAndSyncPlates(userName);
        }

        document.getElementById('userRoleInfo').textContent = isAdmin ?
          'You are logged in as Administrator' : `You are logged in as ${userName}`;

        document.getElementById('currentUserName').textContent = userName;

        const nameInput = document.getElementById('userNameInput');
        if (nameInput) {
          nameInput.value = userName;
        }

      } catch (err) {
        console.error('Error ensuring user profile:', err);
        userName = extractNameFromEmail(currentUser.email);
      }
    }

    async function updateUserName() {
      const nameInput = document.getElementById('userNameInput');
      let newName = nameInput.value.trim();

      if (!newName) {
        showSnackbar('❌ Please enter a valid name');
        return;
      }

      newName = newName
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');

      showSpinner();
      try {
        const userRef = db.ref('users/' + currentUser.uid);

        // Update user profile
        await userRef.update({
          name: newName,
          updatedAt: new Date().toISOString()
        });

        // AUTO-SYNC: Update semua plates yang belong kepada user ini
        const updatedPlatesCount = await syncPlatesWithNewName(newName);

        userName = newName;

        if (updatedPlatesCount > 0) {
          showSnackbar(`✅ Name updated successfully - ${updatedPlatesCount} vehicle(s) updated too!`);
        } else {
          showSnackbar('✅ Name updated successfully');
        }

        document.getElementById('userRoleInfo').textContent = isAdmin ?
          'You are logged in as Administrator' : `You are logged in as ${userName}`;

        document.getElementById('currentUserName').textContent = userName;

      } catch (err) {
        showSnackbar('❌ Failed to update name: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    // ========== Existing Workday Helper Functions ==========
    async function ensureWorkdaysLoadedOnce() {
      console.log("🔄 Loading FRESH workday data...");
      showSpinner();
      try {
        const snap = await db.ref('settings/workdays').once('value');
        const freshData = snap.exists() ? (snap.val() || {}) : {};

        console.log("✅ Fresh workday data loaded:", freshData);

        // FIX: Completely reset cache
        workdaysCache = {};

        // Rebuild cache from fresh data
        Object.keys(freshData).forEach(iso => {
          const key = iso.slice(0, 7); // "YYYY-MM"
          if (!(key in workdaysCache)) workdaysCache[key] = {};
          workdaysCache[key][iso] = freshData[iso];
        });

        // FIX: Mark months that exist in the date range but have no overrides
        // This prevents empty cache entries from causing unnecessary reloads
        const allMonthsInData = new Set();
        Object.keys(freshData).forEach(iso => {
          allMonthsInData.add(iso.slice(0, 7));
        });

        console.log("✅ Months with data:", Array.from(allMonthsInData));

        workdaysFullSnapshot = freshData;

        console.log("✅ Cache rebuilt:", workdaysCache);
        return freshData;
      } catch (err) {
        console.error('Failed to load settings/workdays:', err);
        showSnackbar('❌ Failed to load workday overrides.');
        workdaysFullSnapshot = {};
        return workdaysFullSnapshot;
      } finally {
        hideSpinner();
      }
    }

    async function loadWorkdaysRange(startISO, endISO) {
      console.log("🔄 loadWorkdaysRange CALLED for:", startISO, "to", endISO);

      // FIX: Always ensure workdaysCache is initialized
      if (!workdaysCache) {
        workdaysCache = {};
      }

      const s = startISO.split('-').map(x => parseInt(x, 10));
      const e = endISO.split('-').map(x => parseInt(x, 10));
      const startMonth = new Date(s[0], s[1] - 1, 1);
      const endMonth = new Date(e[0], e[1] - 1, 1);

      console.log("📅 Range months:",
        `${startMonth.getFullYear()}-${startMonth.getMonth() + 1}`,
        "to",
        `${endMonth.getFullYear()}-${endMonth.getMonth() + 1}`
      );

      // FIX: Improved cache checking - detect EMPTY cache entries
      let needsRefresh = false;
      const cursor = new Date(startMonth);

      while (cursor <= endMonth) {
        const key = `${cursor.getFullYear()}-${pad(cursor.getMonth() + 1)}`;
        const cacheExists = key in workdaysCache;
        const cacheHasData = cacheExists && workdaysCache[key] && Object.keys(workdaysCache[key]).length > 0;

        console.log("🔍 Checking cache for:", key, "exists:", cacheExists, "hasData:", cacheHasData);

        if (!cacheExists || !cacheHasData) {
          needsRefresh = true;
          console.log("🔄 Need to refresh -", !cacheExists ? "missing" : "empty", "cache for:", key);
          break;
        }

        cursor.setMonth(cursor.getMonth() + 1);
      }

      if (needsRefresh) {
        console.log("🔄 Refreshing workday data due to missing/empty cache...");
        await ensureWorkdaysLoadedOnce();
      } else {
        console.log("✅ Using cached data - all months have data");
      }

      // FIX: Build combined data from cache
      const combined = {};
      const combinedCursor = new Date(startMonth);

      while (combinedCursor <= endMonth) {
        const key = `${combinedCursor.getFullYear()}-${pad(combinedCursor.getMonth() + 1)}`;
        const map = workdaysCache[key] || {};

        console.log("📂 Adding to combined from cache:", key, "data:", map);
        Object.assign(combined, map);

        combinedCursor.setMonth(combinedCursor.getMonth() + 1);
      }

      console.log("✅ FINAL Workday range data for", startISO, "to", endISO, ":", combined);
      return combined;
    }

    function setWorkdayInCache(iso, val) {
      const key = iso.slice(0, 7);

      if (!workdaysCache) workdaysCache = {};
      if (!(key in workdaysCache)) workdaysCache[key] = {};

      if (val === undefined || val === null) {
        delete workdaysCache[key][iso];
        if (workdaysFullSnapshot) delete workdaysFullSnapshot[iso];
      } else {
        workdaysCache[key][iso] = !!val;
        if (workdaysFullSnapshot) workdaysFullSnapshot[iso] = !!val;
      }
    }

    async function persistWorkdaysMap(map) {
      if (!map || Object.keys(map).length === 0) return;
      showSpinner();
      const updates = {};
      Object.keys(map).forEach(iso => {
        const val = map[iso];
        const path = `settings/workdays/${iso}`;
        updates[path] = (val === undefined) ? null : (val === null ? null : !!val);
      });
      try {
        await db.ref().update(updates);
        Object.keys(map).forEach(iso => {
          const v = map[iso];
          setWorkdayInCache(iso, (v === null ? undefined : v));
        });
      } catch (err) {
        console.error('Failed saving workdays:', err);
        throw err; // Re-throw untuk handle di caller
      } finally {
        hideSpinner();
      }
    }

    // ========== Sidebar toggle ==========
    function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      sb.classList.toggle('collapsed');
      document.getElementById('toggleBtn').textContent = sb.classList.contains('collapsed') ? '➡️' : '⬅️';
    }

    // ========== Auth & UI init ==========
    let currentCalendarYear, currentCalendarMonth;
    const ADMIN_EMAIL = 'yhlim3031@gmail.com';

    firebase.auth().onAuthStateChanged(async user => {
      if (!user) return window.location.href = 'index.html';

      currentUser = user;
      isAdmin = (user.email === ADMIN_EMAIL);
      if (isAdmin) {
        document.body.classList.add('admin-user');
      } else {
        document.body.classList.remove('admin-user');
      }
      document.getElementById('userEmail').textContent = user.email;

      await ensureUserProfile();

      if (!isAdmin) {
        await loadUserPlates();
      }

      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? 'block' : 'none';
      });

      // Add admin-user class to body jika admin
      if (isAdmin) {
        document.body.classList.add('admin-user');
      } else {
        document.body.classList.remove('admin-user');
      }

      // Show/hide sections based on user role
      if (isAdmin) {
        // Admin: Show User Management, hide Register Plate
        document.getElementById('nav-user-management').style.display = 'block';
        document.getElementById('nav-register').style.display = 'none';
        document.getElementById('register').style.display = 'none';

        // Show other admin sections
        ['daily', 'weekly', 'monthly', 'workday'].forEach(id => {
          const nav = document.getElementById('nav-' + id);
          if (nav) nav.style.display = 'block';
        });
      } else {
        // Regular user: Show Register Plate, hide User Management
        document.getElementById('nav-register').style.display = 'block';
        document.getElementById('nav-user-management').style.display = 'none';
        document.getElementById('user-management').style.display = 'none';

        // Hide admin sections
        ['daily', 'weekly', 'monthly', 'workday'].forEach(id => {
          const nav = document.getElementById('nav-' + id);
          if (nav) nav.style.display = 'none';
        });
      }

      initPickers();
      showSection('home');
    });

    // Load user's registered plates
    async function loadUserPlates() {
      try {
        const snapshot = await db.ref('plates').once('value');
        const plates = snapshot.val() || {};

        userPlates = [];
        Object.keys(plates).forEach(plate => {
          const vehicle = plates[plate];
          if (vehicle.registeredBy === currentUser.email ||
            (vehicle.name && matchByNameVariations(vehicle.name, userName))) {
            userPlates.push({
              plate: plate,
              name: vehicle.name,
              jabatan: vehicle.jabatan,
              registeredBy: vehicle.registeredBy
            });
          }
        });
      } catch (err) {
        console.error('Error loading user plates:', err);
      }
    }

    function calculateWorkedHours(record) {
      let rawWorked = record.workedHours || record.workedhours || "";

      if (rawWorked) {
        rawWorked = String(rawWorked).replace(/\s*(hours?\s*)+$/i, "").trim();
        const m = rawWorked.match(/(\d+)\s*(?:hour|hours|h)?(?:[:\s,-]+)?\s*(\d+)?\s*(?:min|minutes|m)?/i);
        if (m) {
          const h = parseInt(m[1]) || 0;
          const min = parseInt(m[2]) || 0;
          const hourLabel = h === 1 ? "hour" : "hours";
          return `${h} ${hourLabel} ${min} min`;
        } else {
          return rawWorked;
        }
      }

      return "-";
    }

    // TAMBAH FUNCTION INI DI SINI
    function loadRegisteredVehicles() {
      console.log("Loading registered vehicles for:", currentUser?.email);

      const user = firebase.auth().currentUser;
      if (!user) {
        console.error("No user logged in");
        return;
      }

      // Show loading state
      const vehiclesList = document.getElementById('registeredVehicles');
      if (vehiclesList) {
        vehiclesList.innerHTML = '<p>Loading vehicles...</p>';
      }

      // Query vehicles dari Firebase
      db.ref('plates').once('value')
        .then((snapshot) => {
          const plates = snapshot.val() || {};
          const userVehicles = [];

          // Filter vehicles untuk user ini
          Object.keys(plates).forEach(plate => {
            const vehicle = plates[plate];
            if (vehicle.registeredBy === user.email ||
              (vehicle.name && matchByNameVariations(vehicle.name, userName))) {
              userVehicles.push({
                plate: plate,
                name: vehicle.name,
                jabatan: vehicle.jabatan,
                registeredAt: vehicle.registeredAt
              });
            }
          });

          // Display results
          if (!vehiclesList) return;

          if (userVehicles.length === 0) {
            vehiclesList.innerHTML = '<p>No vehicles registered.</p>';
            return;
          }

          vehiclesList.innerHTML = '';
          userVehicles.forEach(vehicle => {
            const registeredDate = vehicle.registeredAt ?
              new Date(vehicle.registeredAt).toLocaleDateString() : 'Unknown';

            vehiclesList.innerHTML += `
          <div class="vehicle-item">
            <div>
              <h4>${vehicle.plate}</h4>
              <p class="small">Department: ${vehicle.jabatan || 'N/A'}</p>
            </div>
            <div class="vehicle-actions">
              <button onclick="deleteVehicle('${vehicle.plate}')" style="background:#ef4444; padding: 6px 12px; font-size: 12px;">Delete</button>
            </div>
          </div>
        `;
          });
        })
        .catch((error) => {
          console.error("Error loading vehicles:", error);
          if (vehiclesList) {
            vehiclesList.innerHTML = '<p>Error loading vehicles.</p>';
          }
        });
    }

    // show section helper
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
      const nav = document.getElementById('nav-' + id);
      if (nav) nav.classList.add('active');

      // Close mobile menu when selecting a section
      const sidebar = document.getElementById('sidebar');
      const mobileOverlay = document.getElementById('mobileOverlay');
      if (sidebar && mobileOverlay) {
        sidebar.classList.remove('mobile-open');
        mobileOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      if (id === 'attendance') loadAttendanceByDate();
      if (id === 'daily') calculateDailyStatus();
      if (id === 'weekly') {
        const wk = document.getElementById('weekPicker');
        if (!wk.value) wk.value = new Date().toISOString().split('T')[0];
        calculateWeeklySummary();
      }
      if (id === 'monthly') calculateMonthlySummary();
      if (id === 'workday') {
        const now = new Date();

        // FIX: Initialize calendar variables if undefined
        if (typeof currentCalendarYear === 'undefined' || typeof currentCalendarMonth === 'undefined') {
          currentCalendarYear = now.getFullYear();
          currentCalendarMonth = now.getMonth();
          console.log('📅 Initializing calendar variables:', currentCalendarYear, currentCalendarMonth);
        }

        console.log('📅 Workday - Rendering:', currentCalendarYear, currentCalendarMonth);
        renderCalendar(currentCalendarYear, currentCalendarMonth);
      }
      if (id === 'register') loadRegisteredVehicles();
      if (id === 'settings') loadUserSettings();
      if (id === 'user-management') loadUsers();

      if (id === 'user-settings') {
        console.log('Settings section loaded');
        // Populate current name jika perlu
        const nameInput = document.getElementById('userNameInput');
        if (nameInput && userName) {
          nameInput.value = userName;
        }
      }

    }

    // logout
    function logout() {
      firebase.auth().signOut().then(() => location.href = 'index.html');
    }

    // ========== Enhanced Pagination Functions ==========
    function updatePaginationControls() {
      const firstPageBtn = document.getElementById('firstPageBtn');
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');
      const lastPageBtn = document.getElementById('lastPageBtn');
      const paginationInfo = document.getElementById('paginationInfo');

      // Update button states
      firstPageBtn.disabled = currentAttendancePage <= 1;
      prevPageBtn.disabled = currentAttendancePage <= 1;
      nextPageBtn.disabled = currentAttendancePage >= totalAttendancePages;
      lastPageBtn.disabled = currentAttendancePage >= totalAttendancePages;

      // Update pagination info
      const startRecord = (currentAttendancePage - 1) * attendancePerPage + 1;
      const endRecord = Math.min(currentAttendancePage * attendancePerPage, totalAttendanceRecords);

      if (totalAttendanceRecords > 0) {
        paginationInfo.textContent = `Showing ${startRecord}-${endRecord} of ${totalAttendanceRecords} records`;
      } else {
        paginationInfo.textContent = 'No records found';
      }
    }

    function goToPage(page) {
      if (page < 1 || page > totalAttendancePages) return;
      currentAttendancePage = page;
      loadAttendanceByDate(false);
    }

    function goToPreviousPage() {
      if (currentAttendancePage > 1) {
        currentAttendancePage--;
        loadAttendanceByDate(false);
      }
    }

    function goToNextPage() {
      if (currentAttendancePage < totalAttendancePages) {
        currentAttendancePage++;
        loadAttendanceByDate(false);
      }
    }

    function goToLastPage() {
      if (currentAttendancePage < totalAttendancePages) {
        currentAttendancePage = totalAttendancePages;
        loadAttendanceByDate(false);
      }
    }
    // ========== NEW FUNCTION: Filter by Status ==========
    function filterByStatus(status) {
      if (!isAdmin) return;

      let filteredRecords = [];

      if (status === 'All') {
        filteredRecords = allDailyRecords;
      } else {
        filteredRecords = allDailyRecords.filter(record => record.status === status);
      }

      // Update pagination untuk filtered records
      totalDailyRecords = filteredRecords.length;
      totalDailyPages = Math.ceil(totalDailyRecords / dailyPerPage);
      currentDailyPage = 1;

      // Display filtered records
      displayFilteredDailyRecords(filteredRecords);
      updateDailyPaginationControls();

      showSnackbar(`Showing ${status === 'All' ? 'All' : status} staff (${filteredRecords.length} records)`);
    }

    // ========== NEW FUNCTION: Display Filtered Daily Records ==========
    function displayFilteredDailyRecords(records) {
      const startIndex = (currentDailyPage - 1) * dailyPerPage;
      const endIndex = startIndex + dailyPerPage;
      const recordsToShow = records.slice(startIndex, endIndex);

      const dailyTable = document.getElementById('dailyStatusTable');

      if (recordsToShow.length === 0) {
        dailyTable.innerHTML = '<p style="text-align:center;padding:20px;">No records found.</p>';
        return;
      }

      let html = '<table class="data-table"><tr><th>Name</th><th>Department</th><th>Status</th></tr>';

      recordsToShow.forEach(record => {
        let statusClass = '';
        let displayText = record.status;

        if (record.status === 'Present') {
          statusClass = 'status-present';
          displayText = 'Present';
        } else if (record.status === 'Late') {
          statusClass = 'status-late';
          displayText = 'Late';
        } else if (record.status === 'Absent') {
          statusClass = 'status-absent';
          displayText = 'Absent';
        } else {
          statusClass = 'status-holiday';
          displayText = '-';
        }

        html += `
      <tr>
        <td>${record.name}</td>
        <td>${record.jabatan}</td>
        <td><span class="${statusClass}">${displayText}</span></td>
      </tr>`;
      });

      html += '</table>';
      dailyTable.innerHTML = html;
    }
    function filterByStatus(status) {
      if (!isAdmin) return;

      let filteredRecords = [];

      if (status === 'All') {
        filteredRecords = allDailyRecords;
      } else {
        filteredRecords = allDailyRecords.filter(record => record.status === status);
      }

      // Update pagination untuk filtered records
      totalDailyRecords = filteredRecords.length;
      totalDailyPages = Math.ceil(totalDailyRecords / dailyPerPage);
      currentDailyPage = 1;

      // Display filtered records
      displayFilteredDailyRecords(filteredRecords);
      updateDailyPaginationControls();

      showSnackbar(`Showing ${status === 'All' ? 'All' : status} staff (${filteredRecords.length} records)`);
    }

    function displayFilteredDailyRecords(records) {
      const startIndex = (currentDailyPage - 1) * dailyPerPage;
      const endIndex = startIndex + dailyPerPage;
      const recordsToShow = records.slice(startIndex, endIndex);

      const dailyTable = document.getElementById('dailyStatusTable');

      if (recordsToShow.length === 0) {
        dailyTable.innerHTML = '<p style="text-align:center;padding:20px;">No records found.</p>';
        return;
      }

      let html = '<table class="data-table"><tr><th>Name</th><th>Department</th><th>Status</th></tr>';

      recordsToShow.forEach(record => {
        let statusClass = '';
        let displayText = record.status;

        if (record.status === 'Present') {
          statusClass = 'status-present';
          displayText = 'Present';
        } else if (record.status === 'Late') {
          statusClass = 'status-late';
          displayText = 'Late';
        } else if (record.status === 'Absent') {
          statusClass = 'status-absent';
          displayText = 'Absent';
        } else {
          statusClass = 'status-holiday';
          displayText = '-';
        }

        html += `
      <tr>
        <td>${record.name}</td>
        <td>${record.jabatan}</td>
        <td><span class="${statusClass}">${displayText}</span></td>
      </tr>`;
      });

      html += '</table>';
      dailyTable.innerHTML = html;
    }


    // ========== Daily Status Pagination Functions ==========
    function updateDailyPaginationControls() {
      // HANYA update bottom pagination (atas sudah dibuang)
      const firstPageBtnBottom = document.getElementById('dailyFirstPageBtnBottom');
      const prevPageBtnBottom = document.getElementById('dailyPrevPageBtnBottom');
      const nextPageBtnBottom = document.getElementById('dailyNextPageBtnBottom');
      const lastPageBtnBottom = document.getElementById('dailyLastPageBtnBottom');
      const paginationInfoBottom = document.getElementById('dailyPaginationInfoBottom');

      // Check jika element wujud sebelum update
      if (firstPageBtnBottom) {
        firstPageBtnBottom.disabled = currentDailyPage <= 1;
        prevPageBtnBottom.disabled = currentDailyPage <= 1;
        nextPageBtnBottom.disabled = currentDailyPage >= totalDailyPages;
        lastPageBtnBottom.disabled = currentDailyPage >= totalDailyPages;
      }

      // Update pagination info - BETULKAN "seconds" kepada "records"
      const startRecord = (currentDailyPage - 1) * dailyPerPage + 1;
      const endRecord = Math.min(currentDailyPage * dailyPerPage, totalDailyRecords);

      if (totalDailyRecords > 0) {
        if (paginationInfoBottom) {
          paginationInfoBottom.textContent = `Showing ${startRecord}-${endRecord} of ${totalDailyRecords} records`;
        }
      } else {
        if (paginationInfoBottom) {
          paginationInfoBottom.textContent = 'No records found';
        }
      }
    }

    function goToDailyPage(page) {
      if (page < 1 || page > totalDailyPages) return;
      currentDailyPage = page;
      displayDailyRecords();
      updateDailyPaginationControls();
    }

    function goToPreviousDailyPage() {
      if (currentDailyPage > 1) {
        currentDailyPage--;
        displayDailyRecords();
        updateDailyPaginationControls();
      }
    }

    function goToNextDailyPage() {
      if (currentDailyPage < totalDailyPages) {
        currentDailyPage++;
        displayDailyRecords();
        updateDailyPaginationControls();
      }
    }

    function goToLastDailyPage() {
      if (currentDailyPage < totalDailyPages) {
        currentDailyPage = totalDailyPages;
        displayDailyRecords();
        updateDailyPaginationControls();
      }
    }

    function displayDailyRecords() {
      const startIndex = (currentDailyPage - 1) * dailyPerPage;
      const endIndex = startIndex + dailyPerPage;
      const recordsToShow = allDailyRecords.slice(startIndex, endIndex);

      const dailyTable = document.getElementById('dailyStatusTable');

      if (recordsToShow.length === 0) {
        dailyTable.innerHTML = '<p style="text-align:center;padding:20px;">No records found.</p>';
        return;
      }

      let html = '<table class="data-table"><tr><th>Name</th><th>Department</th><th>Status</th></tr>';

      recordsToShow.forEach(record => {
        // UPDATED: Add Late status with yellow color
        let statusClass = '';
        let displayText = record.status;

        if (record.status === 'Present') {
          statusClass = 'status-present';
          displayText = 'Present';
        } else if (record.status === 'Late') {
          statusClass = 'status-late';
          displayText = 'Late';
        } else if (record.status === 'Absent') {
          statusClass = 'status-absent';
          displayText = 'Absent';
        } else {
          statusClass = 'status-holiday';
          displayText = '-'; // GUNA "-" UNTUK HOLIDAY
        }

        html += `
      <tr>
        <td>${record.name}</td>
        <td>${record.jabatan}</td>
        <td><span class="${statusClass}">${displayText}</span></td>
      </tr>`;
      });

      html += '</table>';
      dailyTable.innerHTML = html;
    }

    // ========== Functions ==========

    // FIXED FUNCTION: Get user department from plates
    function getUserDepartment(userEmail, userName) {
      if (!allPlatesData || Object.keys(allPlatesData).length === 0) return '-';

      // Cari semua plates yang belong kepada user ini
      const userPlates = Object.keys(allPlatesData).filter(plate => {
        const vehicle = allPlatesData[plate];
        return (
          vehicle.registeredBy === userEmail ||
          (vehicle.name && matchByNameVariations(vehicle.name, userName))
        );
      });

      // Ambil department dari plate pertama (jika ada)
      if (userPlates.length > 0) {
        const firstPlate = userPlates[0];
        return allPlatesData[firstPlate].jabatan || '-';
      }

      return '-';
    }

    async function loadUsers() {
      if (!isAdmin) return;

      showSpinner();
      try {
        // FIX: Load plates data sekali untuk semua user
        const [usersSnapshot, platesSnapshot] = await Promise.all([
          db.ref('users').once('value'),
          db.ref('plates').once('value')
        ]);

        const users = usersSnapshot.val() || {};
        allPlatesData = platesSnapshot.val() || {}; // STORE plates data globally

        // Convert to array and add user ID
        allUsers = Object.keys(users).map(uid => {
          return {
            id: uid,
            ...users[uid]
          };
        });

        // FIX: Filter out admin user from the list
        allUsers = allUsers.filter(user => user.email !== ADMIN_EMAIL);

        totalUsers = allUsers.length;
        totalUserPages = Math.ceil(totalUsers / usersPerPage);

        displayUsers();
        updateUserPaginationControls();

      } catch (err) {
        console.error('Error loading users:', err);
        showSnackbar('❌ Failed to load users: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    function displayUsers() {
      const startIndex = (currentUserPage - 1) * usersPerPage;
      const endIndex = startIndex + usersPerPage;
      const usersToShow = allUsers.slice(startIndex, endIndex);

      const userTable = document.getElementById('userTable');

      if (usersToShow.length === 0) {
        userTable.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:12px;">No users found.</td></tr>';
        return;
      }

      let html = '';
      usersToShow.forEach(user => {
        const statusIcon = user.status === 'inactive' ? '🔴' : '✅';
        const statusClass = user.status === 'inactive' ? 'user-status-inactive' : 'user-status-active';

        // FIX: Get department from user's plates
        const userDepartment = getUserDepartment(user.email, user.name);

        html += `
      <tr class="user-list-item" onclick="showUserDetail('${user.id}')">
        <td style="text-align:left;padding-left:8px;">${user.name || 'Unknown'}</td>
        <td>${userDepartment}</td>
        <td><span class="${statusClass}">${statusIcon} ${user.status === 'inactive' ? 'Inactive' : 'Active'}</span></td>
      </tr>
    `;
      });

      userTable.innerHTML = html;
    }

    function updateUserPaginationControls() {
      const firstPageBtn = document.getElementById('userFirstPageBtn');
      const prevPageBtn = document.getElementById('userPrevPageBtn');
      const nextPageBtn = document.getElementById('userNextPageBtn');
      const lastPageBtn = document.getElementById('userLastPageBtn');
      const paginationInfoBottom = document.getElementById('userPaginationInfoBottom');

      // Update button states
      firstPageBtn.disabled = currentUserPage <= 1;
      prevPageBtn.disabled = currentUserPage <= 1;
      nextPageBtn.disabled = currentUserPage >= totalUserPages;
      lastPageBtn.disabled = currentUserPage >= totalUserPages;

      // Update pagination info
      const startRecord = (currentUserPage - 1) * usersPerPage + 1;
      const endRecord = Math.min(currentUserPage * usersPerPage, totalUsers);

      if (totalUsers > 0) {

        paginationInfoBottom.textContent = `Showing ${startRecord}-${endRecord} of ${totalUsers} users`;
      } else {

        paginationInfoBottom.textContent = 'No users found';
      }
    }

    function goToUserPage(page) {
      if (page < 1 || page > totalUserPages) return;
      currentUserPage = page;
      displayUsers();
      updateUserPaginationControls();
    }

    function goToPreviousUserPage() {
      if (currentUserPage > 1) {
        currentUserPage--;
        displayUsers();
        updateUserPaginationControls();
      }
    }

    function goToNextUserPage() {
      if (currentUserPage < totalUserPages) {
        currentUserPage++;
        displayUsers();
        updateUserPaginationControls();
      }
    }

    function goToLastUserPage() {
      if (currentUserPage < totalUserPages) {
        currentUserPage = totalUserPages;
        displayUsers();
        updateUserPaginationControls();
      }
    }

    function filterUsers() {
      const searchTerm = document.getElementById('searchUser').value.toLowerCase();
      const departmentFilter = document.getElementById('userDepartmentFilter').value;

      let filteredUsers = allUsers;

      // Apply department filter
      if (departmentFilter) {
        filteredUsers = filteredUsers.filter(user => {
          const userDepartment = getUserDepartment(user.email, user.name);
          return userDepartment === departmentFilter;
        });
      }

      // Apply search filter
      if (searchTerm) {
        filteredUsers = filteredUsers.filter(user =>
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.email && user.email.toLowerCase().includes(searchTerm)) ||
          (user.jabatan && user.jabatan.toLowerCase().includes(searchTerm))
        );
      }

      const startIndex = (currentUserPage - 1) * usersPerPage;
      const endIndex = startIndex + usersPerPage;
      const usersToShow = filteredUsers.slice(startIndex, endIndex);

      const userTable = document.getElementById('userTable');

      if (usersToShow.length === 0) {
        userTable.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:12px;">No matching users found.</td></tr>';
        return;
      }

      let html = '';
      usersToShow.forEach(user => {
        const statusIcon = user.status === 'inactive' ? '🔴' : '✅';
        const statusClass = user.status === 'inactive' ? 'user-status-inactive' : 'user-status-active';

        // FIX: Get department from user's plates
        const userDepartment = getUserDepartment(user.email, user.name);

        html += `
      <tr class="user-list-item" onclick="showUserDetail('${user.id}')">
        <td style="text-align:left;padding-left:8px;">${user.name || 'Unknown'}</td>
        <td>${userDepartment}</td>
        <td><span class="${statusClass}">${statusIcon} ${user.status === 'inactive' ? 'Inactive' : 'Active'}</span></td>
      </tr>
    `;
      });

      userTable.innerHTML = html;
    }

    async function showUserDetail(userId) {
      if (!isAdmin) return;

      showSpinner();
      try {
        const userSnapshot = await db.ref('users/' + userId).once('value');
        const user = userSnapshot.val();

        if (!user) {
          showSnackbar('❌ User not found');
          return;
        }

        currentEditingUser = {
          id: userId,
          ...user
        };

        // Load user's vehicles
        const platesSnapshot = await db.ref('plates').once('value');
        const allPlates = platesSnapshot.val() || {};
        const userVehicles = [];

        Object.keys(allPlates).forEach(plate => {
          const vehicle = allPlates[plate];
          if (vehicle.registeredBy === user.email ||
            (vehicle.name && matchByNameVariations(vehicle.name, user.name))) {
            userVehicles.push({
              plate: plate,
              name: vehicle.name,
              jabatan: vehicle.jabatan
            });
          }
        });

        // Load user's RFID
        let userRFID = '';
        const rfidSnapshot = await db.ref('rfid_cards').once('value');
        const rfidCards = rfidSnapshot.val() || {};

        Object.keys(rfidCards).forEach(rfid => {
          const card = rfidCards[rfid];
          if (card.user_id === userId) {
            userRFID = rfid;
          }
        });

        // FIX: Get user's department from their plates
        let userDepartment = '-';
        if (userVehicles.length > 0) {
          // Use the department from the first vehicle
          userDepartment = userVehicles[0].jabatan;
        }

        // Populate user detail form
        document.getElementById('userDetailTitle').textContent = `User Profile: ${user.name}`;
        document.getElementById('userDetailName').value = user.name || '';
        document.getElementById('userDetailDepartment').value = userDepartment;
        document.getElementById('userDetailEmail').value = user.email || '';
        document.getElementById('userDetailRFID').value = userRFID || '';

        // Update toggle button text
        const toggleBtn = document.getElementById('toggleUserStatusBtn');
        toggleBtn.textContent = user.status === 'inactive' ? 'Activate User' : 'Deactivate User';

        // Display user vehicles
        const vehiclesList = document.getElementById('userVehiclesList');
        if (userVehicles.length === 0) {
          vehiclesList.innerHTML = '<p>No vehicles registered for this user.</p>';
        } else {
          let vehiclesHtml = '<table class="data-table"><tr><th>Plate</th><th>Department</th><th>Actions</th></tr>';
          userVehicles.forEach(vehicle => {
            vehiclesHtml += `
          <tr>
            <td>${vehicle.plate}</td>
            <td>${vehicle.jabatan}</td>
            <td>
              <button onclick="deleteUserVehicle('${vehicle.plate}')" style="padding:4px 8px;font-size:12px;">Delete</button>
            </td>
          </tr>
        `;
          });
          vehiclesHtml += '</table>';
          vehiclesList.innerHTML = vehiclesHtml;
        }

        showSection('user-detail');

      } catch (err) {
        console.error('Error loading user detail:', err);
        showSnackbar('❌ Failed to load user details: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    async function saveUserRFID() {
      if (!isAdmin || !currentEditingUser) return;

      const rfidInput = document.getElementById('userDetailRFID');
      const rfidValue = rfidInput.value.trim().toUpperCase();

      if (!rfidValue) {
        showSnackbar('❌ Please enter an RFID UID');
        return;
      }

      // Validate RFID format (hexadecimal, 8 characters)
      const hexRegex = /^[0-9A-F]{8}$/;
      if (!hexRegex.test(rfidValue)) {
        showSnackbar('❌ RFID must be 8 hexadecimal characters (e.g., E4F77C05)');
        return;
      }

      showSpinner();
      try {
        // Check if RFID is already assigned to another user
        const rfidSnapshot = await db.ref('rfid_cards/' + rfidValue).once('value');
        if (rfidSnapshot.exists() && rfidSnapshot.val().user_id !== currentEditingUser.id) {
          showSnackbar('❌ This RFID is already assigned to another user');
          hideSpinner();
          return;
        }

        // Remove any existing RFID for this user
        const allRfidSnapshot = await db.ref('rfid_cards').once('value');
        const allRfid = allRfidSnapshot.val() || {};

        const updates = {};

        // Remove any existing RFID for this user
        Object.keys(allRfid).forEach(rfid => {
          if (allRfid[rfid].user_id === currentEditingUser.id) {
            updates[`rfid_cards/${rfid}`] = null;
          }
        });

        // Add new RFID
        updates[`rfid_cards/${rfidValue}`] = {
          user_id: currentEditingUser.id,
          assigned_by: currentUser.email,
          assigned_at: new Date().toISOString(),
          status: 'active'
        };

        // Update lookup table
        updates[`rfid_to_user/${rfidValue}`] = currentEditingUser.id;

        await db.ref().update(updates);

        showSnackbar('✅ RFID saved successfully');

      } catch (err) {
        console.error('Error saving RFID:', err);
        showSnackbar('❌ Failed to save RFID: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    async function toggleUserStatus() {
      if (!isAdmin || !currentEditingUser) return;

      const newStatus = currentEditingUser.status === 'inactive' ? 'active' : 'inactive';
      const confirmMessage = newStatus === 'inactive'
        ? `Are you sure you want to deactivate ${currentEditingUser.name}?`
        : `Are you sure you want to activate ${currentEditingUser.name}?`;

      if (!confirm(confirmMessage)) return;

      showSpinner();
      try {
        await db.ref(`users/${currentEditingUser.id}/status`).set(newStatus);

        showSnackbar(`✅ User ${newStatus === 'inactive' ? 'deactivated' : 'activated'} successfully`);

        // Reload user detail
        showUserDetail(currentEditingUser.id);

      } catch (err) {
        console.error('Error toggling user status:', err);
        showSnackbar('❌ Failed to update user status: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    async function deleteUserVehicle(plate) {
      if (!isAdmin || !currentEditingUser) return;

      if (!confirm(`Are you sure you want to delete plate ${plate}?`)) return;

      showSpinner();
      try {
        await db.ref('plates/' + plate).remove();

        showSnackbar(`✅ Plate ${plate} deleted successfully`);

        // Reload user detail
        showUserDetail(currentEditingUser.id);

      } catch (err) {
        console.error('Error deleting vehicle:', err);
        showSnackbar('❌ Failed to delete vehicle: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    // ========== MISSING FUNCTIONS ==========

    // Filter vehicles function
    function filterVehicles() {
      const searchTerm = document.getElementById('searchVehicles').value.toLowerCase();
      const vehicleItems = document.querySelectorAll('.vehicle-item');

      vehicleItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Delete vehicle function
    function deleteVehicle(plate) {
      if (!confirm(`Are you sure you want to delete vehicle ${plate}?`)) return;

      showSpinner();
      db.ref('plates/' + plate).remove()
        .then(() => {
          showSnackbar('Vehicle deleted successfully');
          loadRegisteredVehicles();
        })
        .catch(error => {
          showSnackbar('Error deleting vehicle: ' + error.message);
        })
        .finally(() => {
          hideSpinner();
        });
    }

    // Register plate function
    function registerPlate() {
      const plateInput = document.getElementById('regPlate');
      const jabatanSelect = document.getElementById('regJawatan');

      const plate = plateInput.value.trim().toUpperCase();
      const jabatan = jabatanSelect.value;

      if (!plate) {
        showSnackbar('❌ Please enter a plate number');
        return;
      }

      if (!jabatan) {
        showSnackbar('❌ Please select a department');
        return;
      }

      showSpinner();

      const plateData = {
        name: userName,
        jabatan: jabatan,
        registeredBy: currentUser.email,
        registeredAt: new Date().toISOString(),
        user_id: currentUser.uid
      };

      db.ref('plates/' + plate).set(plateData)
        .then(() => {
          showSnackbar('✅ Vehicle registered successfully');
          plateInput.value = '';
          jabatanSelect.value = '';
          loadRegisteredVehicles();
        })
        .catch(error => {
          showSnackbar('❌ Error registering vehicle: ' + error.message);
        })
        .finally(() => {
          hideSpinner();
        });
    }

    // Load user settings function
    function loadUserSettings() {
      // Populate the name input with current user name
      const nameInput = document.getElementById('userNameInput');
      if (nameInput && userName) {
        nameInput.value = userName;
      }

      console.log('Settings loaded for user:', userName);
    }

    // Filter daily table function
    function filterDailyTable() {
      const searchTerm = document.getElementById('searchDaily').value.toLowerCase();
      const rows = document.querySelectorAll('#dailyStatusTable tr');

      rows.forEach(row => {
        if (row.cells && row.cells.length > 0) {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? '' : 'none';
        }
      });
    }

    // COMPLETE FIXED VERSION dengan card layout untuk mobile users
    async function loadAttendanceByDate(resetPage = true) {
      console.log("🔄 loadAttendanceByDate() called");

      if (resetPage) {
        currentAttendancePage = 1;
      }

      const date = document.getElementById("datePicker").value;
      const jabatanFilter = document.getElementById("jabatanFilter").value;
      const table = document.getElementById("attendanceTable");
      const cardsContainer = document.getElementById("mobileAttendanceCards");

      if (!date) {
        table.innerHTML = "<tr><td colspan='8' style='text-align:center;padding:12px;'>Please select a date.</td></tr>";
        cardsContainer.innerHTML = '<div class="no-attendance-cards">Please select a date.</div>';
        return;
      }

      showSpinner();

      try {
        // Add debug logging to see what's happening
        console.log("📡 Loading FRESH data for:", date);

        // Load BOTH attendance data, plates data, DAN workdays data
        const [attendanceSnap, platesSnap, workdaysData] = await Promise.all([
          db.ref("attendance/" + date).once("value"),
          db.ref("plates").once("value"),
          loadWorkdaysRange(date, date)
        ]);

        const attendanceData = attendanceSnap.exists() ? attendanceSnap.val() : {};
        const platesData = platesSnap.val() || {};

        // Check workday status
        const selectedDate = new Date(date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        selectedDate.setHours(0, 0, 0, 0);

        const isToday = selectedDate.getTime() === today.getTime();
        const isFuture = selectedDate > today;
        const isWorkday = date in workdaysData ? !!workdaysData[date] : isDefaultWorkdayISO(date);

        // Use Map to avoid duplicate names
        const uniqueStaffMap = new Map();

        // Process plates data to get staff list without duplicates
        Object.values(platesData).forEach(staff => {
          const staffName = staff.name || "-";
          const staffJabatan = staff.jabatan || "-";

          // Filter by department if admin
          if (isAdmin && jabatanFilter && staffJabatan !== jabatanFilter) return;

          // Filter by user if not admin
          if (!isAdmin && !matchByNameVariations(staffName, userName)) return;

          // Use Map to avoid duplicate names
          if (!uniqueStaffMap.has(staffName)) {
            uniqueStaffMap.set(staffName, {
              name: staffName,
              jabatan: staffJabatan,
              plates: []
            });
          }
        });

        // If regular user has no plates, add user
        if (!isAdmin && uniqueStaffMap.size === 0) {
          uniqueStaffMap.set(userName, {
            name: userName,
            jabatan: 'Unknown',
            plates: []
          });
        }

        let allRows = [];
        let allCards = [];

        // Process each staff from unique list
        uniqueStaffMap.forEach((staff, staffName) => {
          // Find attendance record for this staff
          const attendanceRecord = findAttendanceRecord(attendanceData, staffName);

          let shift = "-";
          let status = "-";
          let checkin = "-";
          let checkout = "-";
          let workedHours = "-";
          let punctuality = "-";

          // If attendance record exists, use that data
          if (attendanceRecord) {
            shift = attendanceRecord.shift || "-";
            status = attendanceRecord.status || "Present";
            checkin = attendanceRecord.checkin || "-";
            checkout = attendanceRecord.checkout || "-";
            workedHours = calculateWorkedHours(attendanceRecord);
            punctuality = attendanceRecord.punctuality || "-";
          } else {
            // If NO attendance record, check workday status
            if (!isWorkday) {
              status = "-";
            } else if (isFuture) {
              status = "-";
            } else {
              status = "Absent";
            }
          }

          // Apply color coding
          const statusColor = getStatusColor(status);
          const punctualityColor = getPunctualityColor(punctuality);

          // For table rows
          allRows.push(`
        <tr>
          <td>${staffName}</td>
          <td class="${isAdmin ? '' : 'admin-only'} mobile-hidden">${staff.jabatan}</td>
          <td>${shift}</td>
          <td style="${statusColor}">${status}</td>
          <td>${checkin}</td>
          <td class="mobile-hidden">${checkout}</td>
          <td class="mobile-hidden">${workedHours}</td>
          <td class="mobile-hidden" style="${punctualityColor}">${punctuality}</td>
        </tr>`);

          // For card layout
          allCards.push({
            name: staffName,
            jabatan: staff.jabatan,
            shift: shift,
            status: status,
            checkin: checkin,
            checkout: checkout,
            workedHours: workedHours,
            punctuality: punctuality
          });
        });

        // THIS IS THE MISSING PAGINATION CODE:
        // Handle pagination and display data
        if (isAdmin) {
          totalAttendanceRecords = allRows.length;
          totalAttendancePages = Math.ceil(totalAttendanceRecords / attendancePerPage);
          const startIndex = (currentAttendancePage - 1) * attendancePerPage;
          const endIndex = startIndex + attendancePerPage;
          const pageRows = allRows.slice(startIndex, endIndex);

          table.innerHTML = pageRows.join('') || "<tr><td colspan='8' style='text-align:center;padding:12px;'>No staff found.</td></tr>";

          updatePaginationControls();

        } else {
          table.innerHTML = allRows.join('') || "<tr><td colspan='8' style='text-align:center;padding:12px;'>No attendance records found.</td></tr>";
        }

        // RENDER CARDS FOR MOBILE
        renderAttendanceCards(allCards);

      } catch (err) {
        console.error("Firebase error:", err);
        table.innerHTML = "<tr><td colspan='8' style='text-align:center;padding:12px;'>Firebase connection error.</td></tr>";
        cardsContainer.innerHTML = '<div class="no-attendance-cards">Firebase connection error.</div>';
      } finally {
        hideSpinner();
      }
    }

    // Filter attendance table - FIXED VERSION
    function filterAttendanceTable() {
      const searchTerm = document.getElementById('searchAttendance').value.toLowerCase();

      // Filter table rows (for desktop)
      const rows = document.querySelectorAll('#attendanceTable tr');
      rows.forEach(row => {
        if (row.cells.length > 0) { // Skip header row
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? '' : 'none';
        }
      });

      // Filter cards (for mobile)
      const cards = document.querySelectorAll('.attendance-card');
      cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(searchTerm) ? 'block' : 'none';
      });
    }

    // Export attendance data
    function exportAttendanceData() {
      const date = document.getElementById("datePicker").value;
      if (!date) {
        showSnackbar('Please select a date first');
        return;
      }

      let csvContent = "Name,Department,Shift,Status,Checkin,Checkout,Worked Hours,Punctuality\n";

      const rows = document.querySelectorAll('#attendanceTable tr');
      rows.forEach(row => {
        if (row.style.display !== 'none') {
          const cells = row.querySelectorAll('td');
          if (cells.length > 0) {
            const rowData = Array.from(cells).map(cell => {
              let text = cell.textContent.trim();
              if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                text = '"' + text.replace(/"/g, '""') + '"';
              }
              return text;
            });
            csvContent += rowData.join(',') + '\n';
          }
        }
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", `attendance_${date}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showSnackbar('Data exported successfully');
    }

    // ========== NEW FUNCTION: Filter by Status ==========
    function filterByStatus() {
      if (!isAdmin) return;

      const statusFilter = document.getElementById('statusFilterDaily').value;
      let filteredRecords = [];

      if (statusFilter === 'All') {
        filteredRecords = allDailyRecords;
      } else {
        filteredRecords = allDailyRecords.filter(record => record.status === statusFilter);
      }

      // Update pagination untuk filtered records
      totalDailyRecords = filteredRecords.length;
      totalDailyPages = Math.ceil(totalDailyRecords / dailyPerPage);
      currentDailyPage = 1;

      // Display filtered records
      displayFilteredDailyRecords(filteredRecords);
      updateDailyPaginationControls();

      showSnackbar(`Showing ${statusFilter === 'All' ? 'All' : statusFilter} staff (${filteredRecords.length} records)`);
    }

    // ========== NEW FUNCTION: Display Filtered Daily Records ==========
    function displayFilteredDailyRecords(records) {
      const startIndex = (currentDailyPage - 1) * dailyPerPage;
      const endIndex = startIndex + dailyPerPage;
      const recordsToShow = records.slice(startIndex, endIndex);

      const dailyTable = document.getElementById('dailyStatusTable');

      if (recordsToShow.length === 0) {
        dailyTable.innerHTML = '<p style="text-align:center;padding:20px;">No records found.</p>';
        return;
      }

      let html = '<table class="data-table"><tr><th>Name</th><th>Department</th><th>Status</th></tr>';

      recordsToShow.forEach(record => {
        let statusClass = '';
        let displayText = record.status;

        if (record.status === 'Present') {
          statusClass = 'status-present';
          displayText = 'Present';
        } else if (record.status === 'Late') {
          statusClass = 'status-late';
          displayText = 'Late';
        } else if (record.status === 'Absent') {
          statusClass = 'status-absent';
          displayText = 'Absent';
        } else {
          statusClass = 'status-holiday';
          displayText = '-';
        }

        html += `
        <tr>
            <td>${record.name}</td>
            <td>${record.jabatan}</td>
            <td><span class="${statusClass}">${displayText}</span></td>
        </tr>`;
      });

      html += '</table>';
      dailyTable.innerHTML = html;
    }

    // ========== UPDATED: calculateDailyStatus Function ==========
    async function calculateDailyStatus() {
      showSpinner();
      try {
        const targetDate = todayISO();
        const filterJabatan = document.getElementById('jabatanFilterDaily') ? document.getElementById('jabatanFilterDaily').value : '';

        console.log('🔍 DAILY START - Date:', targetDate);

        // LOAD DATA SAMA SEPERTI ATTENDANCE
        const [platesSnap, attendanceSnap] = await Promise.all([
          db.ref('plates').once('value'),
          db.ref('attendance/' + targetDate).once('value')
        ]);

        const allPlates = platesSnap.val() || {};
        const attendanceData = attendanceSnap.exists() ? attendanceSnap.val() : {};

        // DIRECT CHECK WORKDAY - CARA MUDAH
        await ensureWorkdaysLoadedOnce();
        let isWorkday;
        if (workdaysFullSnapshot && targetDate in workdaysFullSnapshot) {
          isWorkday = workdaysFullSnapshot[targetDate];
          console.log('✅ DAILY: Workday Manager setting =', isWorkday);
        } else {
          isWorkday = isDefaultWorkdayISO(targetDate);
          console.log('✅ DAILY: Default setting =', isWorkday);
        }

        console.log('🔍 DAILY FINAL - isWorkday:', isWorkday, 'Workday Data:', workdaysFullSnapshot);

        // Reset pagination
        currentDailyPage = 1;
        allDailyRecords = [];
        const uniqueStaffMap = new Map();

        if (isAdmin) {
          Object.values(allPlates).forEach(staff => {
            const staffName = staff.name || "-";
            const staffJabatan = staff.jabatan || "-";

            if (!staffName || staffName === "-") return;
            if (filterJabatan && staffJabatan !== filterJabatan) return;

            if (!uniqueStaffMap.has(staffName)) {
              const attendanceRecord = findAttendanceRecord(attendanceData, staffName);

              let status = "-";
              if (isWorkday) {
                if (attendanceRecord) {
                  // CHECK FOR LATE STATUS
                  if (attendanceRecord.punctuality && attendanceRecord.punctuality.toLowerCase().includes('late')) {
                    status = "Late";
                  } else if (attendanceRecord.status && attendanceRecord.status.toLowerCase().includes('late')) {
                    status = "Late";
                  } else {
                    status = "Present";
                  }
                } else {
                  status = "Absent";
                }
              }

              uniqueStaffMap.set(staffName, {
                name: staffName,
                jabatan: staffJabatan,
                status: status
              });
            }
          });

          allDailyRecords = Array.from(uniqueStaffMap.values());

        } else {
          // Untuk user biasa
          Object.values(allPlates).forEach(staff => {
            const staffName = staff.name || "-";
            const staffJabatan = staff.jabatan || "-";

            if (matchByNameVariations(staffName, userName)) {
              const attendanceRecord = findAttendanceRecord(attendanceData, staffName);

              let status = "-";
              if (isWorkday) {
                if (attendanceRecord) {
                  // CHECK FOR LATE STATUS
                  if (attendanceRecord.punctuality && attendanceRecord.punctuality.toLowerCase().includes('late')) {
                    status = "Late";
                  } else if (attendanceRecord.status && attendanceRecord.status.toLowerCase().includes('late')) {
                    status = "Late";
                  } else {
                    status = "Present";
                  }
                } else {
                  status = "Absent";
                }
              }

              allDailyRecords.push({
                name: staffName,
                jabatan: staffJabatan,
                status: status
              });
            }
          });

          if (allDailyRecords.length === 0) {
            const attendanceRecord = findAttendanceRecord(attendanceData, userName);

            let status = "-";
            if (isWorkday) {
              if (attendanceRecord) {
                // CHECK FOR LATE STATUS
                if (attendanceRecord.punctuality && attendanceRecord.punctuality.toLowerCase().includes('late')) {
                  status = "Late";
                } else if (attendanceRecord.status && attendanceRecord.status.toLowerCase().includes('late')) {
                  status = "Late";
                } else {
                  status = "Present";
                }
              } else {
                status = "Absent";
              }
            }

            allDailyRecords.push({
              name: userName,
              jabatan: 'Unknown',
              status: status
            });
          }
        }

        // Update dan display
        totalDailyRecords = allDailyRecords.length;
        totalDailyPages = Math.ceil(totalDailyRecords / dailyPerPage);
        displayDailyRecords();
        updateDailyPaginationControls();

        // Show date info
        const dateDisplay = new Date().toLocaleDateString('en-MY', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });

        let dateInfoElement = document.getElementById('dailyDateInfo');
        if (!dateInfoElement) {
          dateInfoElement = document.createElement('div');
          dateInfoElement.id = 'dailyDateInfo';
          dateInfoElement.className = 'daily-date-info';

          const dailyTable = document.getElementById('dailyStatusTable');
          dailyTable.parentNode.insertBefore(dateInfoElement, dailyTable);
        }

        const workdayStatus = isWorkday ?
          '<span style="color:#10b981;margin-left:8px;">(Workday)</span>' :
          '<span style="color:#6b7280;margin-left:8px;">(Non-Workday)</span>';

        dateInfoElement.innerHTML = `<strong>📅 Today: ${dateDisplay}</strong> ${workdayStatus}`;

        console.log('✅ DAILY COMPLETED SUCCESSFULLY');

      } catch (err) {
        console.error('❌ DAILY ERROR:', err);
        showSnackbar('❌ Failed to load daily status: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    // ========== UPDATED: displayDailyRecords Function ==========
    function displayDailyRecords() {
      const startIndex = (currentDailyPage - 1) * dailyPerPage;
      const endIndex = startIndex + dailyPerPage;
      const recordsToShow = allDailyRecords.slice(startIndex, endIndex);

      const dailyTable = document.getElementById('dailyStatusTable');

      if (recordsToShow.length === 0) {
        dailyTable.innerHTML = '<p style="text-align:center;padding:20px;">No records found.</p>';
        return;
      }

      let html = '<table class="data-table"><tr><th>Name</th><th>Department</th><th>Status</th></tr>';

      recordsToShow.forEach(record => {
        let statusClass = '';
        let displayText = record.status;

        if (record.status === 'Present') {
          statusClass = 'status-present';
          displayText = 'Present';
        } else if (record.status === 'Late') {
          statusClass = 'status-late';
          displayText = 'Late';
        } else if (record.status === 'Absent') {
          statusClass = 'status-absent';
          displayText = 'Absent';
        } else {
          statusClass = 'status-holiday';
          displayText = '-';
        }

        html += `
        <tr>
            <td>${record.name}</td>
            <td>${record.jabatan}</td>
            <td><span class="${statusClass}">${displayText}</span></td>
        </tr>`;
      });

      html += '</table>';
      dailyTable.innerHTML = html;
    }

    // ========== Weekly Summary - DEBUG VERSION ==========
    async function calculateWeeklySummary() {
      showSpinner();
      try {
        const pick = document.getElementById('weekPicker').value || todayISO();
        const base = new Date(pick);
        const day = base.getDay();
        const diffToMonday = (day === 0) ? -6 : (1 - day);
        const monday = new Date(base);
        monday.setDate(base.getDate() + diffToMonday);

        const dates = Array.from({ length: 7 }, (_, i) => {
          const d = new Date(monday);
          d.setDate(monday.getDate() + i);
          return ymdFromDate(d);
        });

        console.log('📅 DATES FOR WEEK:', dates);

        const workdaysMap = await loadWorkdaysRange(dates[0], dates[dates.length - 1]);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        console.log('🗓️ WORKDAYS MAP:', workdaysMap);
        console.log('🕒 TODAY:', todayISO());

        // Load data
        const [attendanceSnaps, platesSnap] = await Promise.all([
          Promise.all(dates.map(dt => db.ref('attendance/' + dt).once('value'))),
          db.ref('plates').once('value')
        ]);

        const plates = platesSnap.val() || {};
        const filterJabatan = document.getElementById('weekJabatanFilter')?.value || '';

        console.log('👥 TOTAL PLATES:', Object.keys(plates).length);
        console.log('🔍 FILTER DEPARTMENT:', filterJabatan);

        // Process attendance data
        const attendanceByDate = {};
        attendanceSnaps.forEach((snap, idx) => {
          const dt = dates[idx];
          attendanceByDate[dt] = {};
          if (snap.exists()) {
            snap.forEach(r => {
              const v = r.val();
              const name = v.name || 'Unknown';
              attendanceByDate[dt][name] = v;
            });
          }
          console.log(`📊 ${dt} - Attendance records:`, Object.keys(attendanceByDate[dt]).length);
        });

        const namesSet = new Set();

        if (isAdmin) {
          Object.values(plates).forEach(p => {
            const name = p.name || 'Unknown';
            const jab = p.jabatan || '';
            if (filterJabatan && jab !== filterJabatan) return;
            namesSet.add(name);
          });
        } else {
          Object.values(plates).forEach(p => {
            const name = p.name || 'Unknown';
            if (matchByNameVariations(name, userName)) {
              namesSet.add(name);
            }
          });
          if (namesSet.size === 0) {
            namesSet.add(userName);
          }
        }

        console.log('👤 NAMES TO PROCESS:', Array.from(namesSet));

        const stats = {};
        const perDayTotals = dates.map(() => ({ present: 0, late: 0, absent: 0 }));

        // DEBUG: Log workday status for each date
        dates.forEach((dt, i) => {
          const dtObj = new Date(dt);
          dtObj.setHours(0, 0, 0, 0);
          const isWork = dt in workdaysMap ? !!workdaysMap[dt] : isDefaultWorkdayISO(dt);
          const isFuture = dtObj > today;
          console.log(`📆 ${dt} - Workday: ${isWork}, Future: ${isFuture}, Default: ${isDefaultWorkdayISO(dt)}`);
        });

        namesSet.forEach(name => {
          stats[name] = { t: 0, p: 0, l: 0, dayStatus: Array(dates.length).fill('') };

          dates.forEach((dt, i) => {
            const dtObj = new Date(dt);
            dtObj.setHours(0, 0, 0, 0);

            let isWork = dt in workdaysMap ? !!workdaysMap[dt] : isDefaultWorkdayISO(dt);
            const isFuture = dtObj > today;

            console.log(`🔍 ${name} - ${dt}: Workday=${isWork}, Future=${isFuture}`);

            // Future dates atau non-workday - show '-'
            if (isFuture || !isWork) {
              stats[name].dayStatus[i] = '-';
              console.log(`   ${name} - ${dt}: Show '-' (Future or Non-workday)`);
              return;
            }

            // Process workdays that have passed
            const rec = attendanceByDate[dt] && attendanceByDate[dt][name];
            let status = 'A'; // Default to Absent for workdays with no data

            if (rec && rec.checkin) {
              if (rec.status && rec.status.toLowerCase().includes('late')) {
                status = 'L';
                console.log(`   ${name} - ${dt}: Show 'L' (Late)`);
              } else if (rec.punctuality && rec.punctuality.toLowerCase().includes('late')) {
                status = 'L';
                console.log(`   ${name} - ${dt}: Show 'L' (Late from punctuality)`);
              } else {
                status = 'P';
                console.log(`   ${name} - ${dt}: Show 'P' (Present)`);
              }
            } else {
              console.log(`   ${name} - ${dt}: Show 'A' (Absent - No record)`);
            }

            stats[name].dayStatus[i] = status;

            // Update counters for charts
            if (isWork && !isFuture) {
              stats[name].t++;
              if (status === 'P') {
                stats[name].p++;
                perDayTotals[i].present++;
              } else if (status === 'L') {
                stats[name].l++;
                perDayTotals[i].late++;
              } else if (status === 'A') {
                perDayTotals[i].absent++;
              }
            }
          });
        });

        console.log('📈 PER DAY TOTALS:', perDayTotals);
        console.log('👤 STAFF STATS:', stats);

        // Rest of the function remains the same...
        if (isAdmin) {

          const labels = dates.map(date => {
            const d = new Date(date);
            return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}`;
          });

          const presentData = [], lateData = [], absentData = [];
          for (let i = 0; i < dates.length; i++) {
            const dt = dates[i];
            const dtObj = new Date(dt);
            dtObj.setHours(0, 0, 0, 0);
            const isWork = dt in workdaysMap ? !!workdaysMap[dt] : isDefaultWorkdayISO(dt);

            if (!isWork || dtObj > today) {
              presentData.push(0);
              lateData.push(0);
              absentData.push(0);
            } else {
              presentData.push(perDayTotals[i].present);
              lateData.push(perDayTotals[i].late);
              absentData.push(perDayTotals[i].absent);
            }
          }

          console.log('📊 CHART DATA:', { presentData, lateData, absentData });

          const ctx = document.getElementById("weeklyChart").getContext('2d');
          if (weeklyChartInstance) weeklyChartInstance.destroy();

          const allData = [...presentData, ...lateData, ...absentData];
          const maxData = Math.max(...allData, 1); // Minimum 1
          const totalUsers = Object.keys(stats).length;

          // FIXED: Kira maxY dengan cara yang lebih dinamik
          let maxY;
          if (totalUsers <= 5) {
            maxY = Math.max(maxData + 1, 3); // Untuk user sedikit
          } else if (totalUsers <= 10) {
            maxY = Math.max(maxData + 2, 5); // Untuk user sederhana
          } else {
            maxY = Math.max(maxData + 3, Math.ceil(totalUsers * 0.3)); // Untuk user banyak
          }

          // FIXED: PASTIKAN maxY adalah integer
          maxY = Math.ceil(maxY);

          weeklyChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [
                { label: 'Present', data: presentData, backgroundColor: '#10b981' },
                { label: 'Late', data: lateData, backgroundColor: '#f59e0b' },
                { label: 'Absent', data: absentData, backgroundColor: '#ef4444' }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    font: {
                      size: 12
                    }
                  }
                },
                title: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  min: 0,
                  max: maxY,
                  ticks: {
                    stepSize: 1,
                    precision: 0,
                    font: { size: 11 },
                    callback: function (value) {
                      return Number.isInteger(value) ? value : '';
                    }
                  }
                },
                x: {
                  ticks: {
                    font: { size: 11 }
                  }
                }
              }
            }
          }); // INI KURUNGAN TERTUTUP YANG HILANG

          console.log('📊 Weekly Chart Settings:', {
            totalUsers,
            maxData,
            maxY,
            presentData,
            lateData,
            absentData
          });
        } // TAMBAH INI - tutup if (isAdmin) untuk chart

        // Rest of the function for Staff Attendance Details...
        const rows = Object.entries(stats).map(([name, st]) => {
          const perc = st.t ? ((st.p + st.l) / st.t * 100).toFixed(1) : '0.0';
          return {
            name,
            t: st.t,
            p: st.p,
            l: st.l,
            absent: st.t - st.p - st.l,
            perc,
            dayStatus: st.dayStatus
          };
        }).sort((a, b) => (b.perc === 'N/A' ? 0 : parseFloat(b.perc)) - (a.perc === 'N/A' ? 0 : parseFloat(a.perc)));

        console.log('👥 FINAL STAFF DETAILS ROWS:', rows);

        let gridHtml = `
    <div style="overflow-x: auto;">
      <table class="data-table">
        <thead>
          <tr>
            <th style="text-align: left; min-width: 140px;">Name</th>`;

        dates.forEach(date => {
          const d = new Date(date);
          const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          gridHtml += `<th title="${date}" style="min-width: 50px;">${pad(d.getDate())}/${pad(d.getMonth() + 1)}<br><small style="font-size:11px;">${dayNames[d.getDay()]}</small></th>`;
        });

        gridHtml += `
            <th style="min-width: 70px;">Attendance %</th>
          </tr>
        </thead>
        <tbody>`;

        rows.forEach(r => {
          console.log(`🔄 RENDERING: ${r.name} - Status: [${r.dayStatus.join(', ')}]`);

          gridHtml += `<tr><td style="text-align: left; font-weight: 500;">${r.name}</td>`;

          r.dayStatus.forEach((s, index) => {
            const dt = dates[index];
            const dtObj = new Date(dt);
            dtObj.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let statusClass = '';
            let displayText = s;

            console.log(`   📅 ${dt}: Raw status='${s}', Today=${todayISO()}, IsFuture=${dtObj > today}`);

            // FIX: Proper future date check
            if (dtObj > today) {
              statusClass = 'status-holiday';
              displayText = '-';
              console.log(`      → Future date: Show '-'`);
            } else if (s === 'P') {
              statusClass = 'status-present';
              displayText = '✓';
              console.log(`      → Present: Show '✓'`);
            } else if (s === 'L') {
              statusClass = 'status-late';
              displayText = '⚠';
              console.log(`      → Late: Show '⚠'`);
            } else if (s === 'A') {
              statusClass = 'status-absent';
              displayText = '✗';
              console.log(`      → Absent: Show '✗'`);
            } else if (s === '-') {
              statusClass = 'status-holiday';
              displayText = '-';
              console.log(`      → Holiday: Show '-'`);
            } else {
              // Fallback - should not happen
              statusClass = 'status-holiday';
              displayText = '-';
              console.log(`      → Unknown status '${s}': Show '-'`);
            }

            gridHtml += `<td><span class="${statusClass}">${displayText}</span></td>`;
          });

          gridHtml += `<td style="font-weight: 600; background: #f8fafc;">${r.perc}%</td></tr>`;
        });

        gridHtml += `</tbody></table></div>`;

        gridHtml += `
    <div style="display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; font-size: 12px;">
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="status-present" style="padding: 3px 5px;">✓</span>
        <span>Present On Time</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="status-late" style="padding: 3px 5px;">⚠</span>
        <span>Present Late</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="status-absent" style="padding: 3px 5px;">✗</span>
        <span>Absent</span>
      </div>
      <div style="display: flex; align-items: center; gap: 6px;">
        <span class="status-holiday" style="padding: 3px 5px;">-</span>
        <span>Holiday/Future</span>
      </div>
    </div>`;

        document.getElementById("weeklyDetailGrid").innerHTML = gridHtml;

      } catch (err) {
        console.error('❌ ERROR in calculateWeeklySummary:', err);
        showSnackbar('❌ Error building weekly report');
      } finally {
        hideSpinner();
      }
    }

    // Filter weekly table
    function filterWeeklyTable() {
      const searchTerm = document.getElementById('searchWeekly').value.toLowerCase();
      const rows = document.querySelectorAll('#weeklyDetailGrid tr');

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    }


    let currentMonthlyPage = 1;
    const monthlyPerPage = 10;
    let totalMonthlyRecords = 0;
    let totalMonthlyPages = 0;
    let allMonthlyRecords = [];

    // ========== Monthly Pagination Functions ==========
    function updateMonthlyPaginationControls() {
      const firstPageBtnBottom = document.getElementById('monthlyFirstPageBtnBottom');
      const prevPageBtnBottom = document.getElementById('monthlyPrevPageBtnBottom');
      const nextPageBtnBottom = document.getElementById('monthlyNextPageBtnBottom');
      const lastPageBtnBottom = document.getElementById('monthlyLastPageBtnBottom');
      const paginationInfoBottom = document.getElementById('monthlyPaginationInfoBottom');

      // Check jika element wujud sebelum update
      if (firstPageBtnBottom) {
        firstPageBtnBottom.disabled = currentMonthlyPage <= 1;
        prevPageBtnBottom.disabled = currentMonthlyPage <= 1;
        nextPageBtnBottom.disabled = currentMonthlyPage >= totalMonthlyPages;
        lastPageBtnBottom.disabled = currentMonthlyPage >= totalMonthlyPages;
      }

      // Update pagination info
      const startRecord = (currentMonthlyPage - 1) * monthlyPerPage + 1;
      const endRecord = Math.min(currentMonthlyPage * monthlyPerPage, totalMonthlyRecords);

      if (totalMonthlyRecords > 0) {
        if (paginationInfoBottom) {
          paginationInfoBottom.textContent = `Showing ${startRecord}-${endRecord} of ${totalMonthlyRecords} users`;
        }
      } else {
        if (paginationInfoBottom) {
          paginationInfoBottom.textContent = 'No users found';
        }
      }
    }

    function goToMonthlyPage(page) {
      if (page < 1 || page > totalMonthlyPages) return;
      currentMonthlyPage = page;
      displayMonthlyRecords();
      updateMonthlyPaginationControls();
    }

    function goToPreviousMonthlyPage() {
      if (currentMonthlyPage > 1) {
        currentMonthlyPage--;
        displayMonthlyRecords();
        updateMonthlyPaginationControls();
      }
    }

    function goToNextMonthlyPage() {
      if (currentMonthlyPage < totalMonthlyPages) {
        currentMonthlyPage++;
        displayMonthlyRecords();
        updateMonthlyPaginationControls();
      }
    }

    function goToLastMonthlyPage() {
      if (currentMonthlyPage < totalMonthlyPages) {
        currentMonthlyPage = totalMonthlyPages;
        displayMonthlyRecords();
        updateMonthlyPaginationControls();
      }
    }

    function displayMonthlyRecords() {
      const startIndex = (currentMonthlyPage - 1) * monthlyPerPage;
      const endIndex = startIndex + monthlyPerPage;
      const recordsToShow = allMonthlyRecords.slice(startIndex, endIndex);

      let tbl = '';

      if (recordsToShow.length === 0) {
        tbl = '<p style="text-align:center;padding:20px;">No records found.</p>';
        document.getElementById('monthlySummaryTable').innerHTML = tbl;
        return;
      }

      // Find top attendant from ALL records (not just current page)
      let topAttendant = allMonthlyRecords.length > 0 ? allMonthlyRecords[0] : null;

      if (isAdmin && topAttendant) {
        tbl = `
      <div style="margin-bottom:12px; padding:10px; background:#f0f9ff; border-radius:6px; border:1px solid #bae6fd;">
        <strong style="color:#0369a1; font-size:14px;">Top Attendance: </strong>
        <span style="color:#0c4a6e;">${topAttendant.name} (${topAttendant.perc}%)</span>
      </div>`;
      }

      tbl += '<table class="data-table"><tr><th>Name</th><th>Work Days</th><th>Present</th><th>Late</th><th>Absent</th><th>Attendance %</th></tr>';

      recordsToShow.forEach(r => {
        // BUAT NAMA CLICKABLE
        tbl += `<tr>
      <td style="text-align:left;padding-left:8px">
        <a href="javascript:void(0)" onclick="showUserMonthlyDetail('${r.name}')" 
           style="color:#3b82f6; text-decoration:none; font-weight:500; cursor:pointer;">
          ${r.name}
        </a>
      </td>
      <td>${r.total}</td>
      <td>${r.present}</td>
      <td>${r.late}</td>
      <td>${r.absent}</td>
      <td style="font-weight:600;">${r.perc}%</td>
    </tr>`;
      });

      tbl += '</table>';
      document.getElementById('monthlySummaryTable').innerHTML = tbl;
    }
    // ========== USER MONTHLY DETAIL FUNCTIONS ==========

    let currentViewingUser = null;
    let currentViewingMonth = null;
    let currentViewingYear = null;

    // Function to show user monthly detail
    async function showUserMonthlyDetail(userName) {
      showSpinner();
      try {
        currentViewingUser = userName;
        currentViewingMonth = parseInt(document.getElementById('monthSelect').value, 10);
        currentViewingYear = parseInt(document.getElementById('yearSelect').value, 10);

        // Update UI
        document.getElementById('userMonthlyTitle').textContent = `${userName} - ${new Date(currentViewingYear, currentViewingMonth - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}`;
        document.getElementById('userMonthlyPeriod').textContent = `Attendance details for selected period`;

        // Show loading state
        document.getElementById('calendarLoading').style.display = 'block';
        document.getElementById('calendarEmpty').style.display = 'none';
        document.getElementById('userCalendarGrid').innerHTML = '';
        document.getElementById('detailsPanel').classList.remove('active');

        // Load user monthly data
        await loadUserMonthlyData(userName, currentViewingMonth, currentViewingYear);

        // Show the section
        showSection('user-monthly-detail');

      } catch (err) {
        console.error('Error showing user monthly detail:', err);
        showSnackbar('❌ Failed to load user details: ' + err.message);
      } finally {
        hideSpinner();
        document.getElementById('calendarLoading').style.display = 'none';
      }
    }

    // Function to load user monthly data
    async function loadUserMonthlyData(userName, month, year) {
      const daysInMonth = new Date(year, month, 0).getDate();
      const dates = [];
      for (let d = 1; d <= daysInMonth; d++) {
        dates.push(`${year}-${pad(month)}-${pad(d)}`);
      }

      // Load workdays and attendance data
      const workdaysMap = await loadWorkdaysRange(dates[0], dates[dates.length - 1]);
      const attendanceSnaps = await Promise.all(
        dates.map(dt => db.ref('attendance/' + dt).once('value'))
      );

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Process data for this user
      const userData = [];
      let totalWorkdays = 0;
      let presentCount = 0;
      let lateCount = 0;
      let absentCount = 0;

      dates.forEach((date, index) => {
        const dateObj = new Date(date);
        const isFuture = dateObj > today;
        const isWorkday = date in workdaysMap ? !!workdaysMap[date] : isDefaultWorkdayISO(date);

        let status = 'future';
        let checkin = '-';
        let checkout = '-';
        let workedHours = '-';
        let punctuality = '-';

        if (!isFuture) {
          if (!isWorkday) {
            status = 'holiday';
          } else {
            // Find user's attendance record for this date
            const attendanceData = attendanceSnaps[index].exists() ? attendanceSnaps[index].val() : {};
            const userRecord = findAttendanceRecord(attendanceData, userName);

            if (userRecord && userRecord.checkin) {
              // User has attendance record
              checkin = userRecord.checkin || '-';
              checkout = userRecord.checkout || '-';
              workedHours = calculateWorkedHours(userRecord);
              punctuality = userRecord.punctuality || '-';

              // Determine status
              if (userRecord.punctuality && userRecord.punctuality.toLowerCase().includes('late')) {
                status = 'late';
                lateCount++;
              } else if (userRecord.status && userRecord.status.toLowerCase().includes('late')) {
                status = 'late';
                lateCount++;
              } else {
                status = 'present';
                presentCount++;
              }
            } else {
              // No attendance record on workday
              status = 'absent';
              absentCount++;
            }

            totalWorkdays++;
          }
        }

        userData.push({
          date,
          dateObj,
          status,
          checkin,
          checkout,
          workedHours,
          punctuality,
          isWorkday,
          isFuture
        });
      });

      // Update statistics
      updateUserMonthlyStats(totalWorkdays, presentCount, lateCount, absentCount);

      // Render calendar
      renderUserCalendar(userData, month, year);
    }

    // Function to update user monthly statistics
    function updateUserMonthlyStats(totalWorkdays, present, late, absent) {
      const totalPresent = present + late;
      const attendancePercentage = totalWorkdays > 0 ? ((totalPresent / totalWorkdays) * 100).toFixed(1) : '0.0';

      const statsHtml = `
    <div class="stat-card">
      <div class="stat-number stat-present">${present}</div>
      <div class="stat-label">Present</div>
    </div>
    <div class="stat-card">
      <div class="stat-number stat-late">${late}</div>
      <div class="stat-label">Late</div>
    </div>
    <div class="stat-card">
      <div class="stat-number stat-absent">${absent}</div>
      <div class="stat-label">Absent</div>
    </div>
    <div class="stat-card">
      <div class="stat-number stat-percentage">${attendancePercentage}%</div>
      <div class="stat-label">Attendance</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${totalWorkdays}</div>
      <div class="stat-label">Work Days</div>
    </div>
  `;

      document.getElementById('userMonthlyStats').innerHTML = statsHtml;
    }

    // Function to render user calendar
    function renderUserCalendar(userData, month, year) {
      const firstDay = new Date(year, month - 1, 1);
      const startDow = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
      const daysInMonth = userData.length;

      const grid = document.getElementById('userCalendarGrid');
      grid.innerHTML = '';

      // Add empty cells for days before the first day of month
      for (let i = 0; i < startDow; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'user-cal-cell';
        emptyCell.style.background = '#f8fafc';
        emptyCell.style.cursor = 'default';
        grid.appendChild(emptyCell);
      }

      // Add cells for each day of the month
      userData.forEach(dayData => {
        const cell = document.createElement('div');
        const dayNumber = dayData.dateObj.getDate();

        cell.className = `user-cal-cell ${dayData.status}`;
        cell.setAttribute('data-date', dayData.date);
        cell.setAttribute('data-status', dayData.status);

        // Date number
        const dateDiv = document.createElement('div');
        dateDiv.className = 'date';
        dateDiv.textContent = dayNumber;

        // Status indicator
        const statusDiv = document.createElement('div');
        statusDiv.className = 'status';

        let statusText = '';
        switch (dayData.status) {
          case 'present': statusText = '✓ Present'; break;
          case 'late': statusText = '⚠ Late'; break;
          case 'absent': statusText = '✗ Absent'; break;
          case 'holiday': statusText = '- Holiday'; break;
          case 'future': statusText = '- Future'; break;
          default: statusText = '-';
        }
        statusDiv.textContent = statusText;

        // Time info (if available)
        const timeDiv = document.createElement('div');
        timeDiv.className = 'time';

        if ((dayData.status === 'present' || dayData.status === 'late') && dayData.checkin !== '-') {
          timeDiv.textContent = `${dayData.checkin}${dayData.checkout !== '-' ? `-${dayData.checkout}` : ''}`;
        } else {
          timeDiv.textContent = '';
        }

        cell.appendChild(dateDiv);
        cell.appendChild(statusDiv);
        cell.appendChild(timeDiv);

        // Add click handler
        cell.addEventListener('click', () => {
          showDateDetails(dayData);
        });

        grid.appendChild(cell);
      });

      // Add empty cells for days after the last day of month
      const totalCells = startDow + daysInMonth;
      const remaining = (7 - (totalCells % 7)) % 7;
      for (let i = 0; i < remaining; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'user-cal-cell';
        emptyCell.style.background = '#f8fafc';
        emptyCell.style.cursor = 'default';
        grid.appendChild(emptyCell);
      }

      // Hide empty state if we have data
      if (userData.length > 0) {
        document.getElementById('calendarEmpty').style.display = 'none';
      }
    }

    // Function to show date details
    function showDateDetails(dayData) {
      const panel = document.getElementById('detailsPanel');
      const title = document.getElementById('detailDateTitle');
      const content = document.getElementById('detailContent');

      // Format date
      const dateFormatted = dayData.dateObj.toLocaleDateString('en-MY', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      title.textContent = dateFormatted;

      let statusClass = '';
      let statusText = '';

      switch (dayData.status) {
        case 'present':
          statusClass = 'present';
          statusText = 'Present ✓';
          break;
        case 'late':
          statusClass = 'late';
          statusText = 'Late ⚠';
          break;
        case 'absent':
          statusClass = 'absent';
          statusText = 'Absent ✗';
          break;
        case 'holiday':
          statusClass = 'holiday';
          statusText = 'Holiday';
          break;
        case 'future':
          statusClass = 'holiday';
          statusText = 'Future Date';
          break;
        default:
          statusClass = 'holiday';
          statusText = 'No Data';
      }

      let detailsHtml = `
    <div class="detail-item">
      <span class="detail-label">Status:</span>
      <span class="detail-value ${statusClass}">${statusText}</span>
    </div>
  `;

      if (dayData.status === 'present' || dayData.status === 'late') {
        detailsHtml += `
      <div class="detail-item">
        <span class="detail-label">Check-in:</span>
        <span class="detail-value">${dayData.checkin}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Check-out:</span>
        <span class="detail-value">${dayData.checkout}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Worked Hours:</span>
        <span class="detail-value">${dayData.workedHours}</span>
      </div>
    `;

        if (dayData.punctuality && dayData.punctuality !== '-') {
          detailsHtml += `
        <div class="detail-item">
          <span class="detail-label">Punctuality:</span>
          <span class="detail-value">${dayData.punctuality}</span>
        </div>
      `;
        }
      }

      content.innerHTML = detailsHtml;
      panel.classList.add('active');

      // Scroll to details panel
      panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Function to close details panel
    function closeDetailsPanel() {
      document.getElementById('detailsPanel').classList.remove('active');
    }

    // Update showSection function to handle user-monthly-detail
    // (Add this to your existing showSection function)
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
      const nav = document.getElementById('nav-' + id);
      if (nav) nav.classList.add('active');

      // Close mobile menu when selecting a section
      const sidebar = document.getElementById('sidebar');
      const mobileOverlay = document.getElementById('mobileOverlay');
      if (sidebar && mobileOverlay) {
        sidebar.classList.remove('mobile-open');
        mobileOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      if (id === 'attendance') loadAttendanceByDate();
      if (id === 'daily') calculateDailyStatus();
      if (id === 'weekly') {
        const wk = document.getElementById('weekPicker');
        if (!wk.value) wk.value = new Date().toISOString().split('T')[0];
        calculateWeeklySummary();
      }
      if (id === 'monthly') calculateMonthlySummary();
      if (id === 'workday') {
        const now = new Date();
        if (typeof currentCalendarYear === 'undefined' || typeof currentCalendarMonth === 'undefined') {
          currentCalendarYear = now.getFullYear();
          currentCalendarMonth = now.getMonth();
        }
        initWorkdayYearSelector();
        renderCalendar(currentCalendarYear, currentCalendarMonth);
      }
      if (id === 'register') loadRegisteredVehicles();
      if (id === 'settings') loadUserSettings();
      if (id === 'user-management') loadUsers();

      // TAMBAH INI: Handle user-monthly-detail section
      if (id === 'user-monthly-detail') {
        // Details panel sudah dihandle oleh functions lain
      }
    }

    async function calculateMonthlySummary() {
      showSpinner();
      try {
        const month = parseInt(document.getElementById('monthSelect').value, 10);
        const year = parseInt(document.getElementById('yearSelect').value, 10);
        const filterJabatan = document.getElementById('monthJabatanFilter') ? document.getElementById('monthJabatanFilter').value : '';
        const daysInMonth = new Date(year, month, 0).getDate();
        const dates = [];
        for (let d = 1; d <= daysInMonth; d++) dates.push(`${year}-${pad(month)}-${pad(d)}`);

        const workdaysMap = await loadWorkdaysRange(dates[0], dates[dates.length - 1]);
        const snaps = await Promise.all(dates.map(dt => db.ref('attendance/' + dt).once('value')));
        const platesSnap = await db.ref('plates').once('value');
        const plates = platesSnap.val() || {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const stats = {};
        const perDayTotals = dates.map(() => ({ present: 0, late: 0, absent: 0 }));

        const attendanceByDate = {};
        snaps.forEach((snap, idx) => {
          const dt = dates[idx];
          attendanceByDate[dt] = {};
          if (snap.exists()) {
            snap.forEach(r => {
              const v = r.val();
              const name = v.name || 'Unknown';
              attendanceByDate[dt][name] = v;
            });
          }
        });

        const namesToProcess = isAdmin ?
          [...new Set(Object.values(plates)
            .filter(p => !filterJabatan || p.jabatan === filterJabatan)
            .map(p => p.name)
            .filter(name => name))] :
          [...new Set(Object.values(plates)
            .filter(p => matchByNameVariations(p.name, userName))
            .map(p => p.name)
            .filter(name => name))];

        if (!isAdmin && namesToProcess.length === 0) {
          namesToProcess.push(userName);
        }

        namesToProcess.forEach(name => {
          stats[name] = { totalWorkdays: 0, present: 0, late: 0, absent: 0, byDate: {} };
          dates.forEach((dt, idx) => {
            const dtObj = new Date(dt);
            dtObj.setHours(0, 0, 0, 0);

            // Future dates
            if (dtObj > today) {
              stats[name].byDate[dt] = 'Future';
              return;
            }

            // Check workday status
            const isWork = (dt in workdaysMap) ? !!workdaysMap[dt] : isDefaultWorkdayISO(dt);
            if (!isWork) {
              stats[name].byDate[dt] = 'Holiday';
              return;
            }

            stats[name].totalWorkdays++;
            const recA = attendanceByDate[dt] && attendanceByDate[dt][name];
            let status = 'Absent';

            if (recA) {
              if (recA.punctuality && recA.punctuality.toLowerCase().includes('late')) {
                status = 'Late';
              } else if (recA.status && recA.status.toLowerCase().includes('late')) {
                status = 'Late';
              } else if (recA.checkin) {
                const cMin = parseTimeToMinutes(recA.checkin);
                let shiftStart = '08:00';
                if (recA.shift && recA.shift.toUpperCase().includes('10')) shiftStart = '10:00';
                const sMin = parseTimeToMinutes(shiftStart);
                if (cMin !== null && sMin !== null && cMin > sMin) {
                  status = 'Late';
                } else {
                  status = 'Present';
                }
              } else {
                status = 'Present';
              }
            }

            stats[name].byDate[dt] = status;

            // Update counters
            if (status === 'Absent') stats[name].absent++;
            else if (status === 'Late') stats[name].late++;
            else if (status === 'Present') stats[name].present++;

            // Update perDayTotals untuk chart
            if (status === 'Absent') perDayTotals[idx].absent++;
            else if (status === 'Late') perDayTotals[idx].late++;
            else if (status === 'Present') perDayTotals[idx].present++;
          });
        });

        // Chart code (same as before)
        // Chart code - FIXED VERSION
        if (isAdmin) {
          const labels = dates.map(d => d.split('-')[2]);
          const dataPresents = perDayTotals.map(x => x.present);
          const dataLates = perDayTotals.map(x => x.late);
          const dataAbsents = perDayTotals.map(x => x.absent);
          const ctx = document.getElementById('monthlyChart').getContext('2d');
          if (monthlyChart) monthlyChart.destroy();

          // DETECT MOBILE
          const isMobile = window.innerWidth <= 900;

          monthlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'Present', data: dataPresents, backgroundColor: '#10b981' },
                { label: 'Late', data: dataLates, backgroundColor: '#f59e0b' },
                { label: 'Absent', data: dataAbsents, backgroundColor: '#ef4444' }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  stacked: true,
                  ticks: {
                    font: {
                      size: isMobile ? 10 : 12
                    },
                    // MOBILE FIX: These are the key settings
                    autoSkip: false, // CRITICAL: Prevents skipping
                    maxTicksLimit: isMobile ? 31 : 12, // Show ALL days on mobile
                    minRotation: isMobile ? 90 : 0, // Vertical on mobile
                    maxRotation: isMobile ? 90 : 45,
                    callback: function (value, index, values) {
                      // Always show the day number
                      return String(index + 1).padStart(2, '0');
                    }
                  },
                  // Extra mobile configuration
                  afterFit: function (scale) {
                    if (isMobile) {
                      scale.height = 80; // More height for vertical labels
                    }
                  }
                },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  ticks: {
                    font: { size: isMobile ? 10 : 12 },
                    stepSize: 1,
                    callback: function (value) {
                      return Number.isInteger(value) ? value : '';
                    }
                  }
                }
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    font: {
                      size: isMobile ? 11 : 13
                    }
                  }
                }
              },
              // MOBILE: Add extra padding for vertical labels
              layout: {
                padding: isMobile ? {
                  left: 10,
                  right: 10,
                  top: 10,
                  bottom: 60
                } : {
                  left: 10,
                  right: 10,
                  top: 10,
                  bottom: 10
                }
              }
            }
          });

          console.log('📊 Chart created - Mobile:', isMobile, 'Labels:', labels.length);
        }

        // Prepare records for pagination
        const rows = [];
        for (const [name, st] of Object.entries(stats)) {
          const perc = st.totalWorkdays ? (((st.present + st.late) / st.totalWorkdays) * 100).toFixed(1) : '0.0';
          rows.push({
            name,
            total: st.totalWorkdays,
            present: st.present,
            late: st.late,
            absent: st.absent,
            perc
          });
        }

        // Sort by attendance percentage (highest first)
        rows.sort((a, b) => parseFloat(b.perc) - parseFloat(a.perc));

        // Store all records for pagination
        allMonthlyRecords = rows;

        // Update pagination variables
        totalMonthlyRecords = rows.length;
        totalMonthlyPages = Math.ceil(totalMonthlyRecords / monthlyPerPage);
        currentMonthlyPage = 1;

        // Display first page of records
        displayMonthlyRecords();
        updateMonthlyPaginationControls();

      } catch (err) {
        console.error(err);
        showSnackbar('❌ Error while building monthly report');
      } finally {
        hideSpinner();
      }
    }

    // Filter function untuk monthly table
    function filterMonthlyTable() {
      const searchTerm = document.getElementById('searchMonthly').value.toLowerCase();

      if (!searchTerm) {
        // Jika search kosong, tunjuk semua records asal
        displayMonthlyRecords();
        updateMonthlyPaginationControls();
        return;
      }

      // Filter records berdasarkan search term
      const filteredRecords = allMonthlyRecords.filter(record =>
        record.name.toLowerCase().includes(searchTerm)
      );

      // Update pagination untuk filtered records
      totalMonthlyRecords = filteredRecords.length;
      totalMonthlyPages = Math.ceil(totalMonthlyRecords / monthlyPerPage);
      currentMonthlyPage = 1;

      // Display filtered records
      const startIndex = (currentMonthlyPage - 1) * monthlyPerPage;
      const endIndex = startIndex + monthlyPerPage;
      const recordsToShow = filteredRecords.slice(startIndex, endIndex);

      let tbl = '';

      if (recordsToShow.length === 0) {
        tbl = '<p style="text-align:center;padding:20px;">No matching records found.</p>';
        document.getElementById('monthlySummaryTable').innerHTML = tbl;
        return;
      }

      tbl += '<table class="data-table"><tr><th>Name</th><th>Work Days</th><th>Present</th><th>Late</th><th>Absent</th><th>Attendance %</th></tr>';

      recordsToShow.forEach(r => {
        tbl += `<tr>
      <td style="text-align:left;padding-left:8px">${r.name}</td>
      <td>${r.total}</td>
      <td>${r.present}</td>
      <td>${r.late}</td>
      <td>${r.absent}</td>
      <td style="font-weight:600;">${r.perc}%</td>
    </tr>`;
      });

      tbl += '</table>';
      document.getElementById('monthlySummaryTable').innerHTML = tbl;
      updateMonthlyPaginationControls();
    }

    // ========== Workday Manager ==========
    function trackModification(iso, currentState, originalState) {
      modifiedDates.set(iso, {
        current: currentState,
        original: originalState,
        isModified: currentState !== originalState
      });
      updateWorkdayStatus();
    }

    // Function to clear all modifications for current month
    function clearAllModifications() {
      modifiedDates.clear();
      updateWorkdayStatus();

      // Re-render calendar to show original state
      renderCalendar(currentCalendarYear, currentCalendarMonth);
      showSnackbar('All modifications cleared');
    }

    // Function to update workday status display
    function updateWorkdayStatus() {
      const statusElement = document.getElementById('workdayStatus');
      const modifiedCount = Array.from(modifiedDates.values()).filter(m => m.isModified).length;

      if (modifiedCount > 0) {
        statusElement.style.display = 'block';
        statusElement.style.background = '#fef3c7';
        statusElement.style.border = '1px solid #f59e0b';
        statusElement.style.color = '#92400e';
        statusElement.innerHTML = `⚠️ You have ${modifiedCount} unsaved modification(s). Click "Save All" to save changes.`;
      } else {
        statusElement.style.display = 'none';
      }
    }

    // Initialize year selector for workday manager
    function initWorkdayYearSelector() {
      const yearSelect = document.getElementById('yearSelectWorkday');
      const monthSelect = document.getElementById('monthSelectWorkday');

      if (!yearSelect || !monthSelect) return;

      // Clear existing options
      yearSelect.innerHTML = '';

      // Add year options (current year -2 to current year +2)
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 2; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }

      // Set current year and month
      yearSelect.value = currentCalendarYear || currentYear;
      monthSelect.value = currentCalendarMonth || new Date().getMonth();
    }

    // Handle year/month change
    function onYearMonthChange() {
      const yearSelect = document.getElementById('yearSelectWorkday');
      const monthSelect = document.getElementById('monthSelectWorkday');

      if (!yearSelect || !monthSelect) return;

      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);

      // Update global variables
      currentCalendarYear = year;
      currentCalendarMonth = month;

      // Render calendar with new selection
      renderCalendar(year, month);
    }

    async function renderCalendar(year, month0) {
      // FIX: Prevent multiple simultaneous renders
      if (isRenderingCalendar) {
        console.log('⏳ renderCalendar already in progress, skipping...');
        return;
      }

      isRenderingCalendar = true;
      console.log('🎯 renderCalendar START with:', year, month0, '(month0 means:', month0 + 1, '= actual month)');

      try {
        // FIX: Ensure global variables are synced with parameters
        currentCalendarYear = year;
        currentCalendarMonth = month0;

        // Update selectors if they exist
        const yearSelect = document.getElementById('yearSelectWorkday');
        const monthSelect = document.getElementById('monthSelectWorkday');
        if (yearSelect && monthSelect) {
          yearSelect.value = year;
          monthSelect.value = month0;
        }

        const first = new Date(year, month0, 1);
        const startDow = first.getDay();
        const daysInMonth = new Date(year, month0 + 1, 0).getDate();

        // FIX: Use the CORRECT month calculation
        const actualMonth = month0 + 1; // month0 is 0-indexed, actual month is 1-indexed
        const startISO = `${year}-${pad(actualMonth)}-01`;
        const endISO = `${year}-${pad(actualMonth)}-${pad(daysInMonth)}`;

        console.log('📅 renderCalendar CALCULATION:', {
          calledWith: { year, month0 },
          actualMonth: actualMonth,
          daysInMonth: daysInMonth,
          range: `${startISO} to ${endISO}`,
        });

        const workdaysMap = await loadWorkdaysRange(startISO, endISO);

        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        // Create empty cells for days before the first day of month
        for (let i = 0; i < startDow; i++) {
          const cell = document.createElement('div');
          cell.className = 'cal-cell';
          cell.style.background = '#f8fafc';
          cell.style.cursor = 'default';
          grid.appendChild(cell);
        }

        // Create cells for each day of the month
        for (let d = 1; d <= daysInMonth; d++) {
          const dt = new Date(year, month0, d);
          const iso = ymdFromDate(dt);

          // Determine original state
          const explicit = (iso in workdaysMap);
          const originalIsWork = explicit ? !!workdaysMap[iso] : isDefaultWorkdayObj(dt);

          // Check if this date has been modified temporarily
          const modification = modifiedDates.get(iso);
          const currentIsWork = modification ? modification.current : originalIsWork;
          const isModified = modification ? modification.isModified : false;

          const cell = document.createElement('div');
          cell.className = 'cal-cell ' + (currentIsWork ? 'work' : 'holiday') +
            (iso === new Date().toISOString().split('T')[0] ? ' today' : '') +
            (isModified ? ' modified' : '');

          cell.setAttribute('data-iso', iso);
          cell.setAttribute('data-original', originalIsWork.toString());

          // Create date and status label
          const dateDiv = document.createElement('div');
          dateDiv.className = 'date';
          dateDiv.textContent = d;

          const statusDiv = document.createElement('div');
          statusDiv.className = 'status-label';
          statusDiv.textContent = currentIsWork ? 'Work' : 'Holiday';

          cell.appendChild(dateDiv);
          cell.appendChild(statusDiv);

          // Click handler
          cell.addEventListener('click', async (ev) => {
            if (ev.ctrlKey || ev.metaKey) {
              return;
            }

            const iso = cell.getAttribute('data-iso');
            const originalIsWork = cell.getAttribute('data-original') === 'true';

            const existingModification = modifiedDates.get(iso);
            const currentIsWork = existingModification ? existingModification.current : originalIsWork;

            const newIsWork = !currentIsWork;

            // Update cell appearance
            cell.classList.remove('work', 'holiday');
            cell.classList.add(newIsWork ? 'work' : 'holiday');

            // Update status label
            cell.querySelector('.status-label').textContent = newIsWork ? 'Work' : 'Holiday';

            cell.classList.add('modified');

            trackModification(iso, newIsWork, originalIsWork);

            showSnackbar(`Changed ${iso} to ${newIsWork ? 'Work Day' : 'Holiday'} - Remember to Save!`);
          });

          grid.appendChild(cell);
        }

        // Create empty cells for days after the last day of month
        const totalCells = startDow + daysInMonth;
        const remaining = (7 - (totalCells % 7)) % 7;
        for (let i = 0; i < remaining; i++) {
          const cell = document.createElement('div');
          cell.className = 'cal-cell';
          cell.style.background = '#f8fafc';
          cell.style.cursor = 'default';
          grid.appendChild(cell);
        }

        // Update status display
        updateWorkdayStatus();

        console.log('✅ renderCalendar COMPLETED for:', year, month0);

      } catch (error) {
        console.error('❌ renderCalendar ERROR:', error);
        showSnackbar('❌ Error loading calendar: ' + error.message);
      } finally {
        // FIX: Always reset the flag, even if there's an error
        isRenderingCalendar = false;
      }
    }
    async function deleteUser() {
      if (!isAdmin || !currentEditingUser) return;

      const userName = currentEditingUser.name || 'Unknown User';
      const userEmail = currentEditingUser.email;

      // Prevent admin from deleting themselves
      if (userEmail === ADMIN_EMAIL) {
        showSnackbar('❌ Cannot delete administrator account');
        return;
      }

      // Comprehensive confirmation
      const confirmationMessage = `
⚠️ PERMANENT USER DELETION

User: ${userName}
Email: ${userEmail}

This will delete:
• User account
• All registered vehicles
• All RFID cards
• All attendance records

🚨 THIS ACTION CANNOT BE UNDONE!

Type "DELETE ${userName}" to confirm:`;

      const userInput = prompt(confirmationMessage);

      if (userInput !== `DELETE ${userName}`) {
        showSnackbar('❌ Deletion cancelled - confirmation text did not match');
        return;
      }

      showSpinner();
      try {
        const userId = currentEditingUser.id;
        let deletedItems = {
          user: false,
          rfidCards: 0,
          plates: 0,
          attendanceRecords: 0
        };

        // 1. Delete user main record
        await db.ref('users/' + userId).remove();
        deletedItems.user = true;

        // 2. Delete RFID cards
        const rfidSnapshot = await db.ref('rfid_cards').once('value');
        const updates = {};

        if (rfidSnapshot.exists()) {
          rfidSnapshot.forEach(cardSnap => {
            const cardData = cardSnap.val();
            if (cardData.user_id === userId) {
              updates[`rfid_cards/${cardSnap.key}`] = null;
              updates[`rfid_to_user/${cardSnap.key}`] = null;
              deletedItems.rfidCards++;
            }
          });
        }

        // 3. Delete plates
        const platesSnapshot = await db.ref('plates').once('value');
        if (platesSnapshot.exists()) {
          platesSnapshot.forEach(plateSnap => {
            const plateData = plateSnap.val();
            if (plateData.registeredBy === userEmail) {
              updates[`plates/${plateSnap.key}`] = null;
              deletedItems.plates++;
            }
          });
        }

        // 4. Delete attendance records (30 hari terakhir sahaja untuk performance)
        const last30Days = [];
        const today = new Date();
        for (let i = 0; i < 30; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() - i);
          last30Days.push(ymdFromDate(date));
        }

        const attendancePromises = last30Days.map(date =>
          db.ref(`attendance/${date}/${userId}`).once('value')
        );

        const attendanceResults = await Promise.all(attendancePromises);

        attendanceResults.forEach((snap, index) => {
          if (snap.exists()) {
            updates[`attendance/${last30Days[index]}/${userId}`] = null;
            deletedItems.attendanceRecords++;
          }
        });

        // 5. Execute all updates
        if (Object.keys(updates).length > 0) {
          await db.ref().update(updates);
        }

        // 6. Show success message with details
        const successMessage = `✅ User deleted successfully\n\nRemoved:\n• User account: 1\n• RFID cards: ${deletedItems.rfidCards}\n• Vehicle plates: ${deletedItems.plates}\n• Attendance records: ${deletedItems.attendanceRecords}`;

        showSnackbar(successMessage);

        // 7. Return to user management
        setTimeout(() => {
          showSection('user-management');
          loadUsers();
        }, 2000);

      } catch (err) {
        console.error('Error deleting user:', err);

        let errorMessage = '❌ Failed to delete user: ' + err.message;

        if (err.code === 'PERMISSION_DENIED') {
          errorMessage = '❌ Permission denied - check Firebase rules';
        } else if (err.code === 'NETWORK_ERROR') {
          errorMessage = '❌ Network error - please check connection';
        }

        showSnackbar(errorMessage);
      } finally {
        hideSpinner();
      }
    }

    // Updated showSection function to initialize workday manager
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
      const nav = document.getElementById('nav-' + id);
      if (nav) nav.classList.add('active');

      // Close mobile menu when selecting a section
      const sidebar = document.getElementById('sidebar');
      const mobileOverlay = document.getElementById('mobileOverlay');
      if (sidebar && mobileOverlay) {
        sidebar.classList.remove('mobile-open');
        mobileOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      if (id === 'attendance') loadAttendanceByDate();
      if (id === 'daily') calculateDailyStatus();
      if (id === 'weekly') {
        const wk = document.getElementById('weekPicker');
        if (!wk.value) wk.value = new Date().toISOString().split('T')[0];
        calculateWeeklySummary();
      }
      if (id === 'monthly') calculateMonthlySummary();
      if (id === 'workday') {
        const now = new Date();

        // FIX: Initialize calendar variables if undefined
        if (typeof currentCalendarYear === 'undefined' || typeof currentCalendarMonth === 'undefined') {
          currentCalendarYear = now.getFullYear();
          currentCalendarMonth = now.getMonth();
          console.log('📅 Initializing calendar variables:', currentCalendarYear, currentCalendarMonth);
        }

        // Initialize year selector
        initWorkdayYearSelector();

        console.log('📅 Workday - Rendering:', currentCalendarYear, currentCalendarMonth);
        renderCalendar(currentCalendarYear, currentCalendarMonth);
      }
      if (id === 'register') loadRegisteredVehicles();
      if (id === 'settings') loadUserSettings();
      if (id === 'user-management') loadUsers();
    }

    // UPDATED: clearSelection function (sekarang clear semua modification)
    function clearSelection() {
      if (modifiedDates.size === 0) {
        showSnackbar('No modifications to clear.');
        return;
      }

      if (confirm('Are you sure you want to clear all unsaved changes for this month?')) {
        clearAllModifications();
      }
    }

    // UPDATED: saveVisibleWorkdays function
    async function saveVisibleWorkdays() {
      if (modifiedDates.size === 0) {
        showSnackbar('No changes to save.');
        return;
      }

      showSpinner();
      try {
        const updates = {};
        let saveCount = 0;

        // Process all modifications
        modifiedDates.forEach((modification, iso) => {
          if (modification.isModified) {
            const newVal = modification.current;
            const defaultVal = isDefaultWorkdayISO(iso);

            if (newVal === defaultVal) {
              updates[iso] = null; // Remove override jika sama dengan default
            } else {
              updates[iso] = newVal; // Set new value
            }
            saveCount++;
          }
        });

        if (Object.keys(updates).length === 0) {
          showSnackbar('No valid changes to save.');
          return;
        }

        // Save to Firebase
        await persistWorkdaysMap(updates);

        // Clear modifications after successful save
        clearAllModifications();

        showSnackbar(`✅ Successfully saved ${saveCount} day(s)`);

        // Refresh calendar to show saved state
        renderCalendar(currentCalendarYear, currentCalendarMonth);

      } catch (err) {
        console.error('Error saving workdays:', err);
        showSnackbar('❌ Failed to save changes: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    // ========== Utils: init pickers, months, years ==========
    function initPickers() {
      const monthSel = document.getElementById('monthSelect');
      const yearSel = document.getElementById('yearSelect');
      monthSel.innerHTML = '';
      for (let m = 1; m <= 12; m++) {
        const o = document.createElement('option');
        o.value = m;
        o.text = new Date(2000, m - 1, 1).toLocaleString(undefined, { month: 'short' });
        monthSel.appendChild(o);
      }
      const now = new Date();
      monthSel.value = now.getMonth() + 1;
      yearSel.innerHTML = '';
      const startYear = now.getFullYear() - 3;
      for (let y = startYear; y <= now.getFullYear() + 1; y++) {
        const o = document.createElement('option');
        o.value = y;
        o.text = y;
        yearSel.appendChild(o);
      }
      yearSel.value = now.getFullYear();
      const wp = document.getElementById('weekPicker');
      if (wp) wp.value = now.toISOString().split('T')[0];
      const dp = document.getElementById('datePicker');
      if (dp) dp.value = now.toISOString().split('T')[0];

      // TAMBAH: Set daily date picker kepada hari ini
      const dailyDatePicker = document.getElementById('dailyDatePicker');
      if (dailyDatePicker) {
        dailyDatePicker.value = new Date().toISOString().split('T')[0];
      }

      document.getElementById('monthSelect').addEventListener('change', calculateMonthlySummary);
      document.getElementById('yearSelect').addEventListener('change', calculateMonthlySummary);
    }

    // ========== Auto load on DOM ready ==========
    document.addEventListener('DOMContentLoaded', () => {
      initPickers();
      setupMobileMenu();
      // Initialize with current user role
      const user = firebase.auth().currentUser;
      if (user && user.email === ADMIN_EMAIL) {
        document.body.classList.add('admin-user');
      }

      loadAttendanceByDate();
    });
    function debugSettingsStructure() {
      const settings = document.getElementById('settings');
      console.log('🏗️ SETTINGS STRUCTURE:');

      // Check the actual HTML
      console.log('HTML:', settings.outerHTML);

      // Check all parent containers up to body
      let parent = settings;
      let path = [];
      while (parent && parent !== document.body) {
        const style = window.getComputedStyle(parent);
        path.push({
          element: parent.tagName + (parent.id ? '#' + parent.id : '') + (parent.className ? '.' + parent.className.replace(/ /g, '.') : ''),
          display: style.display,
          width: style.width,
          height: style.height,
          position: style.position
        });
        parent = parent.parentElement;
      }
      console.log('📋 PARENT PATH:', path);
    }

    debugSettingsStructure();
    // Initialize with current date
    document.getElementById('weekPicker').valueAsDate = new Date();


  </script>
</body>

</html>